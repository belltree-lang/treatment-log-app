# Issue 792 未回収・合算請求・領収表示ロジックの現状整理

本ドキュメントは「10月未回収 → 11月合算請求 → 12月通常請求＋10-11月領収」シナリオを想定し、未回収フラグ、合算請求設定、領収表示の現在の挙動をコードベースから調査した結果をまとめたものです。実行確認は行っていません。

## 未回収状態の取り扱い
- 請求データに対して設定できる領収状態は `UNPAID` / `AGGREGATE` / `HOLD` の3種類で、`updateBillingReceiptStatus` から `mergeReceiptSettingsIntoPrepared_` を経由し、`prepared` と `billingJson` にそのまま書き込まれます。合算期限 (`aggregateUntilMonth`) もこの時点で単に値がコピーされるだけです。【F:src/main.gs†L433-L457】【F:src/main.gs†L2358-L2374】
- 銀行引落シートの「未回収」チェック列を走査して患者IDの集合を作り、請求生成直前に `unpaidChecked` フラグを各行へ付与しています。ここでは合算設定や領収状態は参照されず、未回収フラグが付くのみです。【F:src/main.gs†L487-L545】
- 請求ソース構築時に参照される未回収履歴は「請求未入金履歴」シート由来で、当該月より前のエントリがある場合だけ繰越額 (`carryOverByPatient`) に加算されます。銀行シートの未回収チェックだけでは履歴は増えず、別途履歴行の存在が前提になっています。【F:src/get/billingGet.js†L1412-L1515】

## 合算請求・領収表示の現在挙動
- `AGGREGATE` 指定と `aggregateUntilMonth` は `prepared` や履歴書き出し用の行に保存されるだけで、請求金額計算や領収表示ロジックでは参照されていません。結果として合算フロー固有の分岐は存在せず、通常請求と同じ計算が行われます。【F:src/main.gs†L433-L457】【F:src/output/billingOutput.js†L1140-L1206】
- 請求書の「前月領収」表示は常に「請求月の前月」銀行シートの金額合計を用います。`attachPreviousReceiptAmounts_` で前月シートの金額を患者IDごとに集計し、`hasPreviousReceiptSheet` が立っている場合のみ表示されます。`aggregateUntilMonth` や未回収フラグはここで考慮されません。【F:src/main.gs†L548-L618】【F:src/output/billingOutput.js†L309-L359】

## シナリオ観察（10月未回収 → 11月合算請求 → 12月通常請求＋10-11月領収）
1. **10月未回収**: 領収状態を `UNPAID` にしても金額計算は変わらず、未回収チェック列を付けても履歴への自動追記はないため、11月以降へ繰り越すには別途「未入金履歴」シートへ手入力が必要です。【F:src/main.gs†L433-L545】【F:src/get/billingGet.js†L1412-L1515】
2. **11月合算請求**: `AGGREGATE` と `aggregateUntilMonth=202410` を付けても、請求計算や明細行は通常通り生成されるだけです。10月分を自動加算したり、領収表示を制御するロジックは存在しません。【F:src/main.gs†L433-L457】【F:src/main.gs†L1958-L1975】
3. **12月通常請求＋10-11月領収**: 領収表示は常に11月銀行シートの入金額だけを表示し、10月分を含める経路はありません。また合算設定や未回収履歴に関わらず `receiptMonths` は「前月のみ」の固定値となります。結果として「10-11月の領収額を12月請求書でまとめて表示する」シナリオは未実装のままです。【F:src/main.gs†L548-L618】【F:src/output/billingOutput.js†L309-L359】

## 現状の破綻ポイント
- 未回収チェックと未入金履歴の連携がなく、未回収を後月に繰り越すために手入力が必須。
- 合算請求指定が計算・表示フローに連動しておらず、10月→11月合算のような振る舞いが実現されない。
- 前月領収表示が「直近1ヶ月固定」なため、10-11月分を12月請求で同時表示する経路が存在しない。
