# AE/AF の定義と請求・領収ルール（Issue #808 仕様反映版）

## 目的
- 銀行引落シートの AE / AF を唯一の判断基準として、未回収・合算請求・領収書発行可否の基準を固定する。
- 本ドキュメントは仕様宣言のみを目的とし、コード変更や UI 実装は範囲外。

## 用語定義（確定）

### AE（未回収）
- **意味**: 領収書を発行してはいけない状態を示すフラグ。
- **業務的意味**:
  - 口座振替未完了
  - 残高不足
  - 引落未実施
- **効果**: AE=ON の月は領収書を絶対に発行しない。

### AF（合算）
- **意味**: 当月の請求金額を翌月以降に合算して請求する予定であることを示すフラグ。
- **業務的意味**:
  - 未回収月を翌月請求に含める意思決定
- **効果**: AF=ON の月は単月請求を行わず、次月以降の請求に合算される。

## 領収書発行ルール（最重要）
- 領収書を発行できる条件は **AE=OFF かつ AF=OFF** の場合のみ。
- 以下のいずれかに該当する場合は領収書を発行してはいけない。
  - AE=ON（未回収）
  - AF=ON（合算予定）

## 請求合算ルール
- AF=ON の月の請求金額は翌月以降に合算する。
- 合算は金額ベースで行い、AF=ON の月単独の領収書は発行しない。
- 合算対象だった月がすべて **AE=OFF かつ AF=OFF** になったタイミングで、合算対象月をまとめた領収書を 1 枚発行する。

## 旧ロジックとの関係
- 既存の `receiptStatus` / `aggregateUntilMonth` ベースの判定は本仕様のスコープ外。
- 領収書表示可否の判断では銀行引落シートの AE / AF を唯一の根拠とする。

## 非スコープ
- UI 実装
- コード変更
- テスト追加
