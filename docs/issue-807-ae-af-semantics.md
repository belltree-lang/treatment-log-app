# AE/AF の定義と請求合算・領収書発行ルール（Issue #807）

## 背景
- 請求管理で使用している AE / AF コードの意味を明確化し、請求書合算（aggregate）および領収書発行可否の判断における扱いを統一する。
- 現行実装は `receiptStatus`（例: `UNPAID`・`HOLD`・`AGGREGATE` など）と `aggregateUntilMonth` を組み合わせて表示可否を決めるが、AE/AF を明示的に扱う仕様が無い。
- 本メモは業務ルールの宣言のみを目的とし、実装変更は行わない。

## AE / AF の意味
- **AE (Aggregate Enabled)**
  - 当月請求を「他月と合算する権限・意志がある」状態。
  - 対象: 合算希望の患者や特殊契約で月跨ぎ請求をまとめるケース。
  - デフォルト動作: 合算終了月の指定が無くても領収書表示は許可（合算有無にかかわらず透明性を優先）。
- **AF (Aggregate Forbidden)**
  - 合算を禁止する状態。請求月は単月で扱い、他月とまとめない。
  - 対象: 行政指導・契約上の理由で月次ごとに明細を分ける必要がある患者。
  - デフォルト動作: 合算終了月が指定されていても合算は行わず、領収書は単月で発行する。

## 請求合算ルールへの組み込み
1. **合算許可判定の前段に AE/AF を適用する**
   - `receiptStatus` が `AGGREGATE` でも AF の場合は合算を抑止し、`aggregateUntilMonth` を無視する。
   - AE の場合は現行仕様どおり `aggregateUntilMonth` の有無で `receiptMonths` を決定する。
2. **開始・終了月のバリデーション**
   - AE/AF は「合算の可否」を決めるメタ情報であり、`billingMonth` / `aggregateUntilMonth` のフォーマット検証（`YYYYMM`・請求月≦終了月など）には影響しない。
   - ただし AF の場合、終了月が請求月より後でも「単月扱い」として `billingMonth` のみを範囲に採用する。
3. **履歴・Prepared データへの反映方針**
   - AE/AF は請求レコードのメタ属性として保存し、`receiptStatus` とは別列で管理する。
   - 既存の「既存値優先」ロジック（履歴シート）との整合性を保つため、AE/AF も同じマージポリシーを採用するか、Prepared を正とするかを実装時に決定する（本メモでは決めない）。

## 領収書表示・備考への影響
- **AE + 合算指定（`aggregateUntilMonth` あり）**
  - 現行どおり、請求月から終了月までの `receiptMonths` を生成し、備考に令和表記の合算範囲を付与する。
  - `receiptStatus` が `UNPAID` / `HOLD` の場合は非表示。その他ステータスは合算指定により強制表示する既存ルールを維持する。
- **AE + 合算指定なし**
  - 単月領収書を表示（備考なし）。
- **AF（合算禁止）**
  - `receiptStatus` による表示可否は現行どおりだが、`aggregateUntilMonth` の指定を無視し、`receiptMonths` は `billingMonth` のみとする。
  - 備考（合算範囲表示）は出力しない。

## 運用ルール
- AE/AF の設定は患者単位・請求月単位のどちらで持つかを運用チームで決定する。デフォルトは「患者属性（恒久）」、例外的に月次オーバーライドを許可する運用を推奨。
- 画面入力: AE/AF を切り替える UI を設け、AF 選択時は `aggregateUntilMonth` 入力欄を非活性にする。
- ログ/監査: AF 状態で合算指定が送られてきた場合は警告ログを残し、入力値を破棄した上で単月表示とする。

## 受入観点（将来実装のためのテスト観点）
- AE/AF 設定の有無で `receiptMonths` の組み立て結果が変わることを確認する。
- AF で `aggregateUntilMonth` が指定されても合算されないこと、および備考が空になることを確認する。
- AE の場合、現行の合算表示テーブル（`docs/billing-receipt-status.md`）と同じ結果になることを確認する。
- `receiptStatus` が `UNPAID` / `HOLD` の場合は AE/AF に関わらず非表示のままであることを確認する。
