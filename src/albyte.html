<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>アルバイト勤怠</title>
<style>
  :root{
    --bg:#f8fafc;
    --fg:#1f2937;
    --card:#fff;
    --brand:#2563eb;
    --brand-dark:#1d4ed8;
    --muted:#6b7280;
    --border:#e5e7eb;
    --success:#10b981;
    --warning:#f59e0b;
    --danger:#ef4444;
  }
  *{ box-sizing:border-box; }
  body{ margin:0; font-family:system-ui,-apple-system,"Segoe UI","Noto Sans JP",sans-serif; background:var(--bg); color:var(--fg); }
  .wrap{ max-width:560px; margin:0 auto; padding:32px 16px 64px; display:flex; flex-direction:column; gap:20px; }
  .card{ background:var(--card); border-radius:18px; padding:24px; box-shadow:0 12px 36px rgba(15,23,42,0.08); display:flex; flex-direction:column; gap:20px; }
  h1{ margin:0; font-size:1.4rem; }
  h2{ margin:0; font-size:1.1rem; }
  .muted{ color:var(--muted); font-size:0.9rem; }
  label{ display:flex; flex-direction:column; gap:8px; font-size:0.95rem; }
  input{ padding:10px 12px; border:1px solid var(--border); border-radius:10px; font-size:1rem; }
  input:focus{ outline:2px solid rgba(37,99,235,0.25); }
  .btn{ appearance:none; border:0; border-radius:999px; padding:10px 18px; background:var(--brand); color:#fff; font-size:0.95rem; font-weight:600; cursor:pointer; transition:transform .15s ease, box-shadow .15s ease; }
  .btn:hover{ transform:translateY(-1px); box-shadow:0 12px 26px rgba(37,99,235,0.2); }
  .btn:disabled{ opacity:.5; cursor:not-allowed; transform:none; box-shadow:none; }
  .btn.ghost{ background:#e5e7eb; color:#1f2937; }
  .btn.ghost:hover{ box-shadow:none; transform:none; }
  .btn.preset{ background:#eef2ff; color:#3730a3; }
  .btn.preset.selected{ background:#4338ca; color:#fff; }
  .btn.preset:disabled{ background:#e5e7eb; color:var(--muted); }
  .login-form{ display:flex; flex-direction:column; gap:16px; }
  .login-actions{ display:flex; flex-direction:column; gap:12px; }
  .error{ color:var(--danger); font-size:0.9rem; min-height:1.2em; }
  .portal-header{ display:flex; flex-wrap:wrap; justify-content:space-between; gap:16px; align-items:flex-start; }
  .staff-meta{ display:flex; align-items:center; gap:12px; font-weight:600; }
  .status-card{ display:flex; flex-direction:column; gap:12px; border:1px solid var(--border); border-radius:16px; padding:16px; background:#f9fafb; }
  .status-header{ display:flex; justify-content:space-between; align-items:center; gap:12px; }
  .status-badge{ display:inline-flex; align-items:center; padding:6px 12px; border-radius:999px; font-size:0.85rem; font-weight:600; }
  .status-idle{ background:rgba(15,23,42,0.08); color:#111827; }
  .status-working{ background:rgba(245,158,11,0.18); color:#b45309; }
  .status-completed{ background:rgba(16,185,129,0.18); color:#047857; }
  .status-list{ display:grid; grid-template-columns:repeat(auto-fit,minmax(120px,1fr)); gap:12px; margin:0; }
  .status-list dt{ font-size:0.8rem; color:var(--muted); margin:0 0 4px; }
  .status-list dd{ margin:0; font-size:1.1rem; font-weight:600; }
  .status-updated{ font-size:0.85rem; }
  .action-row{ display:flex; flex-wrap:wrap; gap:12px; }
  .action-row .btn{ flex:1; min-width:140px; }
  .break-card{ display:flex; flex-direction:column; gap:16px; }
  .preset-grid{ display:flex; flex-wrap:wrap; gap:8px; }
  .custom-break{ display:flex; flex-direction:column; gap:8px; }
  .custom-input-row{ display:flex; gap:8px; }
  .custom-input-row input{ flex:1; }
  .break-note{ font-size:0.85rem; color:var(--muted); }
  .loading{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(255,255,255,0.78); z-index:1500; }
  .loading.hidden{ display:none; }
  .loading-box{ display:flex; align-items:center; gap:12px; background:#fff; padding:14px 18px; border-radius:14px; box-shadow:0 18px 40px rgba(15,23,42,0.2); font-weight:600; }
  .spinner{ width:18px; height:18px; border-radius:50%; border:3px solid rgba(37,99,235,0.25); border-top-color:var(--brand); animation:spin .8s linear infinite; }
  @keyframes spin{ to{ transform:rotate(360deg); } }
  .toast{ position:fixed; left:50%; bottom:32px; transform:translateX(-50%); background:#111827; color:#fff; padding:10px 18px; border-radius:999px; font-size:0.9rem; opacity:0; pointer-events:none; transition:opacity .3s ease; z-index:1600; }
  .toast.show{ opacity:1; }
  @media (max-width:560px){
    .action-row{ flex-direction:column; }
    .action-row .btn{ width:100%; }
    .custom-input-row{ flex-direction:column; }
    .custom-input-row button{ width:100%; }
  }
</style>
</head>
<body>
<div class="wrap">
  <section id="loginView" class="card">
    <div>
      <h1>アルバイト勤怠ログイン</h1>
      <p class="muted">名前と4桁のPINコードでログインしてください。</p>
    </div>
    <form id="loginForm" class="login-form" autocomplete="off">
      <label for="loginName">名前
        <input id="loginName" type="text" name="name" autocomplete="off" required />
      </label>
      <label for="loginPin">PINコード（4桁）
        <input id="loginPin" type="password" name="pin" inputmode="numeric" pattern="[0-9]*" maxlength="4" autocomplete="off" required />
      </label>
      <div class="login-actions">
        <button type="submit" class="btn">ログイン</button>
        <div id="loginError" class="error" role="alert" aria-live="polite"></div>
      </div>
    </form>
  </section>

  <section id="portalView" class="card" hidden>
    <div class="portal-header">
      <div>
        <h1>アルバイト勤怠</h1>
        <div id="portalNow" class="muted"></div>
      </div>
      <div class="staff-meta">
        <span id="staffNameLabel"></span>
        <button id="logoutButton" type="button" class="btn ghost">ログアウト</button>
      </div>
    </div>

    <div class="status-card">
      <div class="status-header">
        <h2 id="todayDisplay"></h2>
        <span id="statusBadge" class="status-badge status-idle">未出勤</span>
      </div>
      <dl class="status-list">
        <div>
          <dt>出勤</dt>
          <dd id="clockInValue">--:--</dd>
        </div>
        <div>
          <dt>退勤</dt>
          <dd id="clockOutValue">--:--</dd>
        </div>
        <div>
          <dt>休憩</dt>
          <dd id="breakValue">0分</dd>
        </div>
      </dl>
      <div id="updatedAtValue" class="status-updated muted"></div>
    </div>

    <div class="action-row">
      <button id="clockInButton" type="button" class="btn">出勤打刻</button>
      <button id="clockOutButton" type="button" class="btn ghost">退勤打刻</button>
    </div>

    <div class="break-card">
      <div>
        <h2>休憩時間</h2>
        <p class="muted">プリセットまたは手入力（15分単位・最大180分）で登録できます。</p>
      </div>
      <div id="breakPresetGroup" class="preset-grid"></div>
      <form id="breakCustomForm" class="custom-break">
        <label for="breakCustomInput">手入力</label>
        <div class="custom-input-row">
          <input id="breakCustomInput" type="number" min="0" max="180" step="15" placeholder="15分単位" />
          <button type="submit" class="btn ghost">設定する</button>
        </div>
      </form>
      <div id="breakNotice" class="break-note"></div>
    </div>
  </section>
</div>

<div id="loading" class="loading hidden" role="status" aria-live="polite">
  <div class="loading-box"><span class="spinner" aria-hidden="true"></span><span id="loadingText">通信中…</span></div>
</div>
<div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
const SESSION_STORAGE_KEY = 'albyte.session.v1';
const STATUS_LABELS = { idle: '未出勤', working: '勤務中', completed: '退勤済み' };
const STATUS_CLASS = { idle: 'status-idle', working: 'status-working', completed: 'status-completed' };

const loginView = document.getElementById('loginView');
const portalView = document.getElementById('portalView');
const loginForm = document.getElementById('loginForm');
const loginNameInput = document.getElementById('loginName');
const loginPinInput = document.getElementById('loginPin');
const loginError = document.getElementById('loginError');
const portalNow = document.getElementById('portalNow');
const staffNameLabel = document.getElementById('staffNameLabel');
const todayDisplay = document.getElementById('todayDisplay');
const statusBadge = document.getElementById('statusBadge');
const clockInValue = document.getElementById('clockInValue');
const clockOutValue = document.getElementById('clockOutValue');
const breakValue = document.getElementById('breakValue');
const updatedAtValue = document.getElementById('updatedAtValue');
const clockInButton = document.getElementById('clockInButton');
const clockOutButton = document.getElementById('clockOutButton');
const logoutButton = document.getElementById('logoutButton');
const breakPresetGroup = document.getElementById('breakPresetGroup');
const breakCustomForm = document.getElementById('breakCustomForm');
const breakCustomInput = document.getElementById('breakCustomInput');
const breakNotice = document.getElementById('breakNotice');
const loadingOverlay = document.getElementById('loading');
const loadingText = document.getElementById('loadingText');
const toast = document.getElementById('toast');

let sessionState = null;
let portalState = null;
let toastTimer = null;

function setView(view){
  if (view === 'portal') {
    portalView.hidden = false;
    loginView.hidden = true;
  } else {
    portalView.hidden = true;
    loginView.hidden = false;
  }
}

function setLoading(active, message){
  if (active) {
    loadingText.textContent = message || '通信中…';
    loadingOverlay.classList.remove('hidden');
  } else {
    loadingOverlay.classList.add('hidden');
  }
}

function showToast(message){
  if (!message) return;
  toast.textContent = message;
  toast.classList.add('show');
  if (toastTimer) {
    clearTimeout(toastTimer);
  }
  toastTimer = setTimeout(() => {
    toast.classList.remove('show');
  }, 2600);
}

function loadSession(){
  try {
    const raw = localStorage.getItem(SESSION_STORAGE_KEY);
    if (!raw) return null;
    const parsed = JSON.parse(raw);
    if (parsed && parsed.token) {
      return parsed;
    }
  } catch (err) {
    console.warn('[albyte] failed to load session', err);
  }
  return null;
}

function saveSession(){
  try {
    if (sessionState && sessionState.token) {
      localStorage.setItem(SESSION_STORAGE_KEY, JSON.stringify(sessionState));
    } else {
      localStorage.removeItem(SESSION_STORAGE_KEY);
    }
  } catch (err) {
    console.warn('[albyte] failed to save session', err);
  }
}

function clearSession(){
  sessionState = null;
  try {
    localStorage.removeItem(SESSION_STORAGE_KEY);
  } catch (err) {
    console.warn('[albyte] failed to clear session', err);
  }
}

function normalizePinInput(){
  loginPinInput.value = loginPinInput.value.replace(/[^0-9]/g, '').slice(0, 4);
}

function callServer(method, payload, options){
  if (typeof google === 'undefined' || !google.script || !google.script.run) {
    showToast('サーバーとの接続に失敗しました。');
    return;
  }
  const loadingMessage = options && options.loadingMessage;
  setLoading(true, loadingMessage);
  const runner = google.script.run
    .withSuccessHandler(res => {
      setLoading(false);
      if (options && typeof options.onSuccess === 'function') {
        options.onSuccess(res);
      }
    })
    .withFailureHandler(err => {
      setLoading(false);
      const msg = err && err.message ? err.message : 'エラーが発生しました。';
      if (options && typeof options.onFailure === 'function') {
        options.onFailure(err);
      } else {
        showToast(msg);
      }
    });
  try {
    if (payload === undefined) {
      runner[method]();
    } else {
      runner[method](payload);
    }
  } catch (err) {
    setLoading(false);
    const msg = err && err.message ? err.message : '処理を開始できませんでした。';
    showToast(msg);
  }
}

function handlePortalResponse(res, options){
  if (!res || res.ok !== true) {
    const reason = res && res.reason;
    const message = res && res.message ? res.message : '処理に失敗しました。';
    if (reason === 'session_invalid' || reason === 'account_locked') {
      showToast(message);
      logout();
      return;
    }
    showToast(message);
    return;
  }

  if (!sessionState) {
    sessionState = { token: '', staff: res.staff };
  }
  if (res.token) {
    sessionState.token = res.token;
  }
  if (res.renewedToken) {
    sessionState.token = res.renewedToken;
  }
  sessionState.staff = res.staff;
  saveSession();

  portalState = res.portal;
  renderPortal();
  if (options && options.toast) {
    showToast(options.toast);
  }
}

function renderPortal(){
  if (!portalState || !sessionState) return;
  setView('portal');
  const portal = portalState;
  staffNameLabel.textContent = sessionState.staff ? sessionState.staff.name + ' さん' : '';
  portalNow.textContent = portal.now && portal.now.display ? portal.now.display : '';
  todayDisplay.textContent = portal.today.display || '';

  const status = portal.today.status || 'idle';
  statusBadge.textContent = STATUS_LABELS[status] || STATUS_LABELS.idle;
  statusBadge.className = 'status-badge ' + (STATUS_CLASS[status] || STATUS_CLASS.idle);

  const record = portal.today.record || null;
  clockInValue.textContent = record && record.clockIn ? record.clockIn : '--:--';
  clockOutValue.textContent = record && record.clockOut ? record.clockOut : '--:--';
  const breakMinutes = portal.today.breakMinutes != null ? portal.today.breakMinutes : 0;
  breakValue.textContent = breakMinutes + '分';

  if (record && record.updatedAt) {
    const updated = formatUpdatedAt(record.updatedAt);
    updatedAtValue.textContent = '更新: ' + updated;
  } else {
    updatedAtValue.textContent = '更新: --';
  }

  const canClockIn = status === 'idle';
  const canClockOut = status === 'working';
  clockInButton.disabled = !canClockIn;
  clockOutButton.disabled = !canClockOut;

  const canSetBreak = Boolean(record && record.clockIn);
  renderBreakPresets(portal.presets || [], breakMinutes, canSetBreak);
  breakCustomInput.disabled = !canSetBreak;
  breakCustomInput.value = '';
  breakNotice.textContent = canSetBreak ? '' : '出勤打刻後に休憩を登録できます。';
}

function renderBreakPresets(presets, currentMinutes, enabled){
  breakPresetGroup.innerHTML = '';
  (presets || []).forEach(minutes => {
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'btn preset' + (minutes === currentMinutes ? ' selected' : '');
    btn.textContent = minutes + '分';
    btn.disabled = !enabled;
    btn.addEventListener('click', () => {
      if (!enabled) return;
      if (currentMinutes === minutes) {
        showToast('休憩はすでに' + minutes + '分です。');
        return;
      }
      updateBreak(minutes, 'preset');
    });
    breakPresetGroup.appendChild(btn);
  });
  if (!presets || presets.length === 0) {
    const empty = document.createElement('div');
    empty.className = 'muted';
    empty.textContent = 'プリセットが設定されていません。';
    breakPresetGroup.appendChild(empty);
  }
}

function formatUpdatedAt(value){
  const date = new Date(value);
  if (Number.isNaN(date.getTime())) return '--';
  const month = date.getMonth() + 1;
  const day = date.getDate();
  const hour = String(date.getHours()).padStart(2, '0');
  const minute = String(date.getMinutes()).padStart(2, '0');
  return month + '/' + day + ' ' + hour + ':' + minute;
}

function submitLogin(event){
  event.preventDefault();
  normalizePinInput();
  const name = loginNameInput.value.trim();
  const pin = loginPinInput.value.trim();
  if (!name){
    loginError.textContent = '名前を入力してください。';
    return;
  }
  if (!/^\d{4}$/.test(pin)){
    loginError.textContent = 'PINは4桁の数字で入力してください。';
    return;
  }
  loginError.textContent = '';
  callServer('albyteLogin', { name, pin }, {
    loadingMessage: '認証中…',
    onSuccess: res => {
      if (!res || res.ok !== true){
        const reason = res && res.reason;
        let message = res && res.message ? res.message : 'ログインに失敗しました。';
        if (reason === 'invalid_pin' && res.remainingAttempts != null){
          message += '（残り' + res.remainingAttempts + '回）';
        }
        loginError.textContent = message;
        return;
      }
      sessionState = { token: res.token, staff: res.staff };
      saveSession();
      portalState = res.portal;
      loginNameInput.value = '';
      loginPinInput.value = '';
      loginError.textContent = '';
      renderPortal();
      showToast('ログインしました。');
    },
    onFailure: err => {
      const message = err && err.message ? err.message : 'ログインに失敗しました。';
      loginError.textContent = message;
    }
  });
}

function clockIn(){
  if (!sessionState || !sessionState.token){
    showToast('セッションが切れました。再度ログインしてください。');
    setView('login');
    return;
  }
  callServer('albyteClockIn', { token: sessionState.token }, {
    loadingMessage: '出勤を記録しています…',
    onSuccess: res => handlePortalResponse(res, { toast: res && res.ok ? '出勤を記録しました。' : undefined })
  });
}

function clockOut(){
  if (!sessionState || !sessionState.token){
    showToast('セッションが切れました。再度ログインしてください。');
    setView('login');
    return;
  }
  callServer('albyteClockOut', { token: sessionState.token }, {
    loadingMessage: '退勤を記録しています…',
    onSuccess: res => handlePortalResponse(res, { toast: res && res.ok ? '退勤を記録しました。' : undefined })
  });
}

function updateBreak(minutes, source){
  if (!sessionState || !sessionState.token){
    showToast('セッションが切れました。再度ログインしてください。');
    setView('login');
    return;
  }
  const record = portalState && portalState.today ? portalState.today.record : null;
  if (!record || !record.clockIn){
    showToast('出勤打刻後に休憩を登録できます。');
    return;
  }
  callServer('albyteUpdateBreak', { token: sessionState.token, minutes, source }, {
    loadingMessage: '休憩時間を更新しています…',
    onSuccess: res => handlePortalResponse(res, { toast: res && res.ok ? '休憩を' + minutes + '分に設定しました。' : undefined })
  });
}

function submitCustomBreak(event){
  event.preventDefault();
  const value = Number(breakCustomInput.value);
  if (!portalState || !portalState.today || !portalState.today.record){
    showToast('出勤打刻後に休憩を登録できます。');
    return;
  }
  if (!Number.isFinite(value)){
    showToast('休憩時間は数値で入力してください。');
    return;
  }
  if (value < 0 || value > 180){
    showToast('休憩時間は0〜180分で入力してください。');
    return;
  }
  if (value % 15 !== 0){
    showToast('休憩時間は15分刻みで入力してください。');
    return;
  }
  const current = portalState.today.breakMinutes != null ? portalState.today.breakMinutes : 0;
  if (current === value){
    showToast('休憩はすでに' + value + '分です。');
    return;
  }
  updateBreak(value, 'custom');
}

function logout(){
  clearSession();
  portalState = null;
  setView('login');
}

function bootstrap(){
  loginForm.addEventListener('submit', submitLogin);
  loginPinInput.addEventListener('input', normalizePinInput);
  clockInButton.addEventListener('click', clockIn);
  clockOutButton.addEventListener('click', clockOut);
  logoutButton.addEventListener('click', () => {
    logout();
    showToast('ログアウトしました。');
  });
  breakCustomForm.addEventListener('submit', submitCustomBreak);

  sessionState = loadSession();
  if (sessionState && sessionState.token){
    setView('portal');
    callServer('albyteGetPortalState', { token: sessionState.token }, {
      loadingMessage: 'データを読み込んでいます…',
      onSuccess: res => {
        if (!res || res.ok !== true){
          clearSession();
          setView('login');
          if (res && res.message){
            showToast(res.message);
          }
          return;
        }
        sessionState.staff = res.staff;
        portalState = res.portal;
        saveSession();
        renderPortal();
      }
    });
  } else {
    setView('login');
  }
}

bootstrap();
</script>
</body>
</html>
