<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>アルバイト勤怠</title>
<style>
  :root{
    --bg:#f8fafc;
    --fg:#1f2937;
    --card:#fff;
    --brand:#2563eb;
    --brand-dark:#1d4ed8;
    --muted:#6b7280;
    --border:#e5e7eb;
    --success:#10b981;
    --warning:#f59e0b;
    --danger:#ef4444;
  }
  *{ box-sizing:border-box; }
  body{ margin:0; font-family:system-ui,-apple-system,"Segoe UI","Noto Sans JP",sans-serif; background:var(--bg); color:var(--fg); }
  .wrap{ max-width:560px; margin:0 auto; padding:32px 16px 64px; display:flex; flex-direction:column; gap:20px; }
  .card{ background:var(--card); border-radius:18px; padding:24px; box-shadow:0 12px 36px rgba(15,23,42,0.08); display:flex; flex-direction:column; gap:20px; }
  h1{ margin:0; font-size:1.4rem; }
  h2{ margin:0; font-size:1.1rem; }
  .muted{ color:var(--muted); font-size:0.9rem; }
  label{ display:flex; flex-direction:column; gap:8px; font-size:0.95rem; }
  input{ padding:10px 12px; border:1px solid var(--border); border-radius:10px; font-size:1rem; }
  input:focus{ outline:2px solid rgba(37,99,235,0.25); }
  .btn{ appearance:none; border:0; border-radius:999px; padding:10px 18px; background:var(--brand); color:#fff; font-size:0.95rem; font-weight:600; cursor:pointer; transition:transform .15s ease, box-shadow .15s ease; }
  .btn:hover{ transform:translateY(-1px); box-shadow:0 12px 26px rgba(37,99,235,0.2); }
  .btn:disabled{ opacity:.5; cursor:not-allowed; transform:none; box-shadow:none; }
  .btn.ghost{ background:#e5e7eb; color:#1f2937; }
  .btn.ghost:hover{ box-shadow:none; transform:none; }
  .btn.preset{ background:#eef2ff; color:#3730a3; }
  .btn.preset.selected{ background:#4338ca; color:#fff; }
  .btn.preset:disabled{ background:#e5e7eb; color:var(--muted); }
  .login-form{ display:flex; flex-direction:column; gap:16px; }
  .login-actions{ display:flex; flex-direction:column; gap:12px; }
  .error{ color:var(--danger); font-size:0.9rem; min-height:1.2em; }
  .portal-header{ display:flex; flex-wrap:wrap; justify-content:space-between; gap:16px; align-items:flex-start; }
  .staff-meta{ display:flex; align-items:center; gap:12px; font-weight:600; }
  .status-card{ display:flex; flex-direction:column; gap:12px; border:1px solid var(--border); border-radius:16px; padding:16px; background:#f9fafb; }
  .status-header{ display:flex; justify-content:space-between; align-items:center; gap:12px; }
  .status-badge{ display:inline-flex; align-items:center; padding:6px 12px; border-radius:999px; font-size:0.85rem; font-weight:600; }
  .status-idle{ background:rgba(15,23,42,0.08); color:#111827; }
  .status-working{ background:rgba(245,158,11,0.18); color:#b45309; }
  .status-completed{ background:rgba(16,185,129,0.18); color:#047857; }
  .status-list{ display:grid; grid-template-columns:repeat(auto-fit,minmax(120px,1fr)); gap:12px; margin:0; }
  .status-list dt{ font-size:0.8rem; color:var(--muted); margin:0 0 4px; }
  .status-list dd{ margin:0; font-size:1.1rem; font-weight:600; }
  .status-updated{ font-size:0.85rem; }
  .action-row{ display:flex; flex-wrap:wrap; gap:12px; }
  .action-row .btn{ flex:1; min-width:140px; }
  .break-card{ display:flex; flex-direction:column; gap:16px; }
  .preset-grid{ display:flex; flex-wrap:wrap; gap:8px; }
  .custom-break{ display:flex; flex-direction:column; gap:8px; }
  .custom-input-row{ display:flex; gap:8px; }
  .custom-input-row input{ flex:1; }
  .break-note{ font-size:0.85rem; color:var(--muted); }
  .monthly-card{ display:flex; flex-direction:column; gap:16px; }
  .monthly-header{ display:flex; justify-content:space-between; align-items:center; gap:12px; }
  .monthly-nav{ display:flex; align-items:center; gap:8px; font-size:0.9rem; }
  .monthly-nav button{ border:0; background:#e5e7eb; color:#1f2937; border-radius:999px; padding:6px 12px; font-size:0.85rem; cursor:pointer; transition:background .15s ease; }
  .monthly-nav button:hover{ background:#d1d5db; }
  .monthly-nav button:disabled{ opacity:.5; cursor:not-allowed; }
  .monthly-totals{ display:flex; flex-wrap:wrap; gap:12px; }
  .monthly-totals .metric{ background:#f1f5f9; border-radius:12px; padding:10px 14px; display:flex; flex-direction:column; gap:6px; min-width:120px; }
  .monthly-totals .metric span{ color:var(--muted); font-size:0.8rem; }
  .monthly-totals .metric strong{ font-size:1.05rem; }
  .table-scroll{ overflow-x:auto; margin:0 -16px -8px; padding:0 16px 16px; }
  .table-scroll::-webkit-scrollbar{ height:6px; }
  .table-scroll::-webkit-scrollbar-track{ background:transparent; }
  .table-scroll::-webkit-scrollbar-thumb{ background:rgba(15,23,42,0.28); border-radius:999px; }
  .monthly-table{ width:100%; border-collapse:separate; border-spacing:0; font-size:0.85rem; table-layout:fixed; min-width:640px; }
  .monthly-table col.col-date{ width:132px; }
  .monthly-table col.col-clock{ width:92px; }
  .monthly-table col.col-break{ width:72px; }
  .monthly-table col.col-work{ width:120px; }
  .monthly-table col.col-kind{ width:110px; }
  .monthly-table col.col-note{ width:220px; }
  .monthly-table col.col-auto{ width:72px; }
  .monthly-table thead th{ font-size:0.78rem; text-transform:uppercase; letter-spacing:0.04em; color:#475569; background:#f8fafc; border-bottom:1px solid #e2e8f0; }
  .monthly-table th, .monthly-table td{ border:1px solid #e5e7eb; padding:10px 12px; text-align:left; white-space:nowrap; }
  .monthly-table tbody tr:nth-child(even){ background:#f9fafb; }
  .monthly-table tbody tr:hover{ background:#eef2ff; }
  .monthly-table .cell-note, .monthly-table .cell-auto{ white-space:normal; word-break:break-word; }
  .monthly-table .cell-date{ font-weight:600; }
  .monthly-table .cell-break{ text-align:center; font-variant-numeric:tabular-nums; }
  .monthly-table .cell-clock, .monthly-table .cell-work{ font-variant-numeric:tabular-nums; }
  .loading{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(255,255,255,0.78); z-index:1500; }
  .loading.hidden{ display:none; }
  .loading-box{ display:flex; align-items:center; gap:12px; background:#fff; padding:14px 18px; border-radius:14px; box-shadow:0 18px 40px rgba(15,23,42,0.2); font-weight:600; }
  .spinner{ width:18px; height:18px; border-radius:50%; border:3px solid rgba(37,99,235,0.25); border-top-color:var(--brand); animation:spin .8s linear infinite; }
  @keyframes spin{ to{ transform:rotate(360deg); } }
  .toast{ position:fixed; left:50%; bottom:32px; transform:translateX(-50%); background:#111827; color:#fff; padding:10px 18px; border-radius:999px; font-size:0.9rem; opacity:0; pointer-events:none; transition:opacity .3s ease; z-index:1600; }
  .toast.show{ opacity:1; }
  @media (max-width:560px){
    .action-row{ flex-direction:column; }
    .action-row .btn{ width:100%; }
    .custom-input-row{ flex-direction:column; }
    .custom-input-row button{ width:100%; }
    .card{ padding:20px; }
    .wrap{ padding:24px 12px 56px; }
    .monthly-table{ font-size:0.78rem; min-width:560px; }
    .monthly-table th, .monthly-table td{ padding:8px 10px; }
    .table-scroll{ margin:0 -12px -6px; padding:0 12px 12px; }
    .monthly-table col.col-note{ width:180px; }
  }
</style>
</head>
<body>
<div class="wrap">
  <section id="loginView" class="card">
    <div>
      <h1>アルバイト勤怠ログイン</h1>
      <p class="muted">名前と4桁のPINコードでログインしてください。</p>
    </div>
    <form id="loginForm" class="login-form" autocomplete="off">
      <label for="loginName">名前
        <input id="loginName" type="text" name="name" autocomplete="off" required />
      </label>
      <label for="loginPin">PINコード（4桁）
        <input id="loginPin" type="password" name="pin" inputmode="numeric" pattern="[0-9]*" maxlength="4" autocomplete="off" required />
      </label>
      <div class="login-actions">
        <button type="submit" class="btn">ログイン</button>
        <div id="loginError" class="error" role="alert" aria-live="polite"></div>
      </div>
    </form>
  </section>

  <section id="portalView" class="card" hidden>
    <div class="portal-header">
      <div>
        <h1>アルバイト勤怠</h1>
        <div id="portalNow" class="muted"></div>
      </div>
      <div class="staff-meta">
        <span id="staffNameLabel"></span>
        <button id="logoutButton" type="button" class="btn ghost">ログアウト</button>
      </div>
    </div>

    <div class="status-card">
      <div class="status-header">
        <h2 id="todayDisplay"></h2>
        <span id="statusBadge" class="status-badge status-idle">未出勤</span>
      </div>
      <dl class="status-list">
        <div>
          <dt>出勤</dt>
          <dd id="clockInValue">--:--</dd>
        </div>
        <div>
          <dt>退勤</dt>
          <dd id="clockOutValue">--:--</dd>
        </div>
        <div>
          <dt>休憩</dt>
          <dd id="breakValue">0分</dd>
        </div>
      </dl>
      <div id="updatedAtValue" class="status-updated muted"></div>
    </div>

    <div class="action-row">
      <button id="clockInButton" type="button" class="btn">出勤打刻</button>
      <button id="clockOutButton" type="button" class="btn ghost">退勤打刻</button>
    </div>

    <div class="break-card">
      <div>
        <h2>休憩時間</h2>
        <p class="muted">プリセットまたは手入力（15分単位・最大180分）で登録できます。</p>
      </div>
      <div id="breakPresetGroup" class="preset-grid"></div>
      <form id="breakCustomForm" class="custom-break">
        <label for="breakCustomInput">手入力</label>
        <div class="custom-input-row">
          <input id="breakCustomInput" type="number" min="0" max="180" step="15" placeholder="15分単位" />
          <button type="submit" class="btn ghost">設定する</button>
        </div>
      </form>
      <div id="breakNotice" class="break-note"></div>
    </div>
  </section>

  <section id="monthlyCard" class="card monthly-card" hidden>
    <div class="monthly-header">
      <h2>月別サマリー</h2>
      <div class="monthly-nav">
        <button id="monthlyPrev" type="button">前月</button>
        <span id="monthlyLabel" class="muted"></span>
        <button id="monthlyNext" type="button">翌月</button>
      </div>
    </div>
    <div id="monthlyTotals" class="monthly-totals"></div>
    <div class="table-scroll">
      <table class="monthly-table">
        <colgroup>
          <col class="col-date" />
          <col class="col-clock" />
          <col class="col-clock" />
          <col class="col-break" />
          <col class="col-work" />
          <col class="col-kind" />
          <col class="col-note" />
          <col class="col-auto" />
        </colgroup>
        <thead>
          <tr>
            <th>日付</th>
            <th>出勤</th>
            <th>退勤</th>
            <th>休憩</th>
            <th>勤務/延長</th>
            <th>区分</th>
            <th>備考</th>
            <th>補正</th>
          </tr>
        </thead>
        <tbody id="monthlyTableBody"></tbody>
      </table>
    </div>
  </section>
</div>

<div id="loading" class="loading hidden" role="status" aria-live="polite">
  <div class="loading-box"><span class="spinner" aria-hidden="true"></span><span id="loadingText">通信中…</span></div>
</div>
<div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
function escapeHtml(value){
  if (value == null) return '';
  return String(value)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

const SESSION_STORAGE_KEY = 'albyte.session.v1';
const LEGACY_SERIAL_DATE_PATTERN = /(1899|1900)/;
const STATUS_LABELS = { idle: '未出勤', working: '勤務中', completed: '退勤済み' };
const STATUS_CLASS = { idle: 'status-idle', working: 'status-working', completed: 'status-completed' };

const loginView = document.getElementById('loginView');
const portalView = document.getElementById('portalView');
const loginForm = document.getElementById('loginForm');
const loginNameInput = document.getElementById('loginName');
const loginPinInput = document.getElementById('loginPin');
const loginError = document.getElementById('loginError');
const portalNow = document.getElementById('portalNow');
const staffNameLabel = document.getElementById('staffNameLabel');
const todayDisplay = document.getElementById('todayDisplay');
const statusBadge = document.getElementById('statusBadge');
const clockInValue = document.getElementById('clockInValue');
const clockOutValue = document.getElementById('clockOutValue');
const breakValue = document.getElementById('breakValue');
const updatedAtValue = document.getElementById('updatedAtValue');
const clockInButton = document.getElementById('clockInButton');
const clockOutButton = document.getElementById('clockOutButton');
const logoutButton = document.getElementById('logoutButton');
const breakPresetGroup = document.getElementById('breakPresetGroup');
const breakCustomForm = document.getElementById('breakCustomForm');
const breakCustomInput = document.getElementById('breakCustomInput');
const breakNotice = document.getElementById('breakNotice');
const breakCard = document.querySelector('.break-card');
const loadingOverlay = document.getElementById('loading');
const loadingText = document.getElementById('loadingText');
const toast = document.getElementById('toast');
const monthlyCard = document.getElementById('monthlyCard');
const monthlyLabel = document.getElementById('monthlyLabel');
const monthlyTotals = document.getElementById('monthlyTotals');
const monthlyTableBody = document.getElementById('monthlyTableBody');
const monthlyPrevButton = document.getElementById('monthlyPrev');
const monthlyNextButton = document.getElementById('monthlyNext');

let sessionState = null;
let portalState = null;
let toastTimer = null;
let monthlyState = null;
let monthlyLoading = false;

function setView(view){
  if (view === 'portal') {
    portalView.hidden = false;
    loginView.hidden = true;
    ensureMonthlySummary();
  } else {
    portalView.hidden = true;
    loginView.hidden = false;
    resetMonthlySummary();
  }
}

function setLoading(active, message){
  if (active) {
    loadingText.textContent = message || '通信中…';
    loadingOverlay.classList.remove('hidden');
  } else {
    loadingOverlay.classList.add('hidden');
  }
}

function showToast(message){
  if (!message) return;
  toast.textContent = message;
  toast.classList.add('show');
  if (toastTimer) {
    clearTimeout(toastTimer);
  }
  toastTimer = setTimeout(() => {
    toast.classList.remove('show');
  }, 2600);
}

function resetMonthlySummary(){
  monthlyState = null;
  monthlyLoading = false;
  if (monthlyCard) {
    monthlyCard.hidden = true;
  }
  if (monthlyPrevButton) monthlyPrevButton.disabled = false;
  if (monthlyNextButton) monthlyNextButton.disabled = false;
  if (monthlyLabel) monthlyLabel.textContent = '';
  if (monthlyTotals) monthlyTotals.innerHTML = '';
  if (monthlyTableBody) monthlyTableBody.innerHTML = '';
}

function getPortalMonthTarget(){
  if (portalState && portalState.today && portalState.today.date) {
    const parts = String(portalState.today.date).split('-');
    if (parts.length >= 2) {
      const y = Number(parts[0]);
      const m = Number(parts[1]);
      if (Number.isFinite(y) && Number.isFinite(m)) {
        return { year: y, month: m };
      }
    }
  }
  const now = new Date();
  return { year: now.getFullYear(), month: now.getMonth() + 1 };
}

function formatBreakValue(minutes, text){
  const numeric = Number(minutes);
  if (!Number.isFinite(numeric) || numeric <= 0) {
    return '–';
  }
  return escapeHtml(text || '–');
}

function formatBreakCellValue(row){
  if (!row || row.isDailyStaff) {
    return '--';
  }
  return formatBreakValue(row.breakMinutes, row.breakText);
}

function formatSourceLabel(row){
  if (!row) return '通常勤務';
  return row.sourceLabel || '通常勤務';
}

function normalizeMonthlyRecords(records){
  if (!Array.isArray(records)) return [];
  const seen = new Set();
  const normalized = [];
  records.forEach(record => {
    if (!record) return;
    if (record.date) {
      const key = `${String(record.date)}__${String(record.clockIn || '')}`;
      if (seen.has(key)) {
        return;
      }
      seen.add(key);
    }
    normalized.push(Object.assign({}, record, {
      clockIn: formatClockValue(record.clockIn),
      clockOut: formatClockValue(record.clockOut)
    }));
  });
  return normalized;
}

function renderMonthlySummary(){
  if (!monthlyCard) return;
  if (!monthlyState) {
    resetMonthlySummary();
    return;
  }
  monthlyCard.hidden = false;
  const summary = monthlyState;
  const totals = summary.totals || {};
  const isDailySummary = summary.staffType === 'daily';
  if (monthlyLabel) {
    monthlyLabel.textContent = summary.year + '年' + summary.month + '月';
  }
  if (monthlyTotals) {
    const metrics = [];
    const workText = escapeHtml(totals.durationText || totals.workText || '--');
    const breakText = isDailySummary ? '--' : formatBreakValue(totals.breakMinutes, totals.breakText);
    const workingDays = totals.workingDays != null ? escapeHtml(totals.workingDays) : escapeHtml('--');
    metrics.push(`<div class="metric"><span>${isDailySummary ? '延長時間' : '勤務時間'}</span><strong>${workText}</strong></div>`);
    metrics.push(`<div class="metric"><span>休憩</span><strong>${breakText}</strong></div>`);
    metrics.push(`<div class="metric"><span>勤務日数</span><strong>${workingDays}</strong></div>`);
    if (totals.estimatedWage != null) {
      metrics.push(`<div class="metric"><span>概算給与</span><strong>¥${escapeHtml(totals.estimatedWage.toLocaleString())}</strong></div>`);
    }
    monthlyTotals.innerHTML = metrics.join('');
  }
  if (monthlyTableBody) {
    const rows = Array.isArray(summary.records) ? summary.records : [];
    if (!rows.length) {
      monthlyTableBody.innerHTML = '<tr><td colspan="8">データがありません</td></tr>';
    } else {
      monthlyTableBody.innerHTML = rows.map(row => {
        const note = escapeHtml(row.note || '');
        const auto = escapeHtml(row.autoFlag || '');
        const date = escapeHtml(row.date || '');
        const clockIn = escapeHtml(row.clockIn || '');
        const clockOut = escapeHtml(row.clockOut || '');
        const breakText = formatBreakCellValue(row);
        const workText = row.isDailyStaff
          ? `延長 ${escapeHtml(row.overtimeText || row.workText || '')}`
          : escapeHtml(row.workText || '');
        const kindText = escapeHtml(formatSourceLabel(row));
        return `<tr>
          <td class="cell-date">${date}</td>
          <td class="cell-clock">${clockIn}</td>
          <td class="cell-clock">${clockOut}</td>
          <td class="cell-break">${breakText}</td>
          <td class="cell-work">${workText}</td>
          <td class="cell-kind">${kindText}</td>
          <td class="cell-note">${note}</td>
          <td class="cell-auto">${auto}</td>
        </tr>`;
      }).join('');
    }
  }
}

function loadMonthlySummary(year, month){
  if (!sessionState || !sessionState.token || monthlyLoading) return;
  monthlyLoading = true;
  if (monthlyPrevButton) monthlyPrevButton.disabled = true;
  if (monthlyNextButton) monthlyNextButton.disabled = true;
  const target = {};
  if (Number.isFinite(year) && Number.isFinite(month)) {
    target.year = year;
    target.month = month;
  }
  if (monthlyTotals) {
    monthlyTotals.innerHTML = '<div class="metric"><span>読み込み中</span><strong>…</strong></div>';
  }
  const request = Object.assign({ token: sessionState.token }, target);
  google.script.run
    .withSuccessHandler(res => {
      monthlyLoading = false;
      if (monthlyPrevButton) monthlyPrevButton.disabled = false;
      if (monthlyNextButton) monthlyNextButton.disabled = false;
      if (!res || res.ok !== true || !res.summary) {
        if (res && res.message) {
          showToast(res.message);
        }
        return;
      }
      monthlyState = Object.assign({}, res.summary, {
        records: normalizeMonthlyRecords(res.summary && res.summary.records)
      });
      renderMonthlySummary();
    })
    .withFailureHandler(err => {
      monthlyLoading = false;
      if (monthlyPrevButton) monthlyPrevButton.disabled = false;
      if (monthlyNextButton) monthlyNextButton.disabled = false;
      if (monthlyTotals) {
        monthlyTotals.innerHTML = '<div class="metric"><span>エラー</span><strong>--</strong></div>';
      }
      showToast(err && err.message ? err.message : '月次データの取得に失敗しました。');
    })
    .albyteGetMonthlySummary(request);
}

function ensureMonthlySummary(){
  if (!sessionState || !sessionState.token) {
    resetMonthlySummary();
    return;
  }
  const target = monthlyState ? { year: monthlyState.year, month: monthlyState.month } : getPortalMonthTarget();
  if (!monthlyState || monthlyState.year !== target.year || monthlyState.month !== target.month) {
    loadMonthlySummary(target.year, target.month);
  } else {
    renderMonthlySummary();
  }
}

function changeMonthlySummary(delta){
  if (!monthlyState || monthlyLoading) return;
  let year = monthlyState.year;
  let month = monthlyState.month + delta;
  while (month <= 0) {
    month += 12;
    year -= 1;
  }
  while (month > 12) {
    month -= 12;
    year += 1;
  }
  loadMonthlySummary(year, month);
}

function loadSession(){
  try {
    const raw = localStorage.getItem(SESSION_STORAGE_KEY);
    if (!raw) return null;
    const parsed = JSON.parse(raw);
    if (parsed && parsed.token) {
      return parsed;
    }
  } catch (err) {
    console.warn('[albyte] failed to load session', err);
  }
  return null;
}

function saveSession(){
  try {
    if (sessionState && sessionState.token) {
      localStorage.setItem(SESSION_STORAGE_KEY, JSON.stringify(sessionState));
    } else {
      localStorage.removeItem(SESSION_STORAGE_KEY);
    }
  } catch (err) {
    console.warn('[albyte] failed to save session', err);
  }
}

function clearSession(){
  sessionState = null;
  try {
    localStorage.removeItem(SESSION_STORAGE_KEY);
  } catch (err) {
    console.warn('[albyte] failed to clear session', err);
  }
}

function normalizePinInput(){
  loginPinInput.value = loginPinInput.value.replace(/[^0-9]/g, '').slice(0, 4);
}

function callServer(method, payload, options){
  if (typeof google === 'undefined' || !google.script || !google.script.run) {
    showToast('サーバーとの接続に失敗しました。');
    return;
  }
  const loadingMessage = options && options.loadingMessage;
  setLoading(true, loadingMessage);
  const runner = google.script.run
    .withSuccessHandler(res => {
      setLoading(false);
      if (options && typeof options.onSuccess === 'function') {
        options.onSuccess(res);
      }
    })
    .withFailureHandler(err => {
      setLoading(false);
      const msg = err && err.message ? err.message : 'エラーが発生しました。';
      if (options && typeof options.onFailure === 'function') {
        options.onFailure(err);
      } else {
        showToast(msg);
      }
    });
  try {
    if (payload === undefined) {
      runner[method]();
    } else {
      runner[method](payload);
    }
  } catch (err) {
    setLoading(false);
    const msg = err && err.message ? err.message : '処理を開始できませんでした。';
    showToast(msg);
  }
}

function refreshPortalState(options){
  if (!sessionState || !sessionState.token) {
    return;
  }
  const silent = Boolean(options && options.silent);
  const loadingMessage = options && options.loadingMessage ? options.loadingMessage : 'データを読み込んでいます…';
  if (!silent) {
    setLoading(true, loadingMessage);
  }
  google.script.run
    .withSuccessHandler(res => {
      if (!silent) {
        setLoading(false);
      }
      handlePortalResponse(res, {
        suppressErrorToast: silent,
        toast: options && options.toast
      });
    })
    .withFailureHandler(err => {
      if (!silent) {
        setLoading(false);
        showToast(err && err.message ? err.message : '最新状態の取得に失敗しました。');
      } else {
        console.warn('[albyte] failed to refresh portal state', err);
      }
    })
    .albyteGetPortalState({ token: sessionState.token });
}

function handlePortalResponse(res, options){
  const suppressErrorToast = Boolean(options && options.suppressErrorToast);
  if (!res || res.ok !== true) {
    const reason = res && res.reason;
    const message = res && res.message ? res.message : '処理に失敗しました。';
    if (reason === 'session_invalid' || reason === 'account_locked') {
      showToast(message);
      logout();
      return;
    }
    if (!suppressErrorToast) {
      showToast(message);
    } else {
      console.warn('[albyte] suppressed error toast:', message);
    }
    return;
  }

  if (!sessionState) {
    sessionState = { token: '', staff: res.staff };
  }
  if (res.token) {
    sessionState.token = res.token;
  }
  if (res.renewedToken) {
    sessionState.token = res.renewedToken;
  }
  sessionState.staff = res.staff;
  saveSession();

  portalState = res.portal;
  renderPortal();
  if (res && res.ok) {
    if (monthlyState) {
      loadMonthlySummary(monthlyState.year, monthlyState.month);
    } else {
      ensureMonthlySummary();
    }
  }
  if (options && options.toast) {
    showToast(options.toast);
  }
  if (options && options.expectStatus) {
    const currentStatus = portalState && portalState.today ? portalState.today.status : '';
    if (currentStatus !== options.expectStatus) {
      refreshPortalState({ silent: true });
    }
  }
}

function renderPortal(){
  if (!portalState || !sessionState) return;
  setView('portal');
  const portal = portalState;
  staffNameLabel.textContent = sessionState.staff ? sessionState.staff.name + ' さん' : '';
  portalNow.textContent = portal.now && portal.now.display ? portal.now.display : '';
  todayDisplay.textContent = portal.today.display || '';
  const isDailyStaff = portal.staffType === 'daily' || (sessionState.staff && sessionState.staff.staffType === 'daily');

  const status = portal.today.status || 'idle';
  statusBadge.textContent = STATUS_LABELS[status] || STATUS_LABELS.idle;
  statusBadge.className = 'status-badge ' + (STATUS_CLASS[status] || STATUS_CLASS.idle);

  const record = portal.today.record || null;
  const clockInLabel = formatClockValue(record && record.clockIn);
  const clockOutLabel = formatClockValue(record && record.clockOut);
  clockInValue.textContent = clockInLabel || '--:--';
  clockOutValue.textContent = clockOutLabel || '--:--';
  const breakMinutes = portal.today.breakMinutes != null ? portal.today.breakMinutes : 0;
  breakValue.textContent = isDailyStaff ? '対象外' : (breakMinutes + '分');

  if (record && record.updatedAt) {
    const updated = formatUpdatedAt(record.updatedAt);
    updatedAtValue.textContent = '更新: ' + updated;
  } else {
    updatedAtValue.textContent = '更新: --';
  }

  const canClockIn = status === 'idle';
  const canClockOut = status === 'working';
  clockInButton.disabled = !canClockIn;
  clockOutButton.disabled = !canClockOut;

  const canSetBreak = !isDailyStaff && Boolean(record && record.clockIn);
  if (breakCard) {
    breakCard.hidden = isDailyStaff;
  }
  if (isDailyStaff) {
    breakPresetGroup.innerHTML = '';
    breakCustomInput.value = '';
    breakCustomInput.disabled = true;
    breakNotice.textContent = '日給スタッフは休憩登録不要です。';
  } else {
    renderBreakPresets(portal.presets || [], breakMinutes, canSetBreak);
    breakCustomInput.disabled = !canSetBreak;
    breakCustomInput.value = '';
    breakNotice.textContent = canSetBreak ? '' : '出勤打刻後に休憩を登録できます。';
  }
}

function renderBreakPresets(presets, currentMinutes, enabled){
  breakPresetGroup.innerHTML = '';
  (presets || []).forEach(minutes => {
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'btn preset' + (minutes === currentMinutes ? ' selected' : '');
    btn.textContent = minutes + '分';
    btn.disabled = !enabled;
    btn.addEventListener('click', () => {
      if (!enabled) return;
      if (currentMinutes === minutes) {
        showToast('休憩はすでに' + minutes + '分です。');
        return;
      }
      updateBreak(minutes, 'preset');
    });
    breakPresetGroup.appendChild(btn);
  });
  if (!presets || presets.length === 0) {
    const empty = document.createElement('div');
    empty.className = 'muted';
    empty.textContent = 'プリセットが設定されていません。';
    breakPresetGroup.appendChild(empty);
  }
}

function formatUpdatedAt(value){
  const date = new Date(value);
  if (Number.isNaN(date.getTime())) return '--';
  const month = date.getMonth() + 1;
  const day = date.getDate();
  const hour = String(date.getHours()).padStart(2, '0');
  const minute = String(date.getMinutes()).padStart(2, '0');
  return month + '/' + day + ' ' + hour + ':' + minute;
}

function formatClockValue(value){
  return formatTimeDisplay(value);
}

function formatTimeDisplay(value){
  if (value == null || value === '') return '';
  if (value instanceof Date && !isNaN(value.getTime())) {
    return formatDateToClock(value);
  }
  if (typeof value === 'number' && Number.isFinite(value)) {
    if (value > 1e10) {
      const date = new Date(value);
      if (!isNaN(date.getTime())) {
        return formatDateToClock(date);
      }
    }
    return formatMinutesAsClock(value);
  }
  const text = String(value).trim();
  if (!text) return '';
  const exact = text.match(/^(\d{1,2}):(\d{2})$/);
  if (exact) {
    return `${exact[1].padStart(2, '0')}:${exact[2]}`;
  }
  if (/^\d+$/.test(text)) {
    return formatMinutesAsClock(Number(text));
  }
  const parsedDate = new Date(text);
  if (!isNaN(parsedDate.getTime())) {
    return formatDateToClock(parsedDate);
  }
  const inlineMatch = text.match(/(\d{1,2}):(\d{2})/);
  if (inlineMatch) {
    return `${inlineMatch[1].padStart(2, '0')}:${inlineMatch[2]}`;
  }
  const legacyMatch = extractLegacyTime(text);
  if (legacyMatch) {
    return legacyMatch;
  }
  return text;
}

function extractLegacyTime(text){
  if (!text || !LEGACY_SERIAL_DATE_PATTERN.test(text)) return '';
  const match = text.match(/(\d{1,2}):(\d{2})(?::(\d{2}))?/);
  if (!match) return '';
  return `${match[1].padStart(2, '0')}:${match[2]}`;
}

function formatDateToClock(date){
  const hours = String(date.getHours()).padStart(2, '0');
  const minutes = String(date.getMinutes()).padStart(2, '0');
  return `${hours}:${minutes}`;
}

function formatMinutesAsClock(minutes){
  const total = Number(minutes);
  if (!Number.isFinite(total)) return '';
  const normalized = Math.max(0, Math.round(total));
  const hours = String(Math.floor(normalized / 60)).padStart(2, '0');
  const mins = String(normalized % 60).padStart(2, '0');
  return `${hours}:${mins}`;
}

function submitLogin(event){
  event.preventDefault();
  normalizePinInput();
  const name = loginNameInput.value.trim();
  const pin = loginPinInput.value.trim();
  if (!name){
    loginError.textContent = '名前を入力してください。';
    return;
  }
  if (!/^\d{4}$/.test(pin)){
    loginError.textContent = 'PINは4桁の数字で入力してください。';
    return;
  }
  loginError.textContent = '';
  callServer('albyteLogin', { name, pin }, {
    loadingMessage: '認証中…',
    onSuccess: res => {
      if (!res || res.ok !== true){
        const reason = res && res.reason;
        let message = res && res.message ? res.message : 'ログインに失敗しました。';
        if (reason === 'invalid_pin' && res.remainingAttempts != null){
          message += '（残り' + res.remainingAttempts + '回）';
        }
        loginError.textContent = message;
        return;
      }
      sessionState = { token: res.token, staff: res.staff };
      saveSession();
      portalState = res.portal;
      loginNameInput.value = '';
      loginPinInput.value = '';
      loginError.textContent = '';
      renderPortal();
      showToast('ログインしました。');
    },
    onFailure: err => {
      const message = err && err.message ? err.message : 'ログインに失敗しました。';
      loginError.textContent = message;
    }
  });
}

function clockIn(){
  if (!sessionState || !sessionState.token){
    showToast('セッションが切れました。再度ログインしてください。');
    setView('login');
    return;
  }
  callServer('albyteClockIn', { token: sessionState.token }, {
    loadingMessage: '出勤を記録しています…',
    onSuccess: res => handlePortalResponse(res, {
      toast: res && res.ok ? '出勤を記録しました。' : undefined,
      expectStatus: 'working'
    })
  });
}

function clockOut(){
  if (!sessionState || !sessionState.token){
    showToast('セッションが切れました。再度ログインしてください。');
    setView('login');
    return;
  }
  callServer('albyteClockOut', { token: sessionState.token }, {
    loadingMessage: '退勤を記録しています…',
    onSuccess: res => handlePortalResponse(res, {
      toast: res && res.ok ? '退勤を記録しました。' : undefined,
      expectStatus: 'completed'
    })
  });
}

function updateBreak(minutes, source){
  if (!sessionState || !sessionState.token){
    showToast('セッションが切れました。再度ログインしてください。');
    setView('login');
    return;
  }
  const record = portalState && portalState.today ? portalState.today.record : null;
  if (!record || !record.clockIn){
    showToast('出勤打刻後に休憩を登録できます。');
    return;
  }
  callServer('albyteUpdateBreak', { token: sessionState.token, minutes, source }, {
    loadingMessage: '休憩時間を更新しています…',
    onSuccess: res => handlePortalResponse(res, { toast: res && res.ok ? '休憩を' + minutes + '分に設定しました。' : undefined })
  });
}

function submitCustomBreak(event){
  event.preventDefault();
  const value = Number(breakCustomInput.value);
  if (!portalState || !portalState.today || !portalState.today.record){
    showToast('出勤打刻後に休憩を登録できます。');
    return;
  }
  if (!Number.isFinite(value)){
    showToast('休憩時間は数値で入力してください。');
    return;
  }
  if (value < 0 || value > 180){
    showToast('休憩時間は0〜180分で入力してください。');
    return;
  }
  if (value % 15 !== 0){
    showToast('休憩時間は15分刻みで入力してください。');
    return;
  }
  const current = portalState.today.breakMinutes != null ? portalState.today.breakMinutes : 0;
  if (current === value){
    showToast('休憩はすでに' + value + '分です。');
    return;
  }
  updateBreak(value, 'custom');
}

function logout(){
  clearSession();
  portalState = null;
  setView('login');
}

function bootstrap(){
  loginForm.addEventListener('submit', submitLogin);
  loginPinInput.addEventListener('input', normalizePinInput);
  clockInButton.addEventListener('click', clockIn);
  clockOutButton.addEventListener('click', clockOut);
  logoutButton.addEventListener('click', () => {
    logout();
    showToast('ログアウトしました。');
  });
  breakCustomForm.addEventListener('submit', submitCustomBreak);
  if (monthlyPrevButton) {
    monthlyPrevButton.addEventListener('click', () => changeMonthlySummary(-1));
  }
  if (monthlyNextButton) {
    monthlyNextButton.addEventListener('click', () => changeMonthlySummary(1));
  }

  sessionState = loadSession();
  if (sessionState && sessionState.token){
    setView('portal');
    refreshPortalState();
  } else {
    setView('login');
  }
}

bootstrap();
</script>
</body>
</html>
