<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>訪問スタッフ勤怠</title>
<style>
  :root{
    --bg:#f8fafc;
    --fg:#1f2937;
    --card:#fff;
    --brand:#2563eb;
    --muted:#6b7280;
    --border:#e5e7eb;
    --pending:#f59e0b;
    --approved:#10b981;
    --rejected:#ef4444;
  }
  *{ box-sizing:border-box; }
  body{ margin:0; font-family:system-ui,-apple-system,"Segoe UI","Noto Sans JP",sans-serif; background:var(--bg); color:var(--fg); }
  .wrap{ max-width:960px; margin:0 auto; padding:24px 16px 64px; display:flex; flex-direction:column; gap:24px; }
  .header{ display:flex; flex-direction:column; gap:16px; }
  .header-main{ display:flex; flex-direction:column; gap:4px; }
  .header-controls{ display:flex; flex-wrap:wrap; gap:12px; align-items:flex-end; }
  .header-actions{ display:flex; align-items:center; gap:12px; margin-left:auto; flex-wrap:wrap; }
  .tab-nav{ display:flex; gap:8px; margin:8px 0 0; }
  .tab-button{ border:0; border-radius:999px; padding:6px 16px; background:rgba(37,99,235,0.12); color:#1f2937; font-weight:600; cursor:pointer; }
  .tab-button.active{ background:var(--brand); color:#fff; }
  .tab-panel--hidden{ display:none; }
  .paid-leave-widget{ background:rgba(37,99,235,0.08); border-radius:12px; padding:8px 12px; font-size:0.9rem; color:#1f2937; display:flex; flex-direction:column; gap:2px; min-width:160px; }
  .paid-leave-widget strong{ color:#2563eb; font-size:1.05rem; }
  .paid-leave-widget-meta{ font-size:0.8rem; color:var(--muted); }
  .paid-leave-type-group{ display:flex; flex-wrap:wrap; gap:8px; }
  .paid-leave-type-option{ display:flex; align-items:center; gap:4px; padding:6px 10px; border:1px solid var(--border); border-radius:999px; font-size:0.9rem; background:#fff; }
  .paid-leave-type-option input{ margin:0; }
  .paid-leave-info{ background:rgba(37,99,235,0.06); border-radius:12px; padding:10px 12px; font-size:0.85rem; color:#1f2937; display:flex; flex-direction:column; gap:4px; }
  .paid-leave-info-line{ display:flex; justify-content:space-between; gap:12px; }
  .paid-leave-error{ color:#b91c1c; font-size:0.85rem; margin-top:6px; }
  .control{ display:flex; flex-direction:column; gap:6px; font-size:0.95rem; }
  select,input,textarea{ padding:8px 10px; border:1px solid var(--border); border-radius:10px; font-size:0.95rem; background:#fff; color:inherit; }
  textarea{ resize:vertical; min-height:96px; }
  .card{ background:var(--card); border-radius:18px; padding:20px; box-shadow:0 12px 34px rgba(15,23,42,0.06); }
  .card + .card{ margin-top:4px; }
  .card-header{ display:flex; flex-wrap:wrap; justify-content:space-between; gap:12px; align-items:center; margin-bottom:12px; }
  .muted{ color:var(--muted); font-size:0.9rem; }
  table{ width:100%; border-collapse:collapse; }
  .table-wrapper{ width:100%; overflow-x:auto; -webkit-overflow-scrolling:touch; scrollbar-width:thin; scrollbar-color:#94a3b8 transparent; }
  .table-wrapper::-webkit-scrollbar{ height:6px; }
  .table-wrapper::-webkit-scrollbar-track{ background:transparent; }
  .table-wrapper::-webkit-scrollbar-thumb{ background:#94a3b8; border-radius:4px; }
  .attendance-table{ width:100%; border-collapse:collapse; table-layout:fixed; }
  th,td{ text-align:left; padding:10px 8px; border-bottom:1px solid var(--border); font-size:0.95rem; vertical-align:top; }
  .attendance-table th{ font-weight:600; color:#111827; }
  .attendance-table th.col-date,
  .attendance-table td.col-date{ width:122px; }
  .attendance-table th.col-time,
  .attendance-table td.col-time,
  .attendance-table th.col-work,
  .attendance-table td.col-work,
  .attendance-table th.col-break,
  .attendance-table td.col-break{ width:86px; white-space:nowrap; font-variant-numeric:tabular-nums; }
  .attendance-table th.col-breakdown,
  .attendance-table td.col-breakdown{ width:16%; white-space:normal; word-break:break-word; overflow-wrap:anywhere; line-height:1.35; }
  .attendance-table th.col-source,
  .attendance-table td.col-source{ width:13%; white-space:normal; word-break:break-word; line-height:1.35; }
  .attendance-table th.col-request,
  .attendance-table td.col-request{ width:150px; white-space:normal; }
  .attendance-table th.col-actions,
  .attendance-table td.col-actions{ width:110px; text-align:center; white-space:nowrap; }
  .attendance-table td.col-actions .btn{ width:100%; }
  .attendance-table tbody tr:hover{ background:#f1f5f9; }
  .date-cell{ font-variant-numeric:tabular-nums; }
  .date-primary{ font-weight:600; }
  .date-sub{ font-size:0.85rem; margin-top:2px; }
  .time-cell{ font-variant-numeric:tabular-nums; }
  th{ font-weight:600; color:#111827; white-space:nowrap; }
  tbody tr:hover{ background:#f1f5f9; }
  .badge{ display:inline-flex; align-items:center; gap:4px; padding:4px 8px; border-radius:999px; font-size:0.8rem; font-weight:600; }
  .status-badge--pending{ background:rgba(245,158,11,0.15); color:#b45309; }
  .status-badge--approved{ background:rgba(16,185,129,0.15); color:#047857; }
  .status-badge--rejected{ background:rgba(239,68,68,0.15); color:#b91c1c; }
  .btn{ appearance:none; border:0; border-radius:999px; padding:8px 16px; background:var(--brand); color:#fff; font-size:0.9rem; font-weight:600; cursor:pointer; transition:transform .15s ease, box-shadow .15s ease; }
  .btn:hover{ transform:translateY(-1px); box-shadow:0 10px 20px rgba(37,99,235,0.15); }
  .btn:disabled{ opacity:.45; cursor:not-allowed; box-shadow:none; transform:none; }
  .btn.ghost{ background:#e5e7eb; color:#1f2937; }
  .btn-sm{ padding:6px 12px; font-size:0.82rem; }
  .table-note{ margin-top:12px; font-size:0.9rem; color:var(--muted); }
  .history-list{ display:flex; flex-direction:column; gap:12px; }
  .history-item{ border:1px solid var(--border); border-radius:12px; padding:12px 14px; background:#fff; }
  .history-item strong{ font-size:1rem; }
  .history-meta{ display:flex; flex-wrap:wrap; gap:8px; margin-top:6px; font-size:0.85rem; color:var(--muted); }
  .history-note{ margin-top:8px; white-space:pre-wrap; font-size:0.95rem; }
  .admin-table textarea{ width:100%; min-height:60px; }
  .admin-section{ display:flex; flex-direction:column; gap:8px; margin-top:16px; }
  .admin-section:first-of-type{ margin-top:0; }
  .admin-section h3{ margin:0; font-size:1rem; }
  .admin-actions{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
  .admin-paidleave-note{ width:100%; min-height:60px; }
  .modal{ position:fixed; inset:0; background:rgba(15,23,42,0.35); display:none; align-items:center; justify-content:center; padding:16px; z-index:1000; }
  .modal.open{ display:flex; }
  .dialog{ background:#fff; border-radius:16px; padding:20px; width:min(480px, 92vw); box-shadow:0 18px 48px rgba(15,23,42,0.25); display:flex; flex-direction:column; gap:16px; }
  .form-row{ display:flex; flex-direction:column; gap:6px; }
  .modal-actions{ display:flex; justify-content:flex-end; gap:12px; }
  .loading{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(255,255,255,0.75); z-index:1500; font-weight:600; font-size:1rem; color:#1f2937; }
  .loading.hidden{ display:none; }
  .loading-box{ background:#fff; border-radius:14px; padding:12px 18px; display:flex; align-items:center; gap:10px; box-shadow:0 18px 40px rgba(15,23,42,0.18); }
  .spinner{ width:18px; height:18px; border-radius:50%; border:3px solid rgba(37,99,235,0.25); border-top-color:var(--brand); animation:spin .75s linear infinite; }
  .spinner.small{ width:14px; height:14px; border-width:2px; }
  @keyframes spin{ to { transform:rotate(360deg); } }
  .paid-leave-status{ display:flex; align-items:center; gap:8px; font-size:0.85rem; color:var(--muted); margin-top:8px; }
  .paid-leave-type-group.disabled{ opacity:0.6; pointer-events:none; }
  .toast{ position:fixed; left:50%; bottom:32px; transform:translateX(-50%); background:#1f2937; color:#fff; padding:10px 18px; border-radius:999px; font-size:0.9rem; box-shadow:0 12px 30px rgba(15,23,42,0.25); opacity:0; pointer-events:none; transition:opacity .3s ease; z-index:1600; }
  .toast.show{ opacity:1; }
  .auto-adjust-note{ margin-top:4px; font-size:0.8rem; color:#b91c1c; }
  .payslip-list{ display:flex; flex-direction:column; gap:12px; }
  .payslip-item{ display:flex; justify-content:space-between; align-items:center; gap:16px; padding:12px 16px; border:1px solid var(--border); border-radius:12px; background:#fff; }
  .payslip-info{ display:flex; flex-direction:column; gap:4px; }
  .payslip-title{ font-weight:600; }
  .payslip-meta{ font-size:0.85rem; color:var(--muted); }
  @media (max-width:768px){
    .attendance-table th.col-date,
    .attendance-table td.col-date{ width:110px; }
    .attendance-table th.col-time,
    .attendance-table td.col-time{ width:78px; }
    .attendance-table th.col-work,
    .attendance-table td.col-work,
    .attendance-table th.col-break,
    .attendance-table td.col-break{ width:74px; }
    .attendance-table th.col-breakdown,
    .attendance-table td.col-breakdown{ width:14%; }
    .attendance-table th.col-source,
    .attendance-table td.col-source{ width:12%; }
    .attendance-table th.col-request,
    .attendance-table td.col-request{ width:130px; }
    .attendance-table th.col-actions,
    .attendance-table td.col-actions{ width:120px; }
    .attendance-table td.col-actions .btn{ min-width:110px; }
  }
  @media (max-width:640px){
    th,td{ font-size:0.85rem; padding:8px 6px; }
    .btn{ padding:7px 12px; font-size:0.85rem; }
    .header-controls{ flex-direction:column; align-items:flex-start; }
    .header-actions{ width:100%; justify-content:flex-start; }
    .paid-leave-widget{ width:100%; }
    .dialog{ padding:16px; }
    select,input,textarea{ font-size:0.9rem; padding:8px; }
    .modal-actions{ flex-direction:column; }
    .modal-actions .btn{ width:100%; }
  }
</style>
</head>
<body>
<div class="wrap">
  <header class="header">
    <div class="header-main">
      <h1>訪問スタッフ勤怠</h1>
      <div id="userInfo" class="muted"></div>
    </div>
    <div class="header-controls">
      <label class="control">
        <span>対象月</span>
        <select id="monthSelect" aria-label="対象月"></select>
      </label>
      <div id="summary" class="muted"></div>
      <div class="header-actions">
        <button id="openPaidLeaveButton" class="btn" type="button">有給申請</button>
        <div id="paidLeaveWidget" class="paid-leave-widget" hidden></div>
      </div>
    </div>
  </header>

  <div class="tab-nav" role="tablist">
    <button class="tab-button active" type="button" data-tab-target="attendance">勤怠</button>
    <button class="tab-button" type="button" data-tab-target="payslip">給与明細を見る</button>
  </div>

  <section class="card tab-panel" data-tab-panel="attendance">
    <div class="card-header">
      <h2>勤怠一覧</h2>
      <div id="monthNotice" class="muted"></div>
    </div>
    <div id="attendanceTable"></div>
    <div class="table-note">退勤は18:00まで・15分単位。休憩時間も15分単位で申請してください。</div>
  </section>

  <section class="card tab-panel" data-tab-panel="attendance">
    <h2>申請履歴</h2>
    <div id="requestHistory" class="muted">読み込み中…</div>
  </section>

  <section class="card tab-panel" data-tab-panel="attendance" id="adminPanel" hidden>
    <h2>管理者：申請承認</h2>
    <div class="admin-section">
      <h3>勤怠修正申請</h3>
      <div id="adminCorrectionRequests" class="muted">読み込み中…</div>
    </div>
    <div class="admin-section">
      <h3>有給申請</h3>
      <div id="adminPaidLeaveRequests" class="muted">読み込み中…</div>
    </div>
  </section>

  <section class="card tab-panel tab-panel--hidden" id="payslipPanel" data-tab-panel="payslip">
    <div class="card-header">
      <h2>給与明細</h2>
      <div class="header-actions">
        <button id="payslipReloadButton" class="btn ghost" type="button">再読み込み</button>
      </div>
    </div>
    <div id="payslipStatus" class="muted"></div>
    <div id="payslipList" class="payslip-list muted">読み込み中…</div>
  </section>
</div>

<div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <div class="dialog">
    <h3 id="modalTitle">勤怠修正申請</h3>
    <form id="modalForm">
      <div class="form-row">
        <label>対象日</label>
        <div id="modalDate" class="muted"></div>
      </div>
      <div class="form-row">
        <label for="modalEnd">退勤時刻</label>
        <input id="modalEnd" type="time" required />
      </div>
      <div class="form-row">
        <label for="modalBreak">休憩時間</label>
        <select id="modalBreak"></select>
      </div>
      <div class="form-row">
        <label for="modalNote">申請理由</label>
        <textarea id="modalNote" placeholder="修正が必要な理由を記入してください" required></textarea>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn ghost" onclick="closeModal()">キャンセル</button>
        <button type="submit" class="btn">申請を送信</button>
      </div>
    </form>
  </div>
</div>

<div id="paidLeaveModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="paidLeaveModalTitle">
  <div class="dialog">
    <h3 id="paidLeaveModalTitle">有給申請</h3>
    <form id="paidLeaveForm">
      <div class="form-row">
        <label for="paidLeaveDate">取得日</label>
        <input id="paidLeaveDate" type="date" required />
      </div>
      <div class="form-row">
        <label>取得種別</label>
        <div class="paid-leave-type-group" id="paidLeaveTypeGroup">
          <label class="paid-leave-type-option"><input type="radio" name="paidLeaveType" value="full" checked />全日</label>
          <label class="paid-leave-type-option"><input type="radio" name="paidLeaveType" value="amHalf" />半日（午前）</label>
          <label class="paid-leave-type-option"><input type="radio" name="paidLeaveType" value="pmHalf" />半日（午後）</label>
        </div>
        <div id="paidLeaveHalfNotice" class="paid-leave-error" hidden></div>
      </div>
      <div id="paidLeaveInfo" class="paid-leave-info" hidden>
        <div class="paid-leave-info-line"><span>所定勤務時間</span><strong id="paidLeaveShiftText"></strong></div>
        <div class="paid-leave-info-line"><span>有給計上</span><strong id="paidLeaveWorkText"></strong></div>
        <div class="paid-leave-info-line"><span>半休目安</span><strong id="paidLeaveHalfText"></strong></div>
      </div>
      <div id="paidLeavePlanStatus" class="paid-leave-status" hidden aria-live="polite">
        <span class="spinner small" aria-hidden="true"></span>
        <span>取得日の勤務時間を計算中です…</span>
      </div>
      <div id="paidLeavePlanError" class="paid-leave-error" hidden></div>
      <div class="form-row">
        <label for="paidLeaveReason">理由（任意）</label>
        <textarea id="paidLeaveReason" placeholder="任意で記入できます"></textarea>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn ghost" onclick="closePaidLeaveModal()">キャンセル</button>
        <button type="submit" class="btn">申請を送信</button>
      </div>
    </form>
  </div>
</div>

<div id="loading" class="loading hidden" role="status" aria-live="polite">
  <div class="loading-box"><span class="spinner" aria-hidden="true"></span><span id="loadingText">読み込み中…</span></div>
</div>
<div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
const MONTH_STORAGE_KEY = 'visitAttendance.selectedMonth';
const WEEKDAYS = ['日','月','火','水','木','金','土'];
const LEGACY_SERIAL_DATE_PATTERN = /(1899|1900)/;

let state = { data: null, selectedMonth: null, requestDate: null, paidLeaveDate: null, paidLeavePlan: null, paidLeavePlanToken: 0, activeTab: 'attendance' };

function getSavedMonthKey(){
  try {
    return localStorage.getItem(MONTH_STORAGE_KEY) || null;
  } catch (err){
    console.warn('[attendance] Failed to read saved month', err);
    return null;
  }
}

function saveSelectedMonth(key){
  try {
    if (key){
      localStorage.setItem(MONTH_STORAGE_KEY, key);
    } else {
      localStorage.removeItem(MONTH_STORAGE_KEY);
    }
  } catch (err){
    console.warn('[attendance] Failed to store month', err);
  }
}

function isValidMonthKey(months, key){
  if (!key || !Array.isArray(months)) return false;
  return months.some(month => month && month.key === key);
}

function setLoading(active, text){
  const el = document.getElementById('loading');
  const label = document.getElementById('loadingText');
  if (text) label.textContent = text;
  el.classList.toggle('hidden', !active);
}

function showToast(message){
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.classList.add('show');
  setTimeout(()=> toast.classList.remove('show'), 2600);
}

function init(){
  setLoading(true, '読み込み中…');
  google.script.run
    .withSuccessHandler(data => {
      const months = Array.isArray(data && data.months) ? data.months : [];
      const defaultMonth = data && data.month ? data.month.key : null;
      const savedMonth = getSavedMonthKey();
      const initialMonth = isValidMonthKey(months, savedMonth) ? savedMonth : defaultMonth;

      if (!isValidMonthKey(months, savedMonth) && savedMonth){
        saveSelectedMonth(null);
      }

      state.data = data;
      state.selectedMonth = initialMonth || null;
      renderAll();
      setLoading(false);

      if (state.selectedMonth){
        if (state.selectedMonth !== defaultMonth){
          loadMonth(state.selectedMonth);
        } else {
          saveSelectedMonth(state.selectedMonth);
        }
      }
    })
    .withFailureHandler(err => {
      setLoading(false);
      alert(err && err.message ? err.message : err);
    })
    .getVisitAttendancePortalData({});
}

document.getElementById('monthSelect').addEventListener('change', event => {
  const value = event.target.value;
  state.selectedMonth = value;
  saveSelectedMonth(value);
  loadMonth(value);
});

document.getElementById('modalForm').addEventListener('submit', event => {
  event.preventDefault();
  submitRequest();
});

const paidLeaveForm = document.getElementById('paidLeaveForm');
if (paidLeaveForm) {
  paidLeaveForm.addEventListener('submit', event => {
    event.preventDefault();
    submitPaidLeave();
  });
}

const paidLeaveButton = document.getElementById('openPaidLeaveButton');
if (paidLeaveButton) {
  paidLeaveButton.addEventListener('click', openPaidLeaveModal);
}

const paidLeaveTypeInputs = document.querySelectorAll('input[name="paidLeaveType"]');
if (paidLeaveTypeInputs.length) {
  paidLeaveTypeInputs.forEach(input => {
    input.addEventListener('change', handlePaidLeaveTypeChange);
  });
}
const paidLeaveDateField = document.getElementById('paidLeaveDate');
if (paidLeaveDateField) {
  paidLeaveDateField.addEventListener('change', handlePaidLeaveFieldChange);
}

document.querySelectorAll('[data-tab-target]').forEach(button => {
  button.addEventListener('click', () => {
    const target = button.getAttribute('data-tab-target');
    setActiveTab(target);
  });
});

const payslipReloadButton = document.getElementById('payslipReloadButton');
if (payslipReloadButton) {
  payslipReloadButton.addEventListener('click', () => {
    loadMonth(state.selectedMonth || (state.data && state.data.month ? state.data.month.key : null));
  });
}

function loadMonth(monthKey){
  setLoading(true, '読み込み中…');
  google.script.run
    .withSuccessHandler(data => {
      state.data = data;
      const months = Array.isArray(data && data.months) ? data.months : [];
      const resolvedMonth = data && data.month ? data.month.key : monthKey;
      if (isValidMonthKey(months, resolvedMonth)){
        state.selectedMonth = resolvedMonth;
        saveSelectedMonth(resolvedMonth);
      } else {
        state.selectedMonth = resolvedMonth;
        saveSelectedMonth(null);
      }
      renderAll();
      setLoading(false);
    })
    .withFailureHandler(err => {
      setLoading(false);
      alert(err && err.message ? err.message : err);
    })
    .getVisitAttendancePortalData({ month: monthKey });
}

function renderAll(){
  if (!state.data) return;
  updateTabVisibility();
  renderUser();
  renderMonthSelect();
  renderSummary();
  renderPaidLeaveWidget();
  renderAttendance();
  renderHistory();
  renderAdmin();
  renderPayslipPanel();
}

function setActiveTab(tab){
  const next = tab || 'attendance';
  if (state.activeTab === next) {
    updateTabVisibility();
    return;
  }
  state.activeTab = next;
  updateTabVisibility();
}

function updateTabVisibility(){
  const current = state.activeTab || 'attendance';
  document.querySelectorAll('[data-tab-target]').forEach(button => {
    const target = button.getAttribute('data-tab-target');
    button.classList.toggle('active', target === current);
  });
  document.querySelectorAll('[data-tab-panel]').forEach(panel => {
    const target = panel.getAttribute('data-tab-panel');
    panel.classList.toggle('tab-panel--hidden', target !== current);
  });
}

function renderUser(){
  const info = document.getElementById('userInfo');
  const user = state.data.user || {};
  const name = user.displayName || '';
  const email = user.email || '';
  const profile = user.staffProfile || {};
  const employmentLabel = profile.employmentLabel || user.employmentLabel || '';
  const parts = [];
  if (name && email) {
    parts.push(`${name} (${email})`);
  } else if (email) {
    parts.push(email);
  } else if (name) {
    parts.push(name);
  }
  if (employmentLabel) {
    parts.push(`区分: ${employmentLabel}`);
  }
  info.textContent = parts.join(' / ');
}

function renderMonthSelect(){
  const select = document.getElementById('monthSelect');
  const months = state.data.months || [];
  const current = state.selectedMonth != null ? state.selectedMonth : (state.data.month ? state.data.month.key : null);
  select.innerHTML = months.map(m => `<option value="${m.key}" ${m.key === current ? 'selected' : ''}>${m.label}</option>`).join('');
}

function renderSummary(){
  const el = document.getElementById('summary');
  const totals = state.data.totals || {};
  const days = totals.days != null ? `${totals.days}日` : '-';
  const work = totals.workText || '-';
  const rest = totals.breakText || '-';
  el.textContent = `稼働日数: ${days} / 勤務時間: ${work} / 休憩: ${rest}`;
}

function renderPaidLeaveWidget(){
  const widget = document.getElementById('paidLeaveWidget');
  if (!widget) return;
  const info = state.data.paidLeave;
  if (!info) {
    widget.hidden = true;
    widget.innerHTML = '';
    return;
  }
  widget.hidden = false;
  const employmentLabel = state.data.user && state.data.user.staffProfile && state.data.user.staffProfile.employmentLabel
    ? state.data.user.staffProfile.employmentLabel
    : '';
  const remainingRaw = Number(info.remainingDays);
  const remaining = Number.isFinite(remainingRaw) ? remainingRaw : (Number(info.remaining) || 0);
  const usedRaw = Number(info.usedDays);
  const used = Number.isFinite(usedRaw) ? usedRaw : 0;
  const quotaRaw = Number(info.quotaDays);
  const quota = Number.isFinite(quotaRaw) ? quotaRaw : used + remaining;
  const remainingDisplay = Math.max(0, Math.round(remaining));
  const usedDisplay = Math.max(0, Math.round(used));
  const quotaDisplay = Math.max(0, Math.round(quota));
  const year = info.year || new Date().getFullYear();
  const required = info.requiredDays != null ? Number(info.requiredDays) : null;
  widget.innerHTML = `
    <div>有給残：<strong>${remainingDisplay}</strong>日</div>
    <div class="paid-leave-widget-meta">取得 ${usedDisplay}日 / 付与 ${quotaDisplay}日（${year}年）</div>
    ${employmentLabel ? `<div class="paid-leave-widget-meta">勤務区分：${employmentLabel}</div>` : ''}
    ${required != null ? `<div class="paid-leave-widget-meta">義務取得 ${required}日</div>` : ''}
  `;
}

function renderAttendance(){
  const container = document.getElementById('attendanceTable');
  const monthNotice = document.getElementById('monthNotice');
  const data = state.data;
  const month = data.month || {};
  const attendance = normalizeAttendanceRecords(data.attendance || []);
  monthNotice.textContent = month.canRequest ? 'この月の勤怠は修正申請できます（前月分まで）' : '当月は閲覧のみです。修正申請は前月分まで受付。';
  if (!attendance.length){
    container.innerHTML = '<div class="muted">対象月の勤怠データがありません。</div>';
    return;
  }
    const rows = attendance.map(record => {
      const req = record.request;
      const status = req ? req.status : '';
      const statusLabel = req ? req.statusLabel : '';
      const statusClass = status ? `status-badge--${status}` : '';
      const statusNote = req && req.statusNote ? `<div class="muted">${escapeHtml(req.statusNote)}</div>` : '';
      const requestCell = req
        ? `<div class="badge ${statusClass}">${escapeHtml(statusLabel)}</div>${statusNote}`
        : '<span class="muted">-</span>';
      const button = month.canRequest
        ? `<button class="btn btn-sm" ${status === 'pending' ? 'disabled' : ''} data-date="${record.date}">申請</button>`
        : '';
      const sourceLabel = escapeHtml(record.sourceLabel || '');
      const autoNote = record.autoAdjustmentMessage ? `<div class="auto-adjust-note">${escapeHtml(record.autoAdjustmentMessage)}</div>` : '';
      const sourceCell = sourceLabel + autoNote;
      const { primary: datePrimary, secondary: dateSecondary } = formatAttendanceDateParts(record);
      const startLabel = formatTimeDisplay(record.start);
      const endLabel = formatTimeDisplay(record.end);
      const workLabel = formatTimeDisplay(record.work);
      const breakLabel = formatBreakDisplay(record);
      const dateCell = `
        <div class="date-primary">${escapeHtml(datePrimary || record.displayDate || record.date || '')}</div>
        ${dateSecondary ? `<div class="date-sub muted">${escapeHtml(dateSecondary)}</div>` : (record.weekday ? `<div class="date-sub muted">（${escapeHtml(record.weekday)}）</div>` : '')}
      `;
      const startCell = startLabel ? escapeHtml(startLabel) : '<span class="muted">--:--</span>';
      const endCell = endLabel ? escapeHtml(endLabel) : '<span class="muted">--:--</span>';
      const workCell = workLabel ? escapeHtml(workLabel) : '<span class="muted">--</span>';
      const breakCell = breakLabel ? escapeHtml(breakLabel) : '<span class="muted">--</span>';
      return `<tr>
        <td class="col-date date-cell">${dateCell}</td>
        <td class="col-time time-cell">${startCell}</td>
        <td class="col-time time-cell">${endCell}</td>
        <td class="col-work time-cell">${workCell}</td>
        <td class="col-break time-cell">${breakCell}</td>
        <td class="col-breakdown">${escapeHtml(record.breakdown || '')}</td>
        <td class="col-source">${sourceCell}</td>
        <td class="col-request">${requestCell}</td>
        <td class="col-actions">${month.canRequest ? button : ''}</td>
      </tr>`;
    }).join('');
  container.innerHTML = `<div class="table-wrapper"><table class="attendance-table">
    <thead><tr><th class="col-date">日付</th><th class="col-time">出勤</th><th class="col-time">退勤</th><th class="col-work">勤務</th><th class="col-break">休憩</th><th class="col-breakdown">種別内訳</th><th class="col-source">区分</th><th class="col-request">申請状況</th><th class="col-actions">${month.canRequest ? '操作' : ''}</th></tr></thead>
    <tbody>${rows}</tbody>
  </table></div>`;
  if (month.canRequest){
    container.querySelectorAll('button[data-date]').forEach(btn => {
      btn.addEventListener('click', () => openModal(btn.getAttribute('data-date')));
    });
  }
}

function renderHistory(){
  const container = document.getElementById('requestHistory');
  const requests = state.data.requests || [];
  if (!requests.length){
    container.innerHTML = '<div class="muted">この月の申請履歴はありません。</div>';
    return;
  }
  const items = requests.map(req => {
    const badgeClass = `badge status-badge--${req.status}`;
    const adminNote = req.statusNote ? `<div class="history-note muted">対応メモ: ${escapeHtml(req.statusNote)}</div>` : '';
    const isPaidLeave = req.type === 'paidLeave' || req.type === 'paidleave';
    const typeLabel = req.typeLabel || (isPaidLeave ? '有給申請' : '勤怠修正申請');
    const paidLeaveDetail = req.paidLeaveDetail || null;
    const endLabel = formatTimeDisplay(req.end);
    const breakLabel = formatTimeDisplay(req.breakText || req.breakMinutes);
    const detail = isPaidLeave
      ? `有給（${escapeHtml(paidLeaveDetail && paidLeaveDetail.leaveLabel ? paidLeaveDetail.leaveLabel : '全日')} / ${escapeHtml(paidLeaveDetail && paidLeaveDetail.workText ? paidLeaveDetail.workText : '-')}` + '）'
      : `退勤 ${escapeHtml(endLabel || '-')} / 休憩 ${escapeHtml(breakLabel || '-')}`;
    const weekday = req.targetWeekday || '';
    const shiftMeta = isPaidLeave && paidLeaveDetail && paidLeaveDetail.shiftText
      ? `<span>所定: ${escapeHtml(paidLeaveDetail.shiftText)}</span>`
      : '';
    let noteContent = '';
    if (req.note) {
      noteContent = `<div class="history-note">${escapeHtml(req.note)}</div>`;
    } else if (isPaidLeave) {
      noteContent = '<div class="history-note muted">申請理由なし</div>';
    }
    return `<div class="history-item">
      <strong>${req.targetDate} ${weekday ? '（' + weekday + '）' : ''}</strong>
      <div class="history-meta">
        <span class="${badgeClass}">${req.statusLabel}</span>
        <span>${escapeHtml(typeLabel)}</span>
        <span>${escapeHtml(detail)}</span>
        <span>申請日時: ${req.createdAtText || '-'}</span>
        ${req.statusUpdatedAtText ? `<span>最終更新: ${req.statusUpdatedAtText}</span>` : ''}
        ${shiftMeta}
      </div>
      ${noteContent}
      ${adminNote}
    </div>`;
  }).join('');
  container.innerHTML = `<div class="history-list">${items}</div>`;
}

function renderAdmin(){
  const panel = document.getElementById('adminPanel');
  const admin = state.data.admin;
  const correctionContainer = document.getElementById('adminCorrectionRequests');
  const paidLeaveContainer = document.getElementById('adminPaidLeaveRequests');
  if (!panel || !correctionContainer || !paidLeaveContainer) return;
  if (!admin) {
    panel.hidden = true;
    return;
  }
  panel.hidden = false;
  renderAdminCorrectionRequests(admin.correctionRequests || []);
  renderAdminPaidLeaveRequests(admin.paidLeaveRequests || []);
}

function renderPayslipPanel(){
  const list = document.getElementById('payslipList');
  const status = document.getElementById('payslipStatus');
  if (!list || !status) return;
  const payroll = state.data && state.data.payroll ? state.data.payroll : null;
  if (!payroll) {
    status.textContent = '給与明細を取得できませんでした。';
    list.innerHTML = '';
    return;
  }
  if (!payroll.available) {
    status.textContent = payroll.restrictedReason || '給与明細を閲覧する権限がありません。';
    list.innerHTML = '';
    return;
  }
  status.textContent = payroll.message || '';
  const payslips = Array.isArray(payroll.payslips) ? payroll.payslips : [];
  if (!payslips.length) {
    list.innerHTML = '<div class="muted">閲覧可能な給与明細はまだありません。</div>';
    return;
  }
  list.innerHTML = payslips.map(item => {
    const title = escapeHtml(item.monthHint || item.name || '給与明細');
    const issued = item.createdAtText ? `発行: ${escapeHtml(item.createdAtText)}` : '';
    const updated = item.updatedAtText && item.updatedAtText !== item.createdAtText
      ? `更新: ${escapeHtml(item.updatedAtText)}`
      : '';
    const size = item.sizeText ? `サイズ: ${escapeHtml(item.sizeText)}` : '';
    return `
      <div class="payslip-item">
        <div class="payslip-info">
          <div class="payslip-title">${title}</div>
          ${issued ? `<div class="payslip-meta">${issued}</div>` : ''}
          ${updated ? `<div class="payslip-meta">${updated}</div>` : ''}
          ${size ? `<div class="payslip-meta">${size}</div>` : ''}
        </div>
        <a class="btn btn-sm" href="${item.url}" target="_blank" rel="noopener">開く</a>
      </div>`;
  }).join('');
}

function renderAdminCorrectionRequests(requests){
  const container = document.getElementById('adminCorrectionRequests');
  if (!container) return;
  if (!Array.isArray(requests) || !requests.length){
    container.innerHTML = '<div class="muted">保留中の申請はありません。</div>';
    return;
  }
  const rows = requests.map(req => {
    const selectId = `status-${req.id}`;
    const noteId = `note-${req.id}`;
    return `<tr>
      <td>${escapeHtml(req.targetDate)}<div class="muted">${escapeHtml(req.targetWeekday||'')}</div></td>
      <td>${escapeHtml(req.targetEmail || '')}</td>
      <td>退勤 ${escapeHtml(formatTimeDisplay(req.end) || '-')}<br>休憩 ${escapeHtml(formatTimeDisplay(req.breakText || req.breakMinutes) || '-')}</td>
      <td>${escapeHtml(req.note || '')}</td>
      <td><select id="${selectId}">
        <option value="pending" ${req.status==='pending'?'selected':''}>申請中</option>
        <option value="approved">承認</option>
        <option value="rejected">差し戻し</option>
      </select>
      <textarea id="${noteId}" placeholder="対応メモ"></textarea>
      </td>
      <td><button class="btn" onclick="handleAdminUpdate('${req.id}')">更新</button></td>
    </tr>`;
  }).join('');
  container.innerHTML = `<div class="table-wrapper admin-table"><table>
    <thead><tr><th>対象日</th><th>スタッフ</th><th>希望内容</th><th>申請理由</th><th>対応</th><th>操作</th></tr></thead>
    <tbody>${rows}</tbody>
  </table></div>`;
}

function renderAdminPaidLeaveRequests(requests){
  const container = document.getElementById('adminPaidLeaveRequests');
  if (!container) return;
  if (!Array.isArray(requests) || !requests.length){
    container.innerHTML = '<div class="muted">保留中の有給申請はありません。</div>';
    return;
  }
  const rows = requests.map(req => {
    const noteId = `paidleave-note-${req.id}`;
    const reason = req.note ? escapeHtml(req.note) : '<span class="muted">理由なし</span>';
    const detail = req.paidLeaveDetail || null;
    const leaveSummary = detail
      ? `${escapeHtml(detail.leaveLabel || '有給')} / ${escapeHtml(detail.workText || '-')}`
      : '有給';
    const shiftLine = detail && detail.shiftText ? `<div class="muted">所定: ${escapeHtml(detail.shiftText)}</div>` : '';
    return `<tr>
      <td>${escapeHtml(req.targetDate)}<div class="muted">${escapeHtml(req.targetWeekday||'')}</div></td>
      <td>${escapeHtml(req.targetEmail || '')}</td>
      <td>${leaveSummary}${shiftLine}</td>
      <td>${reason}</td>
      <td>
        <textarea id="${noteId}" class="admin-paidleave-note" placeholder="対応メモ"></textarea>
        <div class="admin-actions">
          <button class="btn" onclick="handlePaidLeaveApprove('${req.id}')">承認</button>
          <button class="btn ghost" onclick="handlePaidLeaveReject('${req.id}')">却下</button>
        </div>
      </td>
    </tr>`;
  }).join('');
  container.innerHTML = `<div class="table-wrapper admin-table"><table>
    <thead><tr><th>対象日</th><th>スタッフ</th><th>取得内容</th><th>申請理由</th><th>対応</th></tr></thead>
    <tbody>${rows}</tbody>
  </table></div>`;
}

function getSelectedPaidLeaveType(){
  const selected = document.querySelector('input[name="paidLeaveType"]:checked');
  return selected ? selected.value : 'full';
}

function handlePaidLeaveTypeChange(){
  refreshPaidLeavePreview();
}

function handlePaidLeaveFieldChange(){
  refreshPaidLeavePreview();
}

function refreshPaidLeavePreview(){
  const dateInput = document.getElementById('paidLeaveDate');
  const dateValue = dateInput ? dateInput.value : '';
  const type = getSelectedPaidLeaveType();
  state.paidLeavePlan = null;
  if (!dateValue) {
    state.paidLeavePlan = null;
    updatePaidLeaveInfo(null, { message: '取得日を選択してください' });
    return;
  }
  const token = Date.now();
  state.paidLeavePlanToken = token;
  updatePaidLeaveInfo(null, { loading: true });
  google.script.run
    .withSuccessHandler(response => {
      if (state.paidLeavePlanToken !== token) return;
      if (!response || !response.ok) {
        updatePaidLeaveInfo(null, { error: response && response.error ? response.error : 'プレビューに失敗しました' });
        return;
      }
      state.paidLeavePlan = response.plan || null;
      updatePaidLeaveInfo(state.paidLeavePlan, { blockedReason: response.blockedReason || '' });
    })
    .withFailureHandler(err => {
      if (state.paidLeavePlanToken !== token) return;
      state.paidLeavePlan = null;
      updatePaidLeaveInfo(null, { error: err && err.message ? err.message : String(err) });
    })
    .previewPaidLeavePlan({ date: dateValue, type });
}

function updatePaidLeaveInfo(plan, options){
  const infoBox = document.getElementById('paidLeaveInfo');
  const shiftText = document.getElementById('paidLeaveShiftText');
  const workText = document.getElementById('paidLeaveWorkText');
  const halfText = document.getElementById('paidLeaveHalfText');
  const errorBox = document.getElementById('paidLeavePlanError');
  const halfNotice = document.getElementById('paidLeaveHalfNotice');
  const statusBox = document.getElementById('paidLeavePlanStatus');
  const submitButton = document.querySelector('#paidLeaveForm button[type="submit"]');
  const isLoading = options && options.loading;
  const errorMessage = options && options.error;
  const helperMessage = options && options.message;
  const blockedReason = options && options.blockedReason;
  const dateInput = document.getElementById('paidLeaveDate');
  const typeInputs = document.querySelectorAll('input[name="paidLeaveType"]');
  const typeGroup = document.getElementById('paidLeaveTypeGroup');
  const halfInputs = document.querySelectorAll('input[name="paidLeaveType"][value="amHalf"], input[name="paidLeaveType"][value="pmHalf"]');

  if (submitButton) {
    submitButton.disabled = true;
  }
  if (dateInput) {
    dateInput.disabled = false;
  }
  typeInputs.forEach(input => {
    input.disabled = false;
  });
  if (typeGroup) {
    typeGroup.classList.remove('disabled');
  }
  if (infoBox) {
    infoBox.hidden = true;
  }
  if (errorBox) {
    errorBox.hidden = true;
    errorBox.textContent = '';
  }
  if (halfNotice) {
    halfNotice.hidden = true;
    halfNotice.textContent = '';
  }
  if (statusBox) {
    statusBox.hidden = true;
  }
  halfInputs.forEach(input => {
    input.disabled = false;
  });

  if (isLoading) {
    if (dateInput) {
      dateInput.disabled = true;
    }
    typeInputs.forEach(input => {
      input.disabled = true;
    });
    if (typeGroup) {
      typeGroup.classList.add('disabled');
    }
    if (statusBox) {
      statusBox.hidden = false;
    }
    if (infoBox) {
      infoBox.hidden = true;
    }
    return;
  }

  if (errorMessage) {
    if (errorBox) {
      errorBox.hidden = false;
      errorBox.textContent = errorMessage;
    }
    return;
  }

  if (helperMessage && !plan) {
    if (errorBox) {
      errorBox.hidden = false;
      errorBox.textContent = helperMessage;
    }
    return;
  }

  if (!plan) {
    return;
  }

  if (infoBox) {
    infoBox.hidden = false;
  }
  if (shiftText) {
    shiftText.textContent = plan.shiftText || '—';
  }
  if (workText) {
    workText.textContent = plan.workText || '—';
  }
  if (halfText) {
    halfText.textContent = plan.halfWorkText || '—';
  }

  const halfAllowed = !!plan.halfAvailable;
  halfInputs.forEach(input => {
    input.disabled = !halfAllowed;
  });
  if (!halfAllowed) {
    if (halfNotice) {
      halfNotice.hidden = false;
      halfNotice.textContent = 'この日の所定勤務時間では半休を取得できません。';
    }
    const selectedType = getSelectedPaidLeaveType();
    if (selectedType === 'amHalf' || selectedType === 'pmHalf') {
      const fullInput = document.querySelector('input[name="paidLeaveType"][value="full"]');
      if (fullInput) {
        if (!fullInput.checked) {
          fullInput.checked = true;
          state.paidLeavePlan = null;
          refreshPaidLeavePreview();
          return;
        }
      }
    }
  }
  if (blockedReason && (getSelectedPaidLeaveType() === 'amHalf' || getSelectedPaidLeaveType() === 'pmHalf')) {
    if (errorBox) {
      errorBox.hidden = false;
      errorBox.textContent = blockedReason;
    }
    if (submitButton) {
      submitButton.disabled = true;
    }
    return;
  }

  if (submitButton) {
    submitButton.disabled = false;
  }
}

function openModal(date){
  const modal = document.getElementById('modal');
  const record = (state.data.attendance || []).find(r => r.date === date);
  state.requestDate = date;
  const policy = state.data.policy || {};
  const endInput = document.getElementById('modalEnd');
  endInput.min = policy.workStart || '09:00';
  endInput.max = policy.workEndLimit || '18:00';
  const step = Number(policy.roundingMinutes || 15) * 60;
  endInput.step = step > 0 ? step : 900;
  const endValue = record && record.end ? formatTimeDisplay(record.end) : '';
  endInput.value = endValue || policy.workEndLimit || '18:00';
  populateBreakOptions(record ? record.breakMinutes : 0, policy);
  document.getElementById('modalNote').value = '';
  const weekday = record ? record.weekday : '';
  document.getElementById('modalDate').textContent = `${date}${weekday ? '（' + weekday + '）' : ''}`;
  modal.classList.add('open');
}

function populateBreakOptions(currentMinutes, policy){
  const select = document.getElementById('modalBreak');
  let rounding = Number(policy.roundingMinutes);
  if (!Number.isFinite(rounding) || rounding <= 0) rounding = 15;
  const maxMinutes = 180;
  const options = [];
  for (let minutes = 0; minutes <= maxMinutes; minutes += rounding){
    const label = minutes === 0 ? 'なし (0分)' : formatMinutes(minutes);
    options.push(`<option value="${minutes}" ${minutes === Number(currentMinutes) ? 'selected' : ''}>${label}</option>`);
  }
  select.innerHTML = options.join('');
}

function closeModal(){
  document.getElementById('modal').classList.remove('open');
  state.requestDate = null;
}

function submitRequest(){
  if (!state.requestDate) return;
  const endValue = document.getElementById('modalEnd').value;
  const breakValue = Number(document.getElementById('modalBreak').value || '0');
  const note = document.getElementById('modalNote').value.trim();
  setLoading(true, '申請を送信中…');
  google.script.run
    .withSuccessHandler(() => {
      setLoading(false);
      closeModal();
      showToast('申請を受け付けました');
      loadMonth(state.selectedMonth);
    })
    .withFailureHandler(err => {
      setLoading(false);
      alert(err && err.message ? err.message : err);
    })
    .submitVisitAttendanceRequest({ targetDate: state.requestDate, endTime: endValue, breakMinutes: breakValue, note });
}

function openPaidLeaveModal(){
  const modal = document.getElementById('paidLeaveModal');
  if (!modal) return;
  const dateInput = document.getElementById('paidLeaveDate');
  const reasonInput = document.getElementById('paidLeaveReason');
  const today = new Date();
  const minDate = new Date(today.getFullYear(), today.getMonth(), 1);
  state.paidLeavePlan = null;
  state.paidLeavePlanToken = 0;
  const fullType = document.querySelector('input[name="paidLeaveType"][value="full"]');
  if (fullType) {
    fullType.checked = true;
  }
  updatePaidLeaveInfo(null, { message: '取得日を選択してください' });
  if (dateInput) {
    dateInput.min = formatDateInput(minDate);
    let defaultDate = today;
    if (state.paidLeaveDate) {
      const saved = new Date(state.paidLeaveDate);
      if (!isNaN(saved.getTime())) {
        defaultDate = saved;
      }
    }
    dateInput.value = formatDateInput(defaultDate);
  }
  if (reasonInput) {
    reasonInput.value = '';
  }
  modal.classList.add('open');
  refreshPaidLeavePreview();
}

function closePaidLeaveModal(){
  const modal = document.getElementById('paidLeaveModal');
  if (modal) {
    modal.classList.remove('open');
  }
  state.paidLeavePlan = null;
}

function submitPaidLeave(){
  const dateInput = document.getElementById('paidLeaveDate');
  if (!dateInput) return;
  const dateValue = dateInput.value;
  if (!dateValue) {
    alert('有給申請の日付を選択してください');
    return;
  }
  const selectedType = getSelectedPaidLeaveType();
  if (!state.paidLeavePlan || state.paidLeavePlan.leaveType !== selectedType) {
    alert('有給の計算が完了するまでお待ちください');
    return;
  }
  if ((selectedType === 'amHalf' || selectedType === 'pmHalf') && !state.paidLeavePlan.halfAvailable) {
    alert('この日の所定勤務時間では半休を取得できません');
    return;
  }
  const reasonInput = document.getElementById('paidLeaveReason');
  const reason = reasonInput ? reasonInput.value.trim() : '';
  state.paidLeaveDate = dateValue;
  setLoading(true, '有給申請を送信中…');
  google.script.run
    .withSuccessHandler(() => {
      setLoading(false);
      closePaidLeaveModal();
      showToast('有給申請を受け付けました');
      loadMonth(state.selectedMonth);
    })
    .withFailureHandler(err => {
      setLoading(false);
      alert(err && err.message ? err.message : err);
    })
    .submitPaidLeaveRequest({ date: dateValue, note: reason, leaveType: selectedType });
}

function handleAdminUpdate(id){
  const select = document.getElementById(`status-${id}`);
  const note = document.getElementById(`note-${id}`);
  if (!select) return;
  const status = select.value;
  setLoading(true, '更新中…');
  google.script.run
    .withSuccessHandler(() => {
      setLoading(false);
      showToast('申請を更新しました');
      loadMonth(state.selectedMonth);
    })
    .withFailureHandler(err => {
      setLoading(false);
      alert(err && err.message ? err.message : err);
    })
    .updateVisitAttendanceRequestStatus({ id, status, note: note ? note.value : '' });
}

function handlePaidLeaveApprove(id){
  handlePaidLeaveAction(id, 'approve');
}

function handlePaidLeaveReject(id){
  handlePaidLeaveAction(id, 'reject');
}

function handlePaidLeaveAction(id, action){
  if (!id) return;
  const noteField = document.getElementById(`paidleave-note-${id}`);
  const note = noteField ? noteField.value.trim() : '';
  setLoading(true, '更新中…');
  const runner = google.script.run
    .withSuccessHandler(() => {
      setLoading(false);
      showToast(action === 'approve' ? '有給申請を承認しました' : '有給申請を却下しました');
      loadMonth(state.selectedMonth);
    })
    .withFailureHandler(err => {
      setLoading(false);
      alert(err && err.message ? err.message : err);
    });
  if (action === 'approve') {
    runner.approvePaidLeaveRequest({ id, note });
  } else {
    runner.rejectPaidLeaveRequest({ id, note });
  }
}

function escapeHtml(str){
  return String(str || '')
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

function normalizeAttendanceRecords(records){
  if (!Array.isArray(records)) return [];
  const seen = new Set();
  const normalized = [];
  records.forEach(record => {
    if (!record) return;
    if (record.date){
      const key = `${String(record.date)}__${String(record.start || '')}`;
      if (seen.has(key)) return;
      seen.add(key);
    }
    normalized.push({
      ...record,
      start: formatTimeDisplay(record.start),
      end: formatTimeDisplay(record.end),
      work: formatTimeDisplay(record.work),
      break: formatTimeDisplay(record.break != null ? record.break : record.breakText)
    });
  });
  return normalized;
}

function formatAttendanceDateParts(record){
  const dateValue = record && (record.date || record.displayDate);
  const parsed = parseDateValue(dateValue);
  const weekday = record && record.weekday ? String(record.weekday) : '';
  if (!parsed) {
    return {
      primary: dateValue ? String(dateValue) : '',
      secondary: weekday ? `（${weekday}）` : ''
    };
  }
  const year = parsed.getFullYear();
  const month = String(parsed.getMonth() + 1).padStart(2, '0');
  const day = String(parsed.getDate()).padStart(2, '0');
  const iso = `${year}-${month}-${day}`;
  const short = `${parsed.getMonth() + 1}/${parsed.getDate()}`;
  const weekdayText = weekday || WEEKDAYS[parsed.getDay()] || '';
  return {
    primary: iso,
    secondary: weekdayText ? `${short}（${weekdayText}）` : short
  };
}

function formatBreakDisplay(record){
  if (!record) return '';
  const minutes = Number(record.breakMinutes);
  if (Number.isFinite(minutes) && minutes === 0){
    return '–';
  }
  const label = formatTimeDisplay(record.break);
  if (!label){
    if (Number.isFinite(minutes)){
      return minutes === 0 ? '–' : formatMinutesAsClock(minutes);
    }
    return '';
  }
  if ((label === '00:00' || label === '0:00') && Number.isFinite(minutes) && minutes === 0){
    return '–';
  }
  return label;
}

function parseDateValue(value){
  if (value instanceof Date && !isNaN(value.getTime())) {
    return new Date(value.getTime());
  }
  if (typeof value === 'number' && Number.isFinite(value)) {
    if (value > 1e10) {
      const date = new Date(value);
      if (!isNaN(date.getTime())) return date;
    }
  }
  const text = String(value || '').trim();
  if (!text) return null;
  const normalized = text.replace(/[\.]/g, '/');
  const parsed = new Date(normalized);
  if (!isNaN(parsed.getTime())) {
    return parsed;
  }
  const m = text.match(/^(\d{4})[\/-](\d{1,2})[\/-](\d{1,2})$/);
  if (m) {
    const year = Number(m[1]);
    const monthIndex = Number(m[2]) - 1;
    const day = Number(m[3]);
    if (Number.isFinite(year) && Number.isFinite(monthIndex) && Number.isFinite(day)) {
      return new Date(year, monthIndex, day);
    }
  }
  return null;
}

function formatTimeDisplay(value){
  if (value == null || value === '') return '';
  if (value instanceof Date && !isNaN(value.getTime())) {
    return formatDateToClock(value);
  }
  if (typeof value === 'number' && Number.isFinite(value)) {
    if (value > 1e10) {
      const date = new Date(value);
      if (!isNaN(date.getTime())) {
        return formatDateToClock(date);
      }
    }
    return formatMinutesAsClock(value);
  }
  const text = String(value).trim();
  if (!text) return '';
  const exact = text.match(/^(\d{1,2}):(\d{2})$/);
  if (exact) {
    return `${exact[1].padStart(2, '0')}:${exact[2]}`;
  }
  if (/^\d+$/.test(text)) {
    return formatMinutesAsClock(Number(text));
  }
  const parsedDate = new Date(text);
  if (!isNaN(parsedDate.getTime())) {
    return formatDateToClock(parsedDate);
  }
  const inlineMatch = text.match(/(\d{1,2}):(\d{2})/);
  if (inlineMatch) {
    return `${inlineMatch[1].padStart(2, '0')}:${inlineMatch[2]}`;
  }
  const legacyMatch = extractLegacyTime(text);
  if (legacyMatch) {
    return legacyMatch;
  }
  return text;
}

function extractLegacyTime(text){
  if (!text || !LEGACY_SERIAL_DATE_PATTERN.test(text)) return '';
  const match = text.match(/(\d{1,2}):(\d{2})(?::(\d{2}))?/);
  if (!match) return '';
  return `${match[1].padStart(2, '0')}:${match[2]}`;
}

function formatDateToClock(date){
  const hours = String(date.getHours()).padStart(2, '0');
  const minutes = String(date.getMinutes()).padStart(2, '0');
  return `${hours}:${minutes}`;
}

function formatMinutesAsClock(minutes){
  const total = Number(minutes);
  if (!Number.isFinite(total)) return '';
  const normalized = Math.max(0, Math.round(total));
  const hours = String(Math.floor(normalized / 60)).padStart(2, '0');
  const mins = String(normalized % 60).padStart(2, '0');
  return `${hours}:${mins}`;
}

function formatDateInput(date){
  if (!(date instanceof Date) || isNaN(date.getTime())) return '';
  const y = date.getFullYear();
  const m = String(date.getMonth() + 1).padStart(2, '0');
  const d = String(date.getDate()).padStart(2, '0');
  return `${y}-${m}-${d}`;
}

function formatMinutes(minutes){
  const total = Number(minutes) || 0;
  const h = Math.floor(total / 60);
  const m = total % 60;
  if (!h) return `${m}分`;
  if (!m) return `${h}時間`;
  return `${h}時間${m}分`;
}

init();
</script>
</body>
</html>
