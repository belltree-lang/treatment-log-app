<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>施術者ダッシュボード</title>
<style>
  :root{
    --bg:#0b1524;
    --card:#0f172a;
    --panel:#111827;
    --border:rgba(255,255,255,0.08);
    --text:#e5e7eb;
    --muted:#9ca3af;
    --accent:#38bdf8;
    --warning:#f59e0b;
    --critical:#ef4444;
    --success:#10b981;
  }
  *{ box-sizing:border-box; }
  body{ margin:0; font-family:system-ui,-apple-system,"Segoe UI","Noto Sans JP",sans-serif; background:var(--bg); color:var(--text); }
  a{ color:var(--accent); }
  .patient-link{ color:inherit; text-decoration:none; }
  .patient-link:hover{ text-decoration:underline; }
  .disabled{ opacity:0.55; cursor:not-allowed; pointer-events:none; }
  .page{ max-width:1080px; margin:0 auto; padding:20px 16px 64px; display:flex; flex-direction:column; gap:18px; }
  header{ display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
  h1{ margin:0; font-size:1.4rem; letter-spacing:0.02em; }
  .pill{ display:inline-flex; align-items:center; gap:6px; padding:6px 12px; border-radius:999px; background:var(--panel); border:1px solid var(--border); color:var(--muted); font-size:0.9rem; }
  .tag{ display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; font-size:0.85rem; background:rgba(56,189,248,0.12); color:var(--accent); }
  button{ appearance:none; border:0; border-radius:10px; padding:10px 14px; background:var(--accent); color:#0b1524; font-weight:700; cursor:pointer; box-shadow:0 10px 28px rgba(56,189,248,0.25); transition:transform .15s ease, opacity .15s ease; }
  button:hover{ transform:translateY(-1px); }
  button:disabled{ opacity:0.6; cursor:not-allowed; box-shadow:none; transform:none; }
  .muted{ color:var(--muted); font-size:0.9rem; }
  .grid{ display:grid; gap:12px; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); }
  .card{ background:var(--card); border:1px solid var(--border); border-radius:16px; padding:14px 16px; box-shadow:0 18px 48px rgba(0,0,0,0.28); }
  .section{ display:flex; flex-direction:column; gap:12px; }
  .section h2{ margin:0; font-size:1.1rem; letter-spacing:0.01em; }
  .section-header{ display:flex; align-items:center; gap:10px; }
  .small{ font-size:0.82rem; color:var(--muted); }
  .timeline{ display:flex; flex-direction:column; gap:10px; }
  .visit{ display:grid; grid-template-columns:70px 1fr; gap:10px; align-items:center; padding:10px 12px; border-radius:12px; border:1px solid var(--border); background:var(--panel); }
  .visit-time{ font-variant-numeric:tabular-nums; color:#fff; font-weight:700; }
  .visit-body{ display:flex; flex-direction:column; gap:4px; }
  .badge{ display:inline-flex; align-items:center; gap:4px; padding:4px 8px; border-radius:8px; background:rgba(255,255,255,0.06); border:1px solid var(--border); font-size:0.85rem; color:var(--muted); }
  .badge.success{ background:rgba(16,185,129,0.14); color:var(--success); border-color:rgba(16,185,129,0.28); }
  .badge.warn{ background:rgba(245,158,11,0.12); color:var(--warning); border-color:rgba(245,158,11,0.32); }
  details.patient{ border:1px solid var(--border); border-radius:16px; overflow:hidden; background:var(--panel); box-shadow:0 18px 38px rgba(0,0,0,0.22); }
  details.patient summary{ list-style:none; cursor:pointer; padding:12px 14px; display:flex; flex-direction:column; gap:8px; }
  details.patient summary::-webkit-details-marker{ display:none; }
  .patient-header{ display:flex; justify-content:space-between; gap:10px; align-items:center; }
  .patient-name{ font-weight:700; letter-spacing:0.01em; }
  .status-tags{ display:flex; gap:6px; flex-wrap:wrap; }
  .status-tag{ display:inline-flex; align-items:center; padding:4px 10px; border-radius:999px; font-size:0.8rem; border:1px solid var(--border); color:var(--muted); background:rgba(255,255,255,0.04); }
  .status-tag.tag-consent{ color:#fdba74; background:rgba(249,115,22,0.14); border-color:rgba(249,115,22,0.32); }
  .status-tag.tag-report{ color:#fca5a5; background:rgba(239,68,68,0.14); border-color:rgba(239,68,68,0.32); }
  .patient-body{ border-top:1px solid var(--border); padding:12px 14px 14px; display:flex; flex-direction:column; gap:8px; background:rgba(255,255,255,0.02); }
  .meta-row{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; color:var(--muted); font-size:0.9rem; }
  .note-preview{ background:rgba(56,189,248,0.06); border:1px solid rgba(56,189,248,0.22); border-radius:12px; padding:10px 12px; font-size:0.95rem; color:#e0f2fe; }
  .warning-list{ display:flex; flex-direction:column; gap:6px; }
  .warning-item{ padding:8px 10px; border-radius:10px; background:rgba(239,68,68,0.14); border:1px solid rgba(239,68,68,0.25); color:#fecdd3; font-size:0.92rem; }
  .error-box{ padding:12px 14px; border-radius:12px; background:rgba(239,68,68,0.14); border:1px solid rgba(239,68,68,0.3); color:#fecdd3; }
  .loading{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(11,21,36,0.72); z-index:20; }
  .loading.hidden{ display:none; }
  .spinner{ width:40px; height:40px; border-radius:50%; border:4px solid rgba(56,189,248,0.3); border-top-color:var(--accent); animation:spin 0.8s linear infinite; }
  .alert-card{ display:flex; flex-direction:column; gap:8px; }
  .alert-metrics{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  .alert-amount{ font-size:1.1rem; font-weight:800; color:#fbbf24; }
  .alert-months{ display:flex; gap:6px; flex-wrap:wrap; font-size:0.9rem; color:var(--muted); }
  .summary-card{ display:flex; flex-direction:column; gap:10px; }
  .critical-list{ display:flex; flex-direction:column; gap:8px; }
  .critical-item{ display:flex; justify-content:space-between; align-items:center; gap:10px; border:1px solid rgba(239,68,68,0.35); background:rgba(239,68,68,0.12); border-radius:10px; padding:10px 12px; }
  .critical-reason{ color:#fecaca; font-size:0.9rem; }
  .summary-header{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
  .summary-header h3{ margin:0; font-size:1rem; }
  .summary-count{ font-weight:700; font-size:1.1rem; color:#fff; }
  .overview-list{ list-style:none; margin:0; padding:0; display:flex; flex-direction:column; gap:8px; }
  .overview-row{ display:flex; flex-direction:column; gap:4px; padding:8px 10px; border-radius:10px; border:1px solid var(--border); background:rgba(255,255,255,0.02); cursor:pointer; transition:background .15s ease, border-color .15s ease, transform .15s ease; }
  .overview-row:hover{ background:rgba(56,189,248,0.12); border-color:rgba(56,189,248,0.4); }
  .overview-row:active{ transform:translateY(1px); }
  .overview-row-title{ font-weight:700; display:flex; align-items:center; gap:8px; }
  .overview-count{ font-weight:700; color:#fff; font-size:0.9rem; }
  .overview-row-subtext{ font-size:0.82rem; color:var(--muted); }
  .overview-empty{ color:var(--muted); font-size:0.9rem; padding:4px 2px; }
  .overview-metrics{ display:flex; flex-direction:column; gap:8px; }
  .overview-metric{ display:flex; align-items:center; justify-content:space-between; padding:8px 10px; border-radius:10px; border:1px solid var(--border); background:rgba(255,255,255,0.02); }
  .overview-metric-label{ color:var(--muted); font-size:0.85rem; }
  .overview-metric-value{ font-weight:700; }
  @keyframes spin{ to{ transform:rotate(360deg); } }
  @media (max-width:640px){
    .visit{ grid-template-columns:60px 1fr; }
    header{ align-items:flex-start; }
  }
</style>
</head>
<body>
<div class="page">
  <header>
    <h1>施術者ダッシュボード</h1>
    <span class="pill" id="metaUser">-</span>
    <span class="pill" id="metaTs">-</span>
    <button id="refreshBtn">最新の情報を取得</button>
  </header>

  <div id="errorBox" class="error-box" style="display:none;"></div>

  <div class="section">
    <div class="grid" id="overviewGrid">
      <div class="card summary-card" id="patientStatusSummary"></div>
      <div class="card summary-card" id="invoiceSummary"></div>
      <div class="card summary-card" id="consentSummary"></div>
      <div class="card summary-card" id="visitSummary"></div>
    </div>
  </div>

  <div class="section">
    <div class="section-header">
      <h2>要対応患者</h2>
      <span class="small" id="criticalPatientCount"></span>
    </div>
    <div class="card">
      <div class="critical-list" id="criticalPatientList"></div>
    </div>
  </div>

  <div class="section">
    <div class="section-header">
      <h2>未回収アラート</h2>
      <span class="small" id="unpaidAlertCount"></span>
    </div>
    <div class="grid" id="unpaidAlertList"></div>
  </div>

  <div class="section">
    <div class="section-header">
      <h2>今日・直近1日の訪問</h2>
      <span class="small">タイムライン</span>
    </div>
    <div class="timeline" id="visitList"></div>
  </div>

  <div class="section">
    <div class="section-header">
      <h2>担当患者一覧</h2>
      <span class="small" id="patientCount"></span>
    </div>
    <div class="section" id="patientList"></div>
  </div>
</div>

<div class="loading hidden" id="loading">
  <div class="spinner"></div>
</div>

<script>
const DASHBOARD_TREATMENT_APP_EXEC_URL = <?!= JSON.stringify(typeof dashboardTreatmentAppExecUrlConstant !== 'undefined' ? dashboardTreatmentAppExecUrlConstant : '') ?>;
// 一時対応: Issue #1449
// 将来的に再有効化できるよう、データ生成ロジックは維持したままUI表示のみ抑止する。
const DASHBOARD_SUPPRESS_HANDOVER_REMINDER_UI = true;
const dashboardState = {
  loading: true,
  data: null,
  error: '',
  marking: new Set()
};

function logDashboardUi_(label, details) {
  if (typeof console === 'undefined') return;
  const payload = details === undefined ? '' : details;
  console.info(`[dashboard-ui] ${label}`, payload);
}

document.addEventListener('DOMContentLoaded', () => {
  const refreshBtn = document.getElementById('refreshBtn');
  refreshBtn.addEventListener('click', fetchDashboardData);
  fetchDashboardData();
});

function fetchDashboardData() {
  setLoading(true);
  dashboardState.error = '';
  logDashboardUi_('fetchDashboardData:start', { mock: resolveDashboardMockParam_() || null });

  const onSuccess = (payload) => {
    dashboardState.data = payload || {};
    setLoading(false);
    const summary = {
      tasks: Array.isArray(payload && payload.tasks) ? payload.tasks.length : 0,
      visits: Array.isArray(payload && payload.todayVisits) ? payload.todayVisits.length : 0,
      patients: Array.isArray(payload && payload.patients) ? payload.patients.length : 0,
      unpaidAlerts: Array.isArray(payload && payload.unpaidAlerts) ? payload.unpaidAlerts.length : 0,
      warnings: Array.isArray(payload && payload.warnings) ? payload.warnings.length : 0,
      metaError: payload && payload.meta && payload.meta.error ? payload.meta.error : ''
    };
    logDashboardUi_('fetchDashboardData:success', summary);
    renderAll();
  };
  const onFailure = (err) => {
    dashboardState.error = err && err.message ? err.message : String(err || '不明なエラー');
    setLoading(false);
    logDashboardUi_('fetchDashboardData:failure', dashboardState.error);
    renderAll();
  };

  const runner = typeof google !== 'undefined' && google.script && google.script.run;
  if (runner && typeof runner.getDashboardData === 'function') {
    const mockFlag = resolveDashboardMockParam_();
    const args = mockFlag ? { mock: mockFlag } : {};
    logDashboardUi_('fetchDashboardData:appsScript', { mock: mockFlag || null });
    runner.withSuccessHandler(onSuccess).withFailureHandler(onFailure).getDashboardData(args);
    return;
  }

  const mock = resolveDashboardMockParam_();
  const mockQuery = mock ? `&mock=${encodeURIComponent(mock)}` : '';
  const url = (typeof baseUrl !== 'undefined' ? baseUrl : '') + `?action=getDashboardData${mockQuery}`;
  logDashboardUi_('fetchDashboardData:fetch', { url });
  fetch(url)
    .then(res => res.json())
    .then(onSuccess)
    .catch(onFailure);
}

function setLoading(flag) {
  dashboardState.loading = !!flag;
  const overlay = document.getElementById('loading');
  if (!overlay) return;
  overlay.classList.toggle('hidden', !dashboardState.loading);
  const refreshBtn = document.getElementById('refreshBtn');
  if (refreshBtn) refreshBtn.disabled = dashboardState.loading;
}

function renderAll() {
  renderMeta();
  renderOverview();
  renderCriticalPatients();
  renderUnpaidAlerts();
  renderVisits();
  renderPatients();
  renderError();
}

function renderMeta() {
  const meta = dashboardState.data && dashboardState.data.meta ? dashboardState.data.meta : {};
  document.getElementById('metaUser').textContent = meta.user ? `ログイン: ${meta.user}` : 'ログイン情報なし';
  document.getElementById('metaTs').textContent = meta.generatedAt ? `生成: ${meta.generatedAt}` : '生成時刻不明';
}

function renderError() {
  const box = document.getElementById('errorBox');
  if (!box) return;
  if (dashboardState.error) {
    box.textContent = dashboardState.error;
    box.style.display = 'block';
    return;
  }
  const metaError = dashboardState.data && dashboardState.data.meta && dashboardState.data.meta.error;
  if (metaError) {
    box.textContent = metaError;
    box.style.display = 'block';
    return;
  }
  if (!resolveTreatmentAppExecUrl_()) {
    box.textContent = '施術録WebアプリURLが未設定のため、患者画面への遷移を無効化しています。';
    box.style.display = 'block';
    return;
  }
  box.style.display = 'none';
  box.textContent = '';
}

function renderOverview() {
  renderPatientStatusSummary();
  renderInvoiceSummary();
  renderConsentSummary();
  renderVisitSummary();
}

function renderPatientStatusSummary() {
  const container = document.getElementById('patientStatusSummary');
  if (!container) return;
  container.innerHTML = '';
  const overview = dashboardState.data && dashboardState.data.overview ? dashboardState.data.overview : {};
  const data = overview && overview.patientStatusSummary
    ? overview.patientStatusSummary
    : { consentExpiredCount: 0, reportDelayedCount: 0 };

  const header = document.createElement('div');
  header.className = 'summary-header';
  const title = document.createElement('h3');
  title.textContent = '優先度集計';
  header.appendChild(title);
  container.appendChild(header);

  const metrics = document.createElement('div');
  metrics.className = 'overview-metrics';

  const consentRow = document.createElement('div');
  consentRow.className = 'overview-metric';
  const consentLabel = document.createElement('span');
  consentLabel.className = 'overview-metric-label';
  consentLabel.textContent = '同意期限超過件数';
  const consentValue = document.createElement('span');
  consentValue.className = 'overview-metric-value';
  consentValue.textContent = `${data.consentExpiredCount || 0}件`;
  consentRow.appendChild(consentLabel);
  consentRow.appendChild(consentValue);
  metrics.appendChild(consentRow);

  const reportRow = document.createElement('div');
  reportRow.className = 'overview-metric';
  const reportLabel = document.createElement('span');
  reportLabel.className = 'overview-metric-label';
  reportLabel.textContent = '報告書未作成件数';
  const reportValue = document.createElement('span');
  reportValue.className = 'overview-metric-value';
  reportValue.textContent = `${data.reportDelayedCount || 0}件`;
  reportRow.appendChild(reportLabel);
  reportRow.appendChild(reportValue);
  metrics.appendChild(reportRow);

  container.appendChild(metrics);
}

function renderInvoiceSummary() {
  const container = document.getElementById('invoiceSummary');
  if (!container) return;
  const overview = dashboardState.data && dashboardState.data.overview ? dashboardState.data.overview : {};
  const data = overview && overview.invoiceUnconfirmed ? overview.invoiceUnconfirmed : { count: 0, items: [] };
  renderOverviewCard_(container, {
    title: '①請求',
    items: data.items || [],
    emptyText: '全員対応済み'
  });
}

function renderConsentSummary() {
  const container = document.getElementById('consentSummary');
  if (!container) return;
  const overview = dashboardState.data && dashboardState.data.overview ? dashboardState.data.overview : {};
  const data = overview && overview.consentRelated ? overview.consentRelated : { count: 0, items: [] };
  renderOverviewCard_(container, {
    title: '②同意',
    items: data.items || [],
    emptyText: '対象者なし'
  });
}

function renderVisitSummary() {
  const container = document.getElementById('visitSummary');
  if (!container) return;
  container.innerHTML = '';
  const overview = dashboardState.data && dashboardState.data.overview ? dashboardState.data.overview : {};
  const data = overview && overview.visitSummary ? overview.visitSummary : { todayCount: 0, recentOneDayCount: 0 };

  const header = document.createElement('div');
  header.className = 'summary-header';
  const title = document.createElement('h3');
  title.textContent = '③施術実績';
  header.appendChild(title);
  container.appendChild(header);

  const metrics = document.createElement('div');
  metrics.className = 'overview-metrics';

  const todayRow = document.createElement('div');
  todayRow.className = 'overview-metric';
  const todayLabel = document.createElement('span');
  todayLabel.className = 'overview-metric-label';
  todayLabel.textContent = '今日';
  const todayValue = document.createElement('span');
  todayValue.className = 'overview-metric-value';
  todayValue.textContent = `${data.todayCount || 0}件`;
  todayRow.appendChild(todayLabel);
  todayRow.appendChild(todayValue);
  metrics.appendChild(todayRow);

  const lastRow = document.createElement('div');
  lastRow.className = 'overview-metric';
  const lastLabel = document.createElement('span');
  lastLabel.className = 'overview-metric-label';
  lastLabel.textContent = '直近1日施術';
  const lastValue = document.createElement('span');
  lastValue.className = 'overview-metric-value';
  lastValue.textContent = `${data.recentOneDayCount || 0}件`;
  lastRow.appendChild(lastLabel);
  lastRow.appendChild(lastValue);
  metrics.appendChild(lastRow);

  container.appendChild(metrics);
}

function renderUnpaidAlerts() {
  const list = document.getElementById('unpaidAlertList');
  const count = document.getElementById('unpaidAlertCount');
  if (!list) return;
  list.innerHTML = '';

  const alerts = dashboardState.data && Array.isArray(dashboardState.data.unpaidAlerts)
    ? dashboardState.data.unpaidAlerts
    : [];
  if (count) count.textContent = alerts.length ? `${alerts.length}件` : 'アラートなし';

  if (!alerts.length) {
    const empty = document.createElement('div');
    empty.className = 'muted';
    empty.textContent = '連続未回収の対象はありません';
    list.appendChild(empty);
    return;
  }

  alerts.forEach(alert => {
    const card = document.createElement('div');
    card.className = 'card alert-card';

    const header = document.createElement('div');
    header.className = 'patient-header';
    const name = document.createElement(alert.patientId ? 'a' : 'div');
    name.className = alert.patientId ? 'patient-name patient-link' : 'patient-name';
    if (alert.patientId) {
      configurePatientLinkElement_(name, alert.patientId);
    }
    name.textContent = alert.patientName || '氏名未登録';
    header.appendChild(name);
    const tags = document.createElement('div');
    tags.style.display = 'flex';
    tags.style.gap = '6px';
    tags.style.flexWrap = 'wrap';
    if (alert.patientId) tags.appendChild(makeBadge('ID: ' + alert.patientId));
    header.appendChild(tags);
    card.appendChild(header);

    const metrics = document.createElement('div');
    metrics.className = 'alert-metrics';
    const months = document.createElement('span');
    months.className = 'badge';
    months.textContent = `連続${alert.consecutiveMonths}ヶ月`;
    metrics.appendChild(months);
    const amount = document.createElement('span');
    amount.className = 'alert-amount';
    amount.textContent = formatCurrency(alert.totalAmount);
    metrics.appendChild(amount);
    card.appendChild(metrics);

    if (Array.isArray(alert.months) && alert.months.length) {
      const monthList = document.createElement('div');
      monthList.className = 'alert-months';
      monthList.textContent = '対象月: ' + alert.months.map(m => m.key).join(', ');
      card.appendChild(monthList);
    }

    list.appendChild(card);
  });
}

function renderCriticalPatients() {
  const list = document.getElementById('criticalPatientList');
  const count = document.getElementById('criticalPatientCount');
  if (!list) return;
  list.innerHTML = '';

  const overview = dashboardState.data && dashboardState.data.overview ? dashboardState.data.overview : {};
  const criticalPatients = overview && overview.criticalPatients && Array.isArray(overview.criticalPatients.items)
    ? overview.criticalPatients.items
    : [];
  if (count) count.textContent = criticalPatients.length ? `${criticalPatients.length}名` : '該当なし';

  if (!criticalPatients.length) {
    const empty = document.createElement('div');
    empty.className = 'muted';
    empty.textContent = '緊急対応が必要な患者はいません';
    list.appendChild(empty);
    return;
  }

  criticalPatients.forEach(item => {
    const row = document.createElement('div');
    row.className = 'critical-item';

    const name = document.createElement(item.patientId ? 'a' : 'span');
    name.className = item.patientId ? 'patient-name patient-link' : 'patient-name';
    name.textContent = item.name || item.patientId || '氏名未登録';
    if (item.patientId) configurePatientLinkElement_(name, item.patientId);
    row.appendChild(name);

    const reason = document.createElement('span');
    reason.className = 'critical-reason';
    reason.textContent = item.reason || '要確認';
    row.appendChild(reason);

    list.appendChild(row);
  });
}

function renderVisits() {
  const list = document.getElementById('visitList');
  if (!list) return;
  list.innerHTML = '';

  const visits = dashboardState.data && Array.isArray(dashboardState.data.todayVisits)
    ? dashboardState.data.todayVisits
    : [];

  if (!visits.length) {
    const empty = document.createElement('div');
    empty.className = 'muted';
    empty.textContent = '訪問データはありません';
    list.appendChild(empty);
    return;
  }

  visits.forEach(v => {
    const row = document.createElement('div');
    row.className = 'visit';
    const time = document.createElement('div');
    time.className = 'visit-time';
    time.textContent = v.time || '--:--';
    row.appendChild(time);

    const body = document.createElement('div');
    body.className = 'visit-body';
    const name = document.createElement(v.patientId ? 'a' : 'div');
    if (v.patientId) {
      configurePatientLinkElement_(name, v.patientId);
      name.className = 'patient-link';
    }
    name.textContent = formatVisitPatientLabel_(v);
    name.style.fontWeight = '700';
    body.appendChild(name);

    const meta = document.createElement('div');
    meta.className = 'meta-row';
    const badge = document.createElement('span');
    const hasNote = v.noteStatus === '◎';
    if (!(DASHBOARD_SUPPRESS_HANDOVER_REMINDER_UI && !hasNote)) {
      badge.className = `badge ${hasNote ? 'success' : 'warn'}`;
      badge.textContent = hasNote ? '報告書作成ヒントあり' : '報告書作成ヒント未入力';
      meta.appendChild(badge);
    }
    if (v.patientId) {
      const idBadge = document.createElement('span');
      idBadge.className = 'badge';
      idBadge.textContent = v.patientId;
      meta.appendChild(idBadge);
    }
    body.appendChild(meta);
    row.appendChild(body);

    list.appendChild(row);
  });
}


function formatVisitPatientLabel_(visit) {
  const patientName = String(visit && visit.patientName ? visit.patientName : '').trim();
  const patientId = String(visit && visit.patientId ? visit.patientId : '').trim();
  if (patientName && patientId) return `${patientName}（${patientId}）`;
  if (patientName) return patientName;
  if (patientId) return patientId;
  return '患者不明';
}

function renderPatients() {
  const list = document.getElementById('patientList');
  const count = document.getElementById('patientCount');
  if (!list) return;
  list.innerHTML = '';

  const patients = dashboardState.data && Array.isArray(dashboardState.data.patients)
    ? dashboardState.data.patients.slice().sort((a, b) => (a.name || '').localeCompare(b.name || '', 'ja'))
    : [];

  if (count) count.textContent = patients.length ? `${patients.length}名` : '患者データなし';

  if (!patients.length) {
    const empty = document.createElement('div');
    empty.className = 'muted';
    empty.textContent = '患者データはありません';
    list.appendChild(empty);
    return;
  }

  patients.forEach(p => {
    const details = document.createElement('details');
    details.className = 'patient';
    details.dataset.patientId = p.patientId || '';

    const summary = document.createElement('summary');
    const header = document.createElement('div');
    header.className = 'patient-header';
    const name = document.createElement('span');
    name.className = p.patientId ? 'patient-name patient-link' : 'patient-name';
    name.textContent = p.name || '氏名未登録';
    header.appendChild(name);

    if (Array.isArray(p.statusTags) && p.statusTags.length > 0) {
      const statusTags = document.createElement('div');
      statusTags.className = 'status-tags';
      p.statusTags.forEach(tag => {
        if (!tag || !tag.label || !tag.type) return;
        if (tag.type !== 'consent' && tag.type !== 'report') return;
        const statusTag = document.createElement('span');
        statusTag.className = `status-tag tag-${tag.type}`;
        statusTag.textContent = tag.label;
        statusTags.appendChild(statusTag);
      });
      if (statusTags.childElementCount > 0) {
        header.appendChild(statusTags);
      }
    }

    summary.appendChild(header);

    const meta = document.createElement('div');
    meta.className = 'meta-row';
    if (p.consentExpiry) meta.appendChild(makeBadge('同意期限: ' + p.consentExpiry));
    if (p.invoiceUrl) meta.appendChild(makeBadge('請求書リンクあり'));
    summary.appendChild(meta);

    if (p.patientId && buildTreatmentAppLink_(p.patientId)) {
      summary.setAttribute('role', 'link');
      summary.setAttribute('tabindex', '0');
      summary.addEventListener('click', (event) => {
        event.preventDefault();
        navigateToPatient_(p.patientId);
      });
      summary.addEventListener('keydown', (event) => {
        if (event.key !== 'Enter' && event.key !== ' ') return;
        event.preventDefault();
        navigateToPatient_(p.patientId);
      });
    }

    details.appendChild(summary);

    const body = document.createElement('div');
    body.className = 'patient-body';

    const fields = document.createElement('div');
    fields.className = 'meta-row';
    if (p.patientId) fields.appendChild(makeBadge('ID: ' + p.patientId));
    if (p.note && p.note.when) fields.appendChild(makeBadge('最終報告書作成ヒント: ' + p.note.when));
    if (p.note && p.note.lastReadAt) fields.appendChild(makeBadge('最終既読: ' + p.note.lastReadAt));
    body.appendChild(fields);

    if (p.note && p.note.preview) {
      const note = document.createElement('div');
      note.className = 'note-preview';
      note.textContent = p.note.preview;
      body.appendChild(note);
    }

    if (p.invoiceUrl) {
      const link = document.createElement('a');
      link.href = p.invoiceUrl;
      link.textContent = '請求書PDFを開く';
      link.target = '_blank';
      link.rel = 'noopener noreferrer';
      body.appendChild(link);
    }

    details.appendChild(body);

    details.addEventListener('toggle', () => {
      if (details.open) markNoteAsRead(p);
    });

    list.appendChild(details);
  });
}

function markNoteAsRead(patient) {
  const pid = patient && patient.patientId;
  if (!pid || !patient.note || !patient.note.unread) return;
  if (dashboardState.marking.has(pid)) return;

  const runner = typeof google !== 'undefined' && google.script && google.script.run;
  if (!runner || typeof runner.markAsRead !== 'function') {
    markPatientNoteLocally_(pid);
    return;
  }

  dashboardState.marking.add(pid);
  runner.withSuccessHandler(res => {
    dashboardState.marking.delete(pid);
    if (res && res.ok && dashboardState.data && Array.isArray(dashboardState.data.patients)) {
      const target = dashboardState.data.patients.find(entry => entry.patientId === pid);
      if (target && target.note) {
        target.note.unread = false;
        target.note.lastReadAt = res.readAt || target.note.lastReadAt || '';
        renderPatients();
      }
    }
  }).withFailureHandler(() => {
    dashboardState.marking.delete(pid);
  }).markAsRead({ patientId: pid });
}

function markPatientNoteLocally_(pid) {
  if (!dashboardState.data || !Array.isArray(dashboardState.data.patients)) return;
  const target = dashboardState.data.patients.find(entry => entry.patientId === pid);
  if (!target || !target.note) return;
  target.note.unread = false;
  target.note.lastReadAt = target.note.lastReadAt || new Date().toISOString();
  renderPatients();
}

function makeBadge(text) {
  const span = document.createElement('span');
  span.className = 'badge';
  span.textContent = text;
  return span;
}

function renderOverviewCard_(container, options) {
  const opts = options || {};
  container.innerHTML = '';

  const header = document.createElement('div');
  header.className = 'summary-header';
  const title = document.createElement('h3');
  title.textContent = opts.title || '';
  header.appendChild(title);
  container.appendChild(header);

  const items = Array.isArray(opts.items) ? opts.items : [];
  container.appendChild(renderOverviewList_(items, opts.emptyText || '対象はありません'));
}

function renderOverviewList_(items, emptyText) {
  const filteredItems = (items || []).filter(item => item && item.patientId);
  if (!filteredItems.length) {
    const empty = document.createElement('div');
    empty.className = 'overview-empty';
    empty.textContent = emptyText || '対象はありません';
    return empty;
  }

  const list = document.createElement('div');
  list.className = 'overview-list';
  filteredItems
    .slice()
    .sort((a, b) => (a.name || '').localeCompare(b.name || '', 'ja'))
    .forEach(item => {
      const row = document.createElement('div');
      row.className = 'overview-row';
      const title = document.createElement('div');
      title.className = 'overview-row-title';
      const name = document.createElement('span');
      name.textContent = item.name || item.patientId;
      const count = document.createElement('span');
      count.className = 'overview-count';
      const displayCount = Math.max(1, Number(item.count) || 1);
      count.textContent = `［${displayCount}件］`;
      title.appendChild(name);
      title.appendChild(count);
      row.appendChild(title);

      const sub = document.createElement('div');
      sub.className = 'overview-row-subtext';
      sub.textContent = item.subText || '';
      row.appendChild(sub);

      bindPatientRow_(row, item.patientId);
      list.appendChild(row);
    });
  return list;
}

function bindPatientRow_(row, patientId) {
  if (!row || !patientId) return;
  if (!buildTreatmentAppLink_(patientId)) {
    row.classList.add('disabled');
    row.setAttribute('aria-disabled', 'true');
    return;
  }
  row.setAttribute('role', 'link');
  row.setAttribute('tabindex', '0');
  row.dataset.patientId = patientId;

  row.addEventListener('pointerdown', (event) => {
    if (event.button !== 0) return;
    row.dataset.pointerDownX = String(event.clientX);
    row.dataset.pointerDownY = String(event.clientY);
  });

  row.addEventListener('pointerup', (event) => {
    if (event.button !== 0) return;
    const startX = Number(row.dataset.pointerDownX || 0);
    const startY = Number(row.dataset.pointerDownY || 0);
    const dx = event.clientX - startX;
    const dy = event.clientY - startY;
    const distance = Math.sqrt(dx * dx + dy * dy);
    if (distance > 6) return;
    navigateToPatient_(patientId);
  });

  row.addEventListener('keydown', (event) => {
    if (event.key !== 'Enter' && event.key !== ' ') return;
    event.preventDefault();
    navigateToPatient_(patientId);
  });
}

function navigateToPatient_(patientId) {
  if (!patientId) return;
  const link = buildTreatmentAppLink_(patientId);
  if (!link) {
    showNavigationError_('施術録WebアプリURLが未設定のため、患者画面を開けません。');
    return;
  }
  if (typeof window !== 'undefined' && typeof window.open === 'function') {
    window.open(link, '_blank', 'noopener,noreferrer');
  }
}

function configurePatientLinkElement_(anchor, patientId) {
  if (!anchor) return;
  if (!patientId) {
    anchor.removeAttribute('href');
    anchor.removeAttribute('target');
    anchor.removeAttribute('rel');
    anchor.classList.add('disabled');
    anchor.setAttribute('aria-disabled', 'true');
    return;
  }
  const link = buildTreatmentAppLink_(patientId);
  if (!link) {
    anchor.removeAttribute('href');
    anchor.removeAttribute('target');
    anchor.removeAttribute('rel');
    anchor.classList.add('disabled');
    anchor.setAttribute('aria-disabled', 'true');
    anchor.addEventListener('click', (event) => {
      event.preventDefault();
      showNavigationError_('施術録WebアプリURLが未設定のため、患者画面を開けません。');
    });
    return;
  }
  anchor.href = link;
  anchor.target = '_blank';
  anchor.rel = 'noopener noreferrer';
}

function buildTreatmentAppLink_(patientId) {
  const rawExecUrl = resolveTreatmentAppExecUrl_();
  if (!rawExecUrl) return '';
  const id = encodeURIComponent(patientId || '');
  if (!id) return '';
  return `${rawExecUrl}?view=record&id=${id}`;
}

function resolveTreatmentAppExecUrl_() {
  const configured = typeof DASHBOARD_TREATMENT_APP_EXEC_URL !== 'undefined'
    ? String(DASHBOARD_TREATMENT_APP_EXEC_URL || '').trim()
    : '';

  const injected = typeof treatmentAppExecUrl !== 'undefined'
    ? String(treatmentAppExecUrl || '').trim()
    : '';
  const resolved = configured || injected;
  if (resolved && isValidTreatmentExecUrl_(resolved)) {
    return normalizeTreatmentExecUrl_(resolved);
  }

  return '';
}

function normalizeTreatmentExecUrl_(url) {
  if (!url) return '';
  const trimmed = String(url || '').trim();
  if (!trimmed) return '';
  const noHash = trimmed.split('#')[0];
  return noHash.split('?')[0];
}

function isValidTreatmentExecUrl_(url) {
  if (!url) return false;
  const normalized = String(url || '').trim().toLowerCase();
  if (!normalized) return false;
  if (normalized.indexOf('googleusercontent.com/usercodeapppanel') >= 0) return false;
  return normalized.indexOf('script.google.com/') >= 0 && normalized.indexOf('/exec') >= 0;
}

function showNavigationError_(message) {
  if (!message) return;
  dashboardState.error = message;
  renderError();
}
function formatTaskLabel(type) {
  switch(type) {
    case 'consentExpired': return '同意書期限切れ';
    case 'consentWarning': return '同意書期限間近';
    case 'handoverDelayed':
      // 一時対応: Issue #1449
      // 表示上は非表示にするが、タスクデータ自体は保持して将来の再有効化に備える。
      return DASHBOARD_SUPPRESS_HANDOVER_REMINDER_UI ? '' : '報告書作成ヒント未入力';
    case 'aiReportDelayed': return '医師報告書遅延';
    case 'invoiceUnconfirmed': return '請求書確認待ち';
    default: return 'タスク';
  }
}
function formatCurrency(amount) {
  const num = Number(amount) || 0;
  try {
    return num.toLocaleString('ja-JP', { style: 'currency', currency: 'JPY', maximumFractionDigits: 0 });
  } catch (_err) {
    return `¥${num.toFixed(0)}`;
  }
}

function formatDateLabel(key) {
  if (!key) return '日付不明';
  const today = new Date();
  const todayKey = keyFromDate(today);
  const yesterdayKey = keyFromDate(new Date(today.getTime() - 86400000));
  if (key === todayKey) return '今日';
  if (key === yesterdayKey) return '昨日';
  const parsed = new Date(key);
  if (!Number.isNaN(parsed.getTime())) {
    return parsed.toLocaleDateString('ja-JP', { month: 'short', day: 'numeric', weekday: 'short' });
  }
  return key;
}

function keyFromDate(date) {
  const y = date.getFullYear();
  const m = String(date.getMonth() + 1).padStart(2, '0');
  const d = String(date.getDate()).padStart(2, '0');
  return `${y}-${m}-${d}`;
}

function resolveDashboardMockParam_() {
  if (typeof dashboardMockFlag !== 'undefined' && dashboardMockFlag) return dashboardMockFlag;
  if (typeof window === 'undefined' || !window.location || !window.location.search) return '';
  const search = new URLSearchParams(window.location.search);
  return search.get('mock') || '';
}


/*
共有用サマリー
- 変更点:
  - 患者遷移URLの組み立てを `buildTreatmentAppLink_` / `navigateToPatient_` / `configurePatientLinkElement_` に集約し、常に `.../exec?view=record&id=...` 形式で新規タブ遷移するよう統一。
  - `resolveTreatmentAppExecUrl_` がURL未設定・不正（googleusercontent系）時に空文字を返すよう修正し、`#` フォールバックを廃止。
  - exec URLが解決できない場合は `#errorBox` にエラーを表示し、患者リンク/行の操作を無効化する防御処理を追加。
- 理由:
  - ダッシュボードから患者クリック時に userCodeAppPanel へ飛んで空白になる問題を防ぎ、必ず公開Webアプリexec URLに遷移させるため。
- 影響範囲:
  - 未回収アラート、訪問タイムライン、概要カード、担当患者一覧の患者遷移動線。
  - 施術録URL解決とナビゲーション時のエラー表示。
*/
</script>
</body>
</html>
