<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>施術者ダッシュボード</title>
<style>
  :root{
    --bg:#0b1524;
    --card:#0f172a;
    --panel:#111827;
    --border:rgba(255,255,255,0.08);
    --text:#e5e7eb;
    --muted:#9ca3af;
    --accent:#38bdf8;
    --warning:#f59e0b;
    --critical:#ef4444;
    --success:#10b981;
  }
  *{ box-sizing:border-box; }
  body{ margin:0; font-family:system-ui,-apple-system,"Segoe UI","Noto Sans JP",sans-serif; background:var(--bg); color:var(--text); }
  a{ color:var(--accent); }
  .patient-link{ color:inherit; text-decoration:none; }
  .patient-link:hover{ text-decoration:underline; }
  .page{ max-width:1080px; margin:0 auto; padding:20px 16px 64px; display:flex; flex-direction:column; gap:18px; }
  header{ display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
  h1{ margin:0; font-size:1.4rem; letter-spacing:0.02em; }
  .pill{ display:inline-flex; align-items:center; gap:6px; padding:6px 12px; border-radius:999px; background:var(--panel); border:1px solid var(--border); color:var(--muted); font-size:0.9rem; }
  .tag{ display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; font-size:0.85rem; background:rgba(56,189,248,0.12); color:var(--accent); }
  button{ appearance:none; border:0; border-radius:10px; padding:10px 14px; background:var(--accent); color:#0b1524; font-weight:700; cursor:pointer; box-shadow:0 10px 28px rgba(56,189,248,0.25); transition:transform .15s ease, opacity .15s ease; }
  button:hover{ transform:translateY(-1px); }
  button:disabled{ opacity:0.6; cursor:not-allowed; box-shadow:none; transform:none; }
  .muted{ color:var(--muted); font-size:0.9rem; }
  .grid{ display:grid; gap:12px; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); }
  .card{ background:var(--card); border:1px solid var(--border); border-radius:16px; padding:14px 16px; box-shadow:0 18px 48px rgba(0,0,0,0.28); }
  .section{ display:flex; flex-direction:column; gap:12px; }
  .section h2{ margin:0; font-size:1.1rem; letter-spacing:0.01em; }
  .section-header{ display:flex; align-items:center; gap:10px; }
  .small{ font-size:0.82rem; color:var(--muted); }
  .timeline{ display:flex; flex-direction:column; gap:10px; }
  .visit{ display:grid; grid-template-columns:70px 1fr; gap:10px; align-items:center; padding:10px 12px; border-radius:12px; border:1px solid var(--border); background:var(--panel); }
  .visit-time{ font-variant-numeric:tabular-nums; color:#fff; font-weight:700; }
  .visit-body{ display:flex; flex-direction:column; gap:4px; }
  .badge{ display:inline-flex; align-items:center; gap:4px; padding:4px 8px; border-radius:8px; background:rgba(255,255,255,0.06); border:1px solid var(--border); font-size:0.85rem; color:var(--muted); }
  .badge.success{ background:rgba(16,185,129,0.14); color:var(--success); border-color:rgba(16,185,129,0.28); }
  .badge.warn{ background:rgba(245,158,11,0.12); color:var(--warning); border-color:rgba(245,158,11,0.32); }
  details.patient{ border:1px solid var(--border); border-radius:16px; overflow:hidden; background:var(--panel); box-shadow:0 18px 38px rgba(0,0,0,0.22); }
  details.patient summary{ list-style:none; cursor:pointer; padding:12px 14px; display:flex; flex-direction:column; gap:8px; }
  details.patient summary::-webkit-details-marker{ display:none; }
  .patient-header{ display:flex; justify-content:space-between; gap:10px; align-items:center; }
  .patient-name{ font-weight:700; letter-spacing:0.01em; }
  .patient-body{ border-top:1px solid var(--border); padding:12px 14px 14px; display:flex; flex-direction:column; gap:8px; background:rgba(255,255,255,0.02); }
  .meta-row{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; color:var(--muted); font-size:0.9rem; }
  .note-preview{ background:rgba(56,189,248,0.06); border:1px solid rgba(56,189,248,0.22); border-radius:12px; padding:10px 12px; font-size:0.95rem; color:#e0f2fe; }
  .warning-list{ display:flex; flex-direction:column; gap:6px; }
  .warning-item{ padding:8px 10px; border-radius:10px; background:rgba(239,68,68,0.14); border:1px solid rgba(239,68,68,0.25); color:#fecdd3; font-size:0.92rem; }
  .error-box{ padding:12px 14px; border-radius:12px; background:rgba(239,68,68,0.14); border:1px solid rgba(239,68,68,0.3); color:#fecdd3; }
  .loading{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(11,21,36,0.72); z-index:20; }
  .loading.hidden{ display:none; }
  .spinner{ width:40px; height:40px; border-radius:50%; border:4px solid rgba(56,189,248,0.3); border-top-color:var(--accent); animation:spin 0.8s linear infinite; }
  .alert-card{ display:flex; flex-direction:column; gap:8px; }
  .alert-metrics{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  .alert-amount{ font-size:1.1rem; font-weight:800; color:#fbbf24; }
  .alert-months{ display:flex; gap:6px; flex-wrap:wrap; font-size:0.9rem; color:var(--muted); }
  .summary-card{ display:flex; flex-direction:column; gap:10px; }
  .summary-header{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
  .summary-header h3{ margin:0; font-size:1rem; }
  .summary-count{ font-weight:700; font-size:1.1rem; color:#fff; }
  .summary-list{ list-style:none; margin:0; padding:0; display:flex; flex-direction:column; gap:6px; }
  .summary-list li{ display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap; padding:6px 8px; border-radius:10px; border:1px solid var(--border); background:rgba(255,255,255,0.02); }
  .summary-main{ display:flex; flex-direction:column; gap:2px; }
  .summary-link{ color:var(--accent); text-decoration:none; font-weight:600; }
  .summary-link:hover{ text-decoration:underline; }
  .summary-meta{ font-size:0.85rem; color:var(--muted); }
  .summary-subtext{ font-size:0.82rem; color:var(--muted); }
  @keyframes spin{ to{ transform:rotate(360deg); } }
  @media (max-width:640px){
    .visit{ grid-template-columns:60px 1fr; }
    header{ align-items:flex-start; }
  }
</style>
</head>
<body>
<div class="page">
  <header>
    <h1>施術者ダッシュボード</h1>
    <span class="pill" id="metaUser">-</span>
    <span class="pill" id="metaTs">-</span>
    <button id="refreshBtn">最新の情報を取得</button>
  </header>

  <div id="errorBox" class="error-box" style="display:none;"></div>

  <div class="section">
    <div class="grid" id="overviewGrid">
      <div class="card summary-card" id="invoiceSummary"></div>
      <div class="card summary-card" id="consentSummary"></div>
      <div class="card summary-card" id="visitSummary"></div>
    </div>
  </div>

  <div class="section">
    <div class="section-header">
      <h2>未回収アラート</h2>
      <span class="small" id="unpaidAlertCount"></span>
    </div>
    <div class="grid" id="unpaidAlertList"></div>
  </div>

  <div class="section">
    <div class="section-header">
      <h2>今日・昨日の訪問</h2>
      <span class="small">タイムライン</span>
    </div>
    <div class="timeline" id="visitList"></div>
  </div>

  <div class="section">
    <div class="section-header">
      <h2>担当患者一覧</h2>
      <span class="small" id="patientCount"></span>
    </div>
    <div class="section" id="patientList"></div>
  </div>
</div>

<div class="loading hidden" id="loading">
  <div class="spinner"></div>
</div>

<script>
const dashboardState = {
  loading: true,
  data: null,
  error: '',
  marking: new Set()
};

function logDashboardUi_(label, details) {
  if (typeof console === 'undefined') return;
  const payload = details === undefined ? '' : details;
  console.info(`[dashboard-ui] ${label}`, payload);
}

document.addEventListener('DOMContentLoaded', () => {
  const refreshBtn = document.getElementById('refreshBtn');
  refreshBtn.addEventListener('click', fetchDashboardData);
  fetchDashboardData();
});

function fetchDashboardData() {
  setLoading(true);
  dashboardState.error = '';
  logDashboardUi_('fetchDashboardData:start', { mock: resolveDashboardMockParam_() || null });

  const onSuccess = (payload) => {
    dashboardState.data = payload || {};
    setLoading(false);
    const summary = {
      tasks: Array.isArray(payload && payload.tasks) ? payload.tasks.length : 0,
      visits: Array.isArray(payload && payload.todayVisits) ? payload.todayVisits.length : 0,
      patients: Array.isArray(payload && payload.patients) ? payload.patients.length : 0,
      unpaidAlerts: Array.isArray(payload && payload.unpaidAlerts) ? payload.unpaidAlerts.length : 0,
      warnings: Array.isArray(payload && payload.warnings) ? payload.warnings.length : 0,
      metaError: payload && payload.meta && payload.meta.error ? payload.meta.error : ''
    };
    logDashboardUi_('fetchDashboardData:success', summary);
    renderAll();
  };
  const onFailure = (err) => {
    dashboardState.error = err && err.message ? err.message : String(err || '不明なエラー');
    setLoading(false);
    logDashboardUi_('fetchDashboardData:failure', dashboardState.error);
    renderAll();
  };

  const runner = typeof google !== 'undefined' && google.script && google.script.run;
  if (runner && typeof runner.getDashboardData === 'function') {
    const mockFlag = resolveDashboardMockParam_();
    const args = mockFlag ? { mock: mockFlag } : {};
    logDashboardUi_('fetchDashboardData:appsScript', { mock: mockFlag || null });
    runner.withSuccessHandler(onSuccess).withFailureHandler(onFailure).getDashboardData(args);
    return;
  }

  const mock = resolveDashboardMockParam_();
  const mockQuery = mock ? `&mock=${encodeURIComponent(mock)}` : '';
  const url = (typeof baseUrl !== 'undefined' ? baseUrl : '') + `?action=getDashboardData${mockQuery}`;
  logDashboardUi_('fetchDashboardData:fetch', { url });
  fetch(url)
    .then(res => res.json())
    .then(onSuccess)
    .catch(onFailure);
}

function setLoading(flag) {
  dashboardState.loading = !!flag;
  const overlay = document.getElementById('loading');
  if (!overlay) return;
  overlay.classList.toggle('hidden', !dashboardState.loading);
  const refreshBtn = document.getElementById('refreshBtn');
  if (refreshBtn) refreshBtn.disabled = dashboardState.loading;
}

function renderAll() {
  renderMeta();
  renderOverview();
  renderUnpaidAlerts();
  renderVisits();
  renderPatients();
  renderError();
}

function renderMeta() {
  const meta = dashboardState.data && dashboardState.data.meta ? dashboardState.data.meta : {};
  document.getElementById('metaUser').textContent = meta.user ? `ログイン: ${meta.user}` : 'ログイン情報なし';
  document.getElementById('metaTs').textContent = meta.generatedAt ? `生成: ${meta.generatedAt}` : '生成時刻不明';
}

function renderError() {
  const box = document.getElementById('errorBox');
  if (!box) return;
  if (dashboardState.error) {
    box.textContent = dashboardState.error;
    box.style.display = 'block';
    return;
  }
  const metaError = dashboardState.data && dashboardState.data.meta && dashboardState.data.meta.error;
  if (metaError) {
    box.textContent = metaError;
    box.style.display = 'block';
    return;
  }
  box.style.display = 'none';
  box.textContent = '';
}

function renderOverview() {
  renderInvoiceSummary();
  renderConsentSummary();
  renderVisitSummary();
}

function renderInvoiceSummary() {
  const container = document.getElementById('invoiceSummary');
  if (!container) return;
  const overview = dashboardState.data && dashboardState.data.overview ? dashboardState.data.overview : {};
  const data = overview && overview.invoiceUnconfirmed ? overview.invoiceUnconfirmed : { count: 0, items: [] };
  renderSummaryCard_(container, {
    title: '請求書受渡 未確認',
    count: data.count || 0,
    items: data.items || [],
    emptyText: '未確認の請求書はありません'
  });
}

function renderConsentSummary() {
  const container = document.getElementById('consentSummary');
  if (!container) return;
  const overview = dashboardState.data && dashboardState.data.overview ? dashboardState.data.overview : {};
  const data = overview && overview.consentRelated ? overview.consentRelated : { count: 0, items: [] };
  renderSummaryCard_(container, {
    title: '同意期限／未取得／関連通知',
    count: data.count || 0,
    items: data.items || [],
    emptyText: '同意に関する注意はありません'
  });
}

function renderVisitSummary() {
  const container = document.getElementById('visitSummary');
  if (!container) return;
  container.innerHTML = '';
  const overview = dashboardState.data && dashboardState.data.overview ? dashboardState.data.overview : {};
  const data = overview && overview.visitSummary ? overview.visitSummary : null;
  const today = data && data.today ? data.today : { count: 0, items: [] };
  const yesterday = data && data.yesterday ? data.yesterday : { count: 0, items: [] };

  const header = document.createElement('div');
  header.className = 'summary-header';
  const title = document.createElement('h3');
  title.textContent = '今日／昨日の施術実績';
  header.appendChild(title);
  const count = document.createElement('div');
  count.className = 'summary-count';
  count.textContent = `今日${today.count || 0}件／昨日${yesterday.count || 0}件`;
  header.appendChild(count);
  container.appendChild(header);

  const todayBlock = document.createElement('div');
  todayBlock.className = 'summary-meta';
  todayBlock.textContent = '今日の患者';
  container.appendChild(todayBlock);
  container.appendChild(renderSummaryList_(today.items || [], '今日の施術はありません'));

  const yesterdayBlock = document.createElement('div');
  yesterdayBlock.className = 'summary-meta';
  yesterdayBlock.textContent = '昨日の患者';
  container.appendChild(yesterdayBlock);
  container.appendChild(renderSummaryList_(yesterday.items || [], '昨日の施術はありません'));
}

function renderUnpaidAlerts() {
  const list = document.getElementById('unpaidAlertList');
  const count = document.getElementById('unpaidAlertCount');
  if (!list) return;
  list.innerHTML = '';

  const alerts = dashboardState.data && Array.isArray(dashboardState.data.unpaidAlerts)
    ? dashboardState.data.unpaidAlerts
    : [];
  if (count) count.textContent = alerts.length ? `${alerts.length}件` : 'アラートなし';

  if (!alerts.length) {
    const empty = document.createElement('div');
    empty.className = 'muted';
    empty.textContent = '連続未回収の対象はありません';
    list.appendChild(empty);
    return;
  }

  alerts.forEach(alert => {
    const card = document.createElement('div');
    card.className = 'card alert-card';

    const header = document.createElement('div');
    header.className = 'patient-header';
    const name = document.createElement(alert.patientId ? 'a' : 'div');
    name.className = alert.patientId ? 'patient-name patient-link' : 'patient-name';
    if (alert.patientId) {
      name.href = buildTreatmentAppLink_(alert.patientId);
      name.target = '_top';
      name.rel = 'noreferrer';
    }
    name.textContent = alert.patientName || '氏名未登録';
    header.appendChild(name);
    const tags = document.createElement('div');
    tags.style.display = 'flex';
    tags.style.gap = '6px';
    tags.style.flexWrap = 'wrap';
    if (alert.patientId) tags.appendChild(makeBadge('ID: ' + alert.patientId));
    header.appendChild(tags);
    card.appendChild(header);

    const metrics = document.createElement('div');
    metrics.className = 'alert-metrics';
    const months = document.createElement('span');
    months.className = 'badge';
    months.textContent = `連続${alert.consecutiveMonths}ヶ月`;
    metrics.appendChild(months);
    const amount = document.createElement('span');
    amount.className = 'alert-amount';
    amount.textContent = formatCurrency(alert.totalAmount);
    metrics.appendChild(amount);
    card.appendChild(metrics);

    if (Array.isArray(alert.months) && alert.months.length) {
      const monthList = document.createElement('div');
      monthList.className = 'alert-months';
      monthList.textContent = '対象月: ' + alert.months.map(m => m.key).join(', ');
      card.appendChild(monthList);
    }

    list.appendChild(card);
  });
}

function renderVisits() {
  const list = document.getElementById('visitList');
  if (!list) return;
  list.innerHTML = '';

  const visits = dashboardState.data && Array.isArray(dashboardState.data.todayVisits)
    ? dashboardState.data.todayVisits
    : [];

  if (!visits.length) {
    const empty = document.createElement('div');
    empty.className = 'muted';
    empty.textContent = '訪問データはありません';
    list.appendChild(empty);
    return;
  }

  const grouped = visits.reduce((map, entry) => {
    const key = entry.dateKey || '不明';
    if (!map[key]) map[key] = [];
    map[key].push(entry);
    return map;
  }, {});

  Object.keys(grouped).sort().forEach(dateKey => {
    const header = document.createElement('div');
    header.className = 'muted';
    header.textContent = formatDateLabel(dateKey);
    list.appendChild(header);

    grouped[dateKey].forEach(v => {
      const row = document.createElement('div');
      row.className = 'visit';
      const time = document.createElement('div');
      time.className = 'visit-time';
      time.textContent = v.time || '--:--';
      row.appendChild(time);

      const body = document.createElement('div');
      body.className = 'visit-body';
      const name = document.createElement(v.patientId ? 'a' : 'div');
      if (v.patientId) {
        name.href = buildTreatmentAppLink_(v.patientId);
        name.target = '_top';
        name.rel = 'noreferrer';
        name.className = 'patient-link';
      }
      name.textContent = v.patientName || v.patientId || '患者不明';
      name.style.fontWeight = '700';
      body.appendChild(name);

      const meta = document.createElement('div');
      meta.className = 'meta-row';
      const badge = document.createElement('span');
      const hasNote = v.noteStatus === '◎';
      badge.className = `badge ${hasNote ? 'success' : 'warn'}`;
      badge.textContent = hasNote ? '報告書作成ヒントあり' : '報告書作成ヒント未入力';
      meta.appendChild(badge);
      if (v.patientId) {
        const idBadge = document.createElement('span');
        idBadge.className = 'badge';
        idBadge.textContent = v.patientId;
        meta.appendChild(idBadge);
      }
      body.appendChild(meta);
      row.appendChild(body);

      list.appendChild(row);
    });
  });
}

function renderPatients() {
  const list = document.getElementById('patientList');
  const count = document.getElementById('patientCount');
  if (!list) return;
  list.innerHTML = '';

  const patients = dashboardState.data && Array.isArray(dashboardState.data.patients)
    ? dashboardState.data.patients.slice().sort((a, b) => (a.name || '').localeCompare(b.name || '', 'ja'))
    : [];

  if (count) count.textContent = patients.length ? `${patients.length}名` : '患者データなし';

  if (!patients.length) {
    const empty = document.createElement('div');
    empty.className = 'muted';
    empty.textContent = '患者データはありません';
    list.appendChild(empty);
    return;
  }

  patients.forEach(p => {
    const details = document.createElement('details');
    details.className = 'patient';
    details.dataset.patientId = p.patientId || '';

    const summary = document.createElement('summary');
    const header = document.createElement('div');
    header.className = 'patient-header';
    const name = document.createElement(p.patientId ? 'a' : 'div');
    name.className = p.patientId ? 'patient-name patient-link' : 'patient-name';
    if (p.patientId) {
      name.href = buildTreatmentAppLink_(p.patientId);
      name.target = '_top';
      name.rel = 'noreferrer';
    }
    name.textContent = p.name || '氏名未登録';
    header.appendChild(name);

    const tags = document.createElement('div');
    tags.style.display = 'flex';
    tags.style.gap = '6px';
    tags.style.flexWrap = 'wrap';

    if (p.note && p.note.unread) {
      const unread = document.createElement('span');
      unread.className = 'tag';
      unread.textContent = '未読報告書作成ヒント';
      tags.appendChild(unread);
    }
    if (p.responsible) {
      const resp = document.createElement('span');
      resp.className = 'tag';
      resp.textContent = p.responsible;
      tags.appendChild(resp);
    }
    header.appendChild(tags);
    summary.appendChild(header);

    const meta = document.createElement('div');
    meta.className = 'meta-row';
    if (p.consentExpiry) meta.appendChild(makeBadge('同意期限: ' + p.consentExpiry));
    if (p.aiReportAt) meta.appendChild(makeBadge('AI報告: ' + p.aiReportAt));
    if (p.invoiceUrl) meta.appendChild(makeBadge('請求書リンクあり'));
    summary.appendChild(meta);

    details.appendChild(summary);

    const body = document.createElement('div');
    body.className = 'patient-body';

    const fields = document.createElement('div');
    fields.className = 'meta-row';
    if (p.patientId) fields.appendChild(makeBadge('ID: ' + p.patientId));
    if (p.note && p.note.when) fields.appendChild(makeBadge('最終報告書作成ヒント: ' + p.note.when));
    if (p.note && p.note.lastReadAt) fields.appendChild(makeBadge('最終既読: ' + p.note.lastReadAt));
    body.appendChild(fields);

    if (p.note && p.note.preview) {
      const note = document.createElement('div');
      note.className = 'note-preview';
      note.textContent = p.note.preview;
      body.appendChild(note);
    }

    if (p.invoiceUrl) {
      const link = document.createElement('a');
      link.href = p.invoiceUrl;
      link.textContent = '請求書PDFを開く';
      link.target = '_blank';
      link.rel = 'noreferrer';
      body.appendChild(link);
    }

    details.appendChild(body);

    details.addEventListener('toggle', () => {
      if (details.open) markNoteAsRead(p);
    });

    list.appendChild(details);
  });
}

function markNoteAsRead(patient) {
  const pid = patient && patient.patientId;
  if (!pid || !patient.note || !patient.note.unread) return;
  if (dashboardState.marking.has(pid)) return;

  const runner = typeof google !== 'undefined' && google.script && google.script.run;
  if (!runner || typeof runner.markAsRead !== 'function') {
    markPatientNoteLocally_(pid);
    return;
  }

  dashboardState.marking.add(pid);
  runner.withSuccessHandler(res => {
    dashboardState.marking.delete(pid);
    if (res && res.ok && dashboardState.data && Array.isArray(dashboardState.data.patients)) {
      const target = dashboardState.data.patients.find(entry => entry.patientId === pid);
      if (target && target.note) {
        target.note.unread = false;
        target.note.lastReadAt = res.readAt || target.note.lastReadAt || '';
        renderPatients();
      }
    }
  }).withFailureHandler(() => {
    dashboardState.marking.delete(pid);
  }).markAsRead({ patientId: pid });
}

function markPatientNoteLocally_(pid) {
  if (!dashboardState.data || !Array.isArray(dashboardState.data.patients)) return;
  const target = dashboardState.data.patients.find(entry => entry.patientId === pid);
  if (!target || !target.note) return;
  target.note.unread = false;
  target.note.lastReadAt = target.note.lastReadAt || new Date().toISOString();
  renderPatients();
}

function makeBadge(text) {
  const span = document.createElement('span');
  span.className = 'badge';
  span.textContent = text;
  return span;
}

function renderSummaryCard_(container, options) {
  const opts = options || {};
  container.innerHTML = '';

  const header = document.createElement('div');
  header.className = 'summary-header';
  const title = document.createElement('h3');
  title.textContent = opts.title || '';
  header.appendChild(title);
  const count = document.createElement('div');
  count.className = 'summary-count';
  count.textContent = `${opts.count || 0}件`;
  header.appendChild(count);
  container.appendChild(header);

  const items = Array.isArray(opts.items) ? opts.items : [];
  container.appendChild(renderSummaryList_(items, opts.emptyText || '対象はありません'));
}

function renderSummaryList_(items, emptyText) {
  const filteredItems = (items || []).filter(item => item && item.patientId);
  if (!filteredItems.length) {
    const empty = document.createElement('div');
    empty.className = 'muted';
    empty.textContent = emptyText || '対象はありません';
    return empty;
  }

  const list = document.createElement('ul');
  list.className = 'summary-list';
  filteredItems
    .slice()
    .sort((a, b) => (a.name || '').localeCompare(b.name || '', 'ja'))
    .forEach(item => {
      const row = document.createElement('li');
      const main = document.createElement('div');
      main.className = 'summary-main';
      const link = document.createElement('a');
      link.className = 'summary-link';
      link.href = buildTreatmentAppLink_(item.patientId);
      link.target = '_top';
      link.rel = 'noreferrer';
      link.textContent = item.name || item.patientId;
      main.appendChild(link);
      if (item.subText) {
        const sub = document.createElement('div');
        sub.className = 'summary-subtext';
        sub.textContent = item.subText;
        main.appendChild(sub);
      }
      row.appendChild(main);
      if (item.badge) {
        const badge = document.createElement('span');
        badge.className = 'badge';
        badge.textContent = item.badge;
        row.appendChild(badge);
      }
      list.appendChild(row);
    });
  return list;
}

function buildTreatmentAppLink_(patientId) {
  const base = typeof baseUrl !== 'undefined' ? String(baseUrl) : '';
  const normalizedBase = base.replace(/\/+$/, '');
  const id = encodeURIComponent(patientId || '');
  return `${normalizedBase}/treatmentApp?patientId=${id}`;
}
function formatTaskLabel(type) {
  switch(type) {
    case 'consentExpired': return '同意書期限切れ';
    case 'consentWarning': return '同意書期限間近';
    case 'handoverDelayed': return '報告書作成ヒント未入力';
    case 'aiReportDelayed': return '医師報告書遅延';
    case 'invoiceUnconfirmed': return '請求書確認待ち';
    default: return 'タスク';
  }
}
function formatCurrency(amount) {
  const num = Number(amount) || 0;
  try {
    return num.toLocaleString('ja-JP', { style: 'currency', currency: 'JPY', maximumFractionDigits: 0 });
  } catch (_err) {
    return `¥${num.toFixed(0)}`;
  }
}

function formatDateLabel(key) {
  if (!key) return '日付不明';
  const today = new Date();
  const todayKey = keyFromDate(today);
  const yesterdayKey = keyFromDate(new Date(today.getTime() - 86400000));
  if (key === todayKey) return '今日';
  if (key === yesterdayKey) return '昨日';
  const parsed = new Date(key);
  if (!Number.isNaN(parsed.getTime())) {
    return parsed.toLocaleDateString('ja-JP', { month: 'short', day: 'numeric', weekday: 'short' });
  }
  return key;
}

function keyFromDate(date) {
  const y = date.getFullYear();
  const m = String(date.getMonth() + 1).padStart(2, '0');
  const d = String(date.getDate()).padStart(2, '0');
  return `${y}-${m}-${d}`;
}

function resolveDashboardMockParam_() {
  if (typeof dashboardMockFlag !== 'undefined' && dashboardMockFlag) return dashboardMockFlag;
  if (typeof window === 'undefined' || !window.location || !window.location.search) return '';
  const search = new URLSearchParams(window.location.search);
  return search.get('mock') || '';
}
</script>
</body>
</html>
