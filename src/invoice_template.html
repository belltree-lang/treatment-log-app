<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>請求書</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    @page { size: A4; margin: 18mm; }
    * { box-sizing: border-box; }
    body { font-family: 'Noto Sans JP', 'Noto Sans', -apple-system, 'Segoe UI', sans-serif; margin: 0; color: #0f172a; }
    .wrapper { display: flex; flex-direction: column; gap: 16px; }
    .header { display: flex; justify-content: space-between; align-items: flex-start; }
    .brand { font-weight: 700; font-size: 20px; letter-spacing: 0.04em; }
    .meta { text-align: right; color: #475569; font-size: 12px; }
    .card { border: 1px solid #e2e8f0; border-radius: 12px; padding: 14px 16px; background: #f8fafc; }
    .section-title { font-weight: 700; margin: 0 0 6px; font-size: 14px; }
    .info { display: grid; grid-template-columns: 110px 1fr; row-gap: 6px; column-gap: 8px; font-size: 14px; }
    .info .label { color: #475569; }
    table { width: 100%; border-collapse: collapse; margin-top: 8px; font-size: 14px; }
    th, td { border: 1px solid #e2e8f0; padding: 8px 10px; text-align: left; }
    th { background: #e5f0ff; font-weight: 700; }
    td.amount { text-align: right; }
    tfoot td { font-weight: 700; background: #edf2f7; }
    .subtable { width: 100%; border-collapse: collapse; margin-top: 8px; font-size: 12px; }
    .subtable th, .subtable td { border: 1px solid #e2e8f0; padding: 6px 8px; text-align: left; }
    .subtable th.amount, .subtable td.amount { text-align: right; }
    .subsection-title { margin: 10px 0 4px; font-weight: 700; font-size: 13px; }
    .note { color: #475569; font-size: 12px; margin-top: 6px; }
    .divider { border: 0; border-top: 1px dashed #cbd5e1; margin: 4px 0 2px; }
    .watermark {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 120px;
      font-weight: 700;
      color: #cbd5e1;
      opacity: 0.22;
      transform: rotate(-45deg);
      pointer-events: none;
      user-select: none;
      white-space: nowrap;
      z-index: 0;
    }
    .wrapper { position: relative; z-index: 1; }
    .charge-period-label { display: block; margin-top: 4px; color: #475569; font-weight: 400; font-size: 12px; }
  </style>
</head>
<body>
  <? var watermark = data && data.watermark; ?>
  <? if (watermark && watermark.text) { ?>
    <div class="watermark"><?= watermark.text ?></div>
  <? } ?>
  <div class="wrapper">
    <header class="header">
      <? var isAggregateInvoice = data.isAggregateInvoice || data.invoiceMode === 'aggregate'; ?>
      <? var chargeMonthLabel = data.chargeMonthLabel || data.monthLabel; ?>
      <? var chargePeriodLabel = buildInvoiceChargePeriodLabel_(data); ?>
      <div>
        <div class="brand">べるつりー訪問鍼灸マッサージ</div>
        <div class="note"><?= isAggregateInvoice ? '合算／未回収考慮モード' : '月次請求書' ?></div>
      </div>
      <div class="meta">
        <div><?= isAggregateInvoice ? '請求対象: ' : '請求月: ' ?><?= chargeMonthLabel ?></div>
        <div>発行日: <?= Utilities.formatDate(new Date(), Session.getScriptTimeZone() || 'Asia/Tokyo', 'yyyy年MM月dd日') ?></div>
      </div>
    </header>

    <section class="card">
      <h3 class="section-title">請求先</h3>
      <div class="info">
        <div class="label">氏名</div>
        <div><?= data.nameKanji ?></div>
        <div class="label">保険区分</div>
        <div><?= data.insuranceType || '―' ?> / <?= data.burdenRate ? data.burdenRate + '割' : '―' ?></div>
      <div class="label">対象期間</div>
      <div><?= chargeMonthLabel || '―' ?></div>
    </div>
  </section>

  <section class="card">
    <h3 class="section-title">ご請求内容（<?= isAggregateInvoice ? '未回収合算' : '当月' ?>）</h3>
      <? var aggregateMonthTotals = Array.isArray(data.aggregateMonthTotals)
        ? data.aggregateMonthTotals
        : [];
      ?>
      <? if (isAggregateInvoice) { ?>
        <div class="subsection-title">月別内訳</div>
        <table class="subtable">
          <thead>
            <tr><th>年月</th><th class="amount">月合計金額</th></tr>
          </thead>
          <tbody>
            <? aggregateMonthTotals.forEach(function(row) { ?>
              <tr>
                <td><?= row.monthLabel || normalizeBillingMonthLabel_(row.month) ?></td>
                <td class="amount"><?= formatBillingCurrency_(row.total || 0) ?> 円</td>
              </tr>
            <? }); ?>
          </tbody>
          <tfoot>
            <tr>
              <td>合算請求額</td>
              <td class="amount">
                <?= formatBillingCurrency_(data.grandTotal) ?> 円
                <? if (chargePeriodLabel) { ?>
                  <span class="charge-period-label">対象期間: <?= chargePeriodLabel ?></span>
                <? } ?>
              </td>
            </tr>
          </tfoot>
        </table>
      <? } else { ?>
        <table>
          <thead>
            <tr><th>項目</th><th>詳細</th><th class="amount">金額</th></tr>
          </thead>
          <tbody>
            <? data.rows.forEach(function(row) { ?>
              <tr>
                <td><?= row.label ?></td>
                <td><?= row.detail || '' ?></td>
                <td class="amount"><?= formatBillingCurrency_(row.amount) ?> 円</td>
              </tr>
            <? }); ?>
          </tbody>
          <tfoot>
            <tr>
              <td colspan="2">合計</td>
              <td class="amount">
                <?= formatBillingCurrency_(data.grandTotal) ?> 円
                <? if (chargePeriodLabel) { ?>
                  <span class="charge-period-label">対象期間: <?= chargePeriodLabel ?></span>
                <? } ?>
              </td>
            </tr>
          </tfoot>
        </table>
      <? } ?>
      <div class="note"><?= isAggregateInvoice ? '未回収期間を含めた合計金額です。（前月未回収分を含む）' : '前月繰越を含む合計金額です。' ?>口座振替日：毎月20日（祝日の場合は翌営業日）</div>
      <? if (data.aggregateRemark) { ?>
        <div class="note"><strong>備考:</strong> <?= data.aggregateRemark ?></div>
      <? } ?>
    </section>

    <hr class="divider">

    <? var receipt = data.previousReceipt || data.receipt || {}; ?>
    <?
      var showReceipt = !!receipt.visible;
    ?>
    <? var receiptAddressee = receipt.addressee || data.nameKanji || ''; ?>
    <? var receiptDate = receipt.date || receipt.receiptDate || ''; ?>
    <? var receiptAmount = receipt.amount != null ? receipt.amount : receipt.total != null ? receipt.total : receipt.price; ?>
    <? var receiptNote = receipt.note || receipt.description || ''; ?>
    <? if (!data.forceHideReceipt) { ?>
      <section class="card">
        <h3 class="section-title">前月分領収書</h3>
        <? if (showReceipt) { ?>
        <div class="info">
          <div class="label">宛名</div>
          <div><?= receiptAddressee || '―' ?></div>
          <div class="label">領収日</div>
          <div><?= receiptDate || '―' ?></div>
          <div class="label">金額</div>
          <div><?= formatBillingCurrency_(receiptAmount || 0) ?> 円</div>
          <div class="label">但し書き</div>
          <div><?= receiptNote || '―' ?></div>
          <div class="label">発行者</div>
          <div>株式会社べるつりー</div>
        </div>
      <? } else { ?>
          <div class="note">前月分は未入金のため、後日合算して請求されます</div>
        <? } ?>
      </section>
    <? } ?>
  </div>
</body>
</html>
