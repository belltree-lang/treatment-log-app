<script>
const billingState = {
  loading: false,
  result: null,
  prepared: null,
  statusMessage: '',
  edits: {},
  editing: null,
  sort: { field: null, direction: 'asc' }
};

const BILLING_INSURANCE_OPTIONS = ['後期高齢', '国保', '社保', '生保', '自費', 'マッサージ'];
const BILLING_BURDEN_OPTIONS = [
  { value: 1, label: '1割' },
  { value: 2, label: '2割' },
  { value: 3, label: '3割' },
  { value: '自費', label: '自費' }
];
const BILLING_PAYER_OPTIONS = ['保険', '自費'];
const BILLING_TREATMENT_PRICE = 4070;
const BILLING_ELECTRO_PRICE = 100;
const BILLING_UNIT_PRICE = BILLING_TREATMENT_PRICE + BILLING_ELECTRO_PRICE;
const BILLING_TRANSPORT_UNIT_PRICE_FALLBACK = 33;
const BILLING_TRANSPORT_UNIT_PRICE = (typeof globalThis !== 'undefined' && typeof globalThis.BILLING_TRANSPORT_UNIT_PRICE === 'number')
  ? globalThis.BILLING_TRANSPORT_UNIT_PRICE
  : BILLING_TRANSPORT_UNIT_PRICE_FALLBACK;
const BILLING_TREATMENT_UNIT_PRICE_BY_BURDEN = { 1: 417, 2: 834, 3: 1251 };

function qs(id) {
  return document.getElementById(id);
}

function getDefaultMonth() {
  const today = new Date();
  const prevMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
  const y = prevMonth.getFullYear();
  const m = String(prevMonth.getMonth() + 1).padStart(2, '0');
  return y + '-' + m;
}

function updateBillingControls() {
  const monthInput = qs('billingMonth');
  const aggregateBtn = qs('billingAggregateBtn');
  const pdfBtn = qs('billingPdfBtn');
  const loading = billingState.loading;

  if (monthInput) {
    monthInput.disabled = loading;
  }
  if (aggregateBtn) {
    aggregateBtn.disabled = loading;
    aggregateBtn.setAttribute('aria-busy', loading ? 'true' : 'false');
  }
  if (pdfBtn) {
    const prepared = !!(billingState.prepared && billingState.prepared.billingMonth);
    const disabled = loading || !prepared;
    pdfBtn.disabled = disabled;
    pdfBtn.setAttribute('aria-busy', loading ? 'true' : 'false');
    pdfBtn.title = disabled && !prepared ? '先に「請求データを集計」を実行してください' : '';
  }
}

function normalizeYm(raw) {
  if (!raw) return '';
  const cleaned = String(raw).replace(/[^0-9]/g, '');
  if (cleaned.length === 6) return cleaned;
  if (cleaned.length === 4) return cleaned + '01';
  return '';
}

function setBillingLoading(flag, message) {
  billingState.loading = !!flag;
  billingState.statusMessage = flag ? (message || '生成中…') : '';
  renderBillingResult();
}

function normalizeEditNumber(value) {
  if (value === '' || value === null || value === undefined) return 0;
  const num = Number(value);
  return Number.isFinite(num) ? num : 0;
}

function normalizeBurdenRateDisplay(value) {
  if (value === '自費') return '自費';
  const num = Number(value);
  if (!Number.isFinite(num) || num <= 0) return '';
  return num + '割';
}

function resolveFrontEndUnitPrice(insuranceType, burdenRate, customUnitPrice) {
  const type = String(insuranceType || '').trim();
  if (type === '自費') {
    const custom = normalizeEditNumber(customUnitPrice);
    return custom > 0 ? custom : 0;
  }
  if (type === '生保' || type === 'マッサージ') return 0;
  const normalizedBurden = burdenRate === '自費' ? 0 : Number(burdenRate);
  return BILLING_TREATMENT_UNIT_PRICE_BY_BURDEN[normalizedBurden] || BILLING_UNIT_PRICE;
}

function recalculateBillingRow(row) {
  const visits = normalizeEditNumber(row.visitCount);
  const unitPrice = resolveFrontEndUnitPrice(row.insuranceType, row.burdenRate, row.unitPrice);
  const treatmentAmount = visits > 0 ? unitPrice * visits : 0;
  const transportAmount = visits > 0 ? BILLING_TRANSPORT_UNIT_PRICE * visits : 0;
  const carryOverAmount = normalizeEditNumber(row.carryOverAmount);
  const grandTotal = treatmentAmount + transportAmount + carryOverAmount;
  return Object.assign({}, row, {
    unitPrice,
    treatmentAmount,
    transportAmount,
    carryOverAmount,
    grandTotal
  });
}

function getBillingBaseUrl() {
  return (window.APP_CONFIG && window.APP_CONFIG.baseUrl) || '';
}

function getMergedBillingRows() {
  const baseRows = (billingState.result && billingState.result.billingJson) || [];
  return baseRows.map(row => {
    const edits = billingState.edits[row.patientId] || {};
    const merged = Object.assign({}, row, edits);
    return recalculateBillingRow(merged);
  });
}

function getResponsibleDisplay(item) {
  if (!item) return '';
  if (item.responsibleName) return item.responsibleName;
  if (Array.isArray(item.responsibleNames) && item.responsibleNames.length) {
    return item.responsibleNames.join('・');
  }
  return item.responsibleEmail || '';
}

function resolveBurdenSortValue(value) {
  if (value === '自費') return 99;
  const num = Number(value);
  if (Number.isFinite(num)) return num;
  return 0;
}

function resolveBillingSortValue(row, field) {
  switch (field) {
    case 'nameKanji':
      return row.nameKanji || '';
    case 'insuranceType':
      return row.insuranceType || '';
    case 'burdenRate':
      return resolveBurdenSortValue(row.burdenRate);
    case 'unitPrice':
      return Number(row.unitPrice) || 0;
    case 'visitCount':
      return Number(row.visitCount) || 0;
    case 'grandTotal':
      return Number(row.grandTotal) || 0;
    case 'responsible':
      return getResponsibleDisplay(row);
    case 'address':
      return row.address || '';
    case 'patientId':
      return row.patientId || '';
    default:
      return null;
  }
}

function sortBillingRows(rows) {
  const sort = billingState.sort || {};
  if (!sort.field) return rows;
  const dir = sort.direction === 'desc' ? -1 : 1;
  return rows.slice().sort((a, b) => {
    const va = resolveBillingSortValue(a, sort.field);
    const vb = resolveBillingSortValue(b, sort.field);
    if (va == null && vb == null) return 0;
    if (va == null) return 1;
    if (vb == null) return -1;
    if (typeof va === 'number' && typeof vb === 'number') {
      return (va - vb) * dir;
    }
    return String(va).localeCompare(String(vb), 'ja') * dir;
  });
}

function getDisplayBillingRows() {
  const merged = getMergedBillingRows();
  return sortBillingRows(merged);
}

function toggleBillingSort(field) {
  if (!field) return;
  const current = billingState.sort || {};
  if (current.field === field) {
    billingState.sort = { field, direction: current.direction === 'asc' ? 'desc' : 'asc' };
  } else {
    billingState.sort = { field, direction: 'asc' };
  }
  renderBillingResult();
}

function commitBillingEdit(patientId, field, value) {
  const pid = String(patientId || '').trim();
  if (!pid) return;
  billingState.edits[pid] = Object.assign({}, billingState.edits[pid] || {}, { [field]: value });
  billingState.editing = null;
  renderBillingResult();
}

function startBillingEdit(patientId, field) {
  billingState.editing = { patientId, field };
  renderBillingResult();
}

function ensureBillingRoute() {
  const baseUrl = getBillingBaseUrl();
  if (!baseUrl || typeof window === 'undefined') return;
  const targetUrl = baseUrl + '?view=billing';
  if (window.location.href !== targetUrl) {
    window.history.replaceState({}, '', targetUrl);
  }
}

function loadBillingPage() {
  initBillingPage();
}

function handleBillingAggregation() {
  const ym = normalizeYm(qs('billingMonth').value);
  if (!ym) {
    alert('請求月を入力してください (YYYY-MM)');
    return;
  }
  setBillingLoading(true, '集計中…');
  google.script.run
    .withSuccessHandler(onBillingPrepared)
    .withFailureHandler(onBillingFailed)
    .prepareBillingData(ym);
}

function onBillingPrepared(result) {
  billingState.result = result || null;
  billingState.prepared = result || null;
  billingState.loading = false;
  billingState.statusMessage = '集計が完了しました。内容確認後にPDFを生成してください。';
  billingState.edits = {};
  billingState.editing = null;
  renderBillingResult();
}

function handleBillingPdfGeneration() {
  if (!billingState.prepared || !billingState.prepared.billingMonth) {
    alert('先に「請求データを集計」を実行してください。');
    return;
  }
  setBillingLoading(true, 'PDF生成中…');
  google.script.run
    .withSuccessHandler(onBillingPdfCompleted)
    .withFailureHandler(onBillingFailed)
    .applyBillingEditsAndGenerateInvoices(billingState.prepared.billingMonth, {
      edits: Object.keys(billingState.edits || {}).map(pid => Object.assign({ patientId: pid }, billingState.edits[pid]))
    });
}

function onBillingPdfCompleted(result) {
  billingState.result = result || null;
  billingState.prepared = result || billingState.prepared;
  billingState.loading = false;
  billingState.statusMessage = 'PDF生成と担当者フォルダへの保存が完了しました';
  billingState.edits = {};
  billingState.editing = null;
  renderBillingResult();
}

function onBillingFailed(err) {
  console.error('[billing generation failed]', err);
  const msg = err && err.message ? err.message : String(err);
  billingState.loading = false;
  billingState.statusMessage = '請求処理に失敗しました';
  renderBillingResult();
  alert('請求生成に失敗しました: ' + msg);
}

function formatCurrency(value) {
  const num = Number(value);
  if (!Number.isFinite(num)) return '-';
  return num.toLocaleString('ja-JP') + ' 円';
}

function renderBillingStatus(result) {
  const el = qs('billingStatus');
  if (!el) return;
  if (billingState.loading) {
    el.innerHTML = `<span class="loading"><span class="spinner"></span>${billingState.statusMessage || '生成中…'}</span>`;
    return;
  }
  if (billingState.statusMessage) {
    el.textContent = billingState.statusMessage;
    return;
  }
  if (billingState.prepared) {
    el.textContent = result && result.files && result.files.length
      ? 'PDF生成が完了しました'
      : '集計済み（PDF未生成）';
    return;
  }
  el.textContent = '';
}

function renderDownloads(result) {
  const box = qs('downloads');
  if (!box) return;
  box.innerHTML = '';
  if (billingState.loading) {
    box.innerHTML = `<div class="loading"><span class="spinner"></span>ファイル生成中…</div>`;
    return;
  }
  const files = (result && Array.isArray(result.files)) ? result.files.filter(file => file && file.url) : [];
  if (!files.length) {
    box.innerHTML = billingState.prepared
      ? '<div class="muted">集計済みです。PDF生成ボタンを押してください。</div>'
      : '<div class="muted">出力ファイルはまだありません。</div>';
    return;
  }
  box.innerHTML = files.map(link => `
    <a class="download-link" href="${link.url}" target="_blank" rel="noopener">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <path d="M12 3v14" /><path d="M5 10l7 7 7-7" /><path d="M5 21h14" />
      </svg>
      <div>
        <div>${link.name || '請求書PDF'}</div>
        <small class="muted" style="display:block;">${link.nameKanji || link.patientId || ''}</small>
      </div>
    </a>`).join('');
}

function renderMonthBadge(result) {
  const label = qs('billingMonthLabel');
  if (!label) return;
  if (result && result.billingMonth) {
    label.style.display = 'inline-flex';
    label.textContent = '請求月: ' + result.billingMonth;
  } else {
    label.style.display = 'none';
    label.textContent = '';
  }
}

function renderBillingResult() {
  updateBillingControls();
  const box = qs('billingResult');
  if (!box) return;
  const result = billingState.result;
  renderBillingStatus(result);
  renderDownloads(result);
  renderMonthBadge(result);

  if (billingState.loading) {
    box.innerHTML = '<div class="loading"><span class="spinner"></span>請求データを生成中です…</div>';
    return;
  }
  if (!result || !result.billingJson || !result.billingJson.length) {
    box.innerHTML = '<div class="muted">まだ請求を生成していません。</div>';
    return;
  }

  const rows = getDisplayBillingRows();
  const header = [
    { key: 'patientId', label: '患者ID', sortable: true },
    { key: 'nameKanji', label: '氏名', sortable: true },
    { key: 'responsible', label: '担当者', sortable: true },
    { key: 'address', label: '住所', sortable: true },
    { key: 'insuranceType', label: '保険種別', sortable: true },
    { key: 'payerType', label: '保険者', sortable: false },
    { key: 'burdenRate', label: '負担', sortable: true },
    { key: 'visitCount', label: '回数', sortable: true },
    { key: 'unitPrice', label: '単価', sortable: true },
    { key: 'treatmentAmount', label: '施術料', sortable: false },
    { key: 'transportAmount', label: '交通費', sortable: false },
    { key: 'carryOverAmount', label: '繰越', sortable: false },
    { key: 'grandTotal', label: '合計', sortable: true }
  ];

  function renderSortHeaderCell(h) {
    if (!h.sortable) {
      return `<th>${h.label}</th>`;
    }
    const active = billingState.sort && billingState.sort.field === h.key;
    const indicator = active ? (billingState.sort.direction === 'asc' ? '▲' : '▼') : '';
    const thClass = h.sortable ? 'sortable' : '';
    return `<th class="${thClass}"><button type="button" class="sort-header" data-sort-key="${h.key}">${h.label}${indicator ? `<span class="sort-indicator">${indicator}</span>` : ''}</button></th>`;
  }

  function renderEditableCell(item, field, alignRight) {
    const editing = billingState.editing && billingState.editing.patientId === item.patientId && billingState.editing.field === field;
    const baseAttrs = `data-edit-field="${field}" data-edit-patient="${item.patientId}"`;
    const editClass = alignRight ? 'cell-edit inline-editor right' : 'cell-edit inline-editor';
    const viewClass = alignRight ? 'cell-edit right' : 'cell-edit';
    if (editing) {
      if (field === 'insuranceType') {
        return `<select class="${editClass}" ${baseAttrs}>${BILLING_INSURANCE_OPTIONS.map(opt => `<option value="${opt}" ${opt === item.insuranceType ? 'selected' : ''}>${opt}</option>`).join('')}</select>`;
      }
      if (field === 'burdenRate') {
        return `<select class="${editClass}" ${baseAttrs}>${BILLING_BURDEN_OPTIONS.map(opt => `<option value="${opt.value}" ${String(opt.value) === String(item.burdenRate) ? 'selected' : ''}>${opt.label}</option>`).join('')}</select>`;
      }
      if (field === 'payerType') {
        return `<select class="${editClass}" ${baseAttrs}>${BILLING_PAYER_OPTIONS.map(opt => `<option value="${opt}" ${opt === item.payerType ? 'selected' : ''}>${opt}</option>`).join('')}</select>`;
      }
      if (field === 'unitPrice' || field === 'carryOverAmount') {
        const val = normalizeEditNumber(item[field]);
        return `<input class="${editClass}" ${baseAttrs} type="number" step="10" value="${val}" />`;
      }
    }

    const display = (() => {
      switch (field) {
        case 'insuranceType':
          return item.insuranceType || '編集';
        case 'burdenRate':
          return normalizeBurdenRateDisplay(item.burdenRate) || '編集';
        case 'payerType':
          return item.payerType || '編集';
        case 'unitPrice':
          return formatCurrency(item.unitPrice);
        case 'carryOverAmount':
          return formatCurrency(item.carryOverAmount);
        default:
          return item[field] || '';
      }
    })();
    return `<button type="button" class="${viewClass}" ${baseAttrs} aria-label="${field} を編集">${display}</button>`;
  }

  const tableHtml = [
    '<table><thead><tr>',
    header.map(renderSortHeaderCell).join(''),
    '</tr></thead><tbody>',
    ...rows.map(item => `
      <tr>
        <td>${item.patientId || ''}</td>
        <td>${item.nameKanji || ''}</td>
        <td>${getResponsibleDisplay(item)}</td>
        <td>${item.address || ''}</td>
        <td>${renderEditableCell(item, 'insuranceType')}</td>
        <td>${renderEditableCell(item, 'payerType')}</td>
        <td>${renderEditableCell(item, 'burdenRate')}</td>
        <td>${item.visitCount || 0}</td>
        <td class="right">${renderEditableCell(item, 'unitPrice', true)}</td>
        <td class="right">${formatCurrency(item.treatmentAmount)}</td>
        <td class="right">${formatCurrency(item.transportAmount)}</td>
        <td class="right">${renderEditableCell(item, 'carryOverAmount', true)}</td>
        <td class="right">${formatCurrency(item.grandTotal)}</td>
      </tr>`),
    '</tbody></table>'
  ].join('');

  box.innerHTML = tableHtml;
  attachBillingEditHandlers();
  attachBillingSortHandlers();
}

function attachBillingEditHandlers() {
  const box = qs('billingResult');
  if (!box) return;
  box.querySelectorAll('button.cell-edit').forEach(btn => {
    btn.onclick = function () {
      const pid = this.getAttribute('data-edit-patient');
      const field = this.getAttribute('data-edit-field');
      startBillingEdit(pid, field);
    };
  });
  box.querySelectorAll('select.inline-editor, input.inline-editor').forEach(input => {
    input.onchange = function () {
      const pid = this.getAttribute('data-edit-patient');
      const field = this.getAttribute('data-edit-field');
      let value = this.value;
      if (field === 'burdenRate' && value !== '自費') {
        value = Number(value);
      }
      if (field === 'unitPrice' || field === 'carryOverAmount') {
        value = Number(value);
      }
      commitBillingEdit(pid, field, value);
    };
    input.onblur = input.onchange;
  });
}

function attachBillingSortHandlers() {
  const box = qs('billingResult');
  if (!box) return;
  box.querySelectorAll('button.sort-header').forEach(btn => {
    btn.onclick = function () {
      const field = this.getAttribute('data-sort-key');
      toggleBillingSort(field);
    };
  });
}

function initBillingPage() {
  ensureBillingRoute();
  const input = qs('billingMonth');
  if (input && !input.value) {
    input.value = getDefaultMonth();
  }
  updateBillingControls();
  renderBillingResult();
}

(function bootstrap() {
  const body = document.body;
  if (body && body.dataset) {
    window.APP_CONFIG = Object.assign({}, window.APP_CONFIG, {
      view: body.dataset.view || (window.APP_CONFIG && window.APP_CONFIG.view) || '',
      baseUrl: body.dataset.baseUrl || (window.APP_CONFIG && window.APP_CONFIG.baseUrl) || ''
    });
  }

  const view = (window.APP_CONFIG && window.APP_CONFIG.view) || '';
  if (view === 'billing') {
    initBillingPage();
  }
})();
</script>
