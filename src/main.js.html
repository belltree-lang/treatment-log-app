const billingState = {
  loading: false,
  result: null,
  statusMessage: ''
};

function qs(id) {
  return document.getElementById(id);
}

function getDefaultMonth() {
  const today = new Date();
  const y = today.getFullYear();
  const m = String(today.getMonth() + 1).padStart(2, '0');
  return y + '-' + m;
}

function normalizeYm(raw) {
  if (!raw) return '';
  const cleaned = String(raw).replace(/[^0-9]/g, '');
  if (cleaned.length === 6) return cleaned;
  if (cleaned.length === 4) return cleaned + '01';
  return '';
}

function setBillingLoading(flag, message) {
  billingState.loading = !!flag;
  billingState.statusMessage = flag ? (message || '生成中…') : '';
  if (flag) {
    billingState.result = null;
  }
  renderBillingResult();
}

function getBillingBaseUrl() {
  return (window.APP_CONFIG && window.APP_CONFIG.baseUrl) || '';
}

function ensureBillingRoute() {
  const baseUrl = getBillingBaseUrl();
  if (!baseUrl || typeof window === 'undefined') return;
  const targetUrl = baseUrl + '?view=billing';
  if (window.location.href !== targetUrl) {
    window.history.replaceState({}, '', targetUrl);
  }
}

function loadBillingPage() {
  initBillingPage();
}

function handleBillingGeneration() {
  const ym = normalizeYm(qs('billingMonth').value);
  if (!ym) {
    alert('請求月を入力してください (YYYY-MM)');
    return;
  }
  setBillingLoading(true);
  google.script.run
    .withSuccessHandler(onBillingCompleted)
    .withFailureHandler(onBillingFailed)
    .generateInvoices(ym, {});
}

function onBillingCompleted(result) {
  billingState.result = result || null;
  billingState.loading = false;
  billingState.statusMessage = '生成が完了しました';
  renderBillingResult();
}

function onBillingFailed(err) {
  console.error('[billing generation failed]', err);
  const msg = err && err.message ? err.message : String(err);
  billingState.loading = false;
  billingState.statusMessage = '請求生成に失敗しました';
  renderBillingResult();
  alert('請求生成に失敗しました: ' + msg);
}

function formatCurrency(value) {
  const num = Number(value);
  if (!Number.isFinite(num)) return '-';
  return num.toLocaleString('ja-JP') + ' 円';
}

function renderBillingStatus(result) {
  const el = qs('billingStatus');
  if (!el) return;
  if (billingState.loading) {
    el.innerHTML = `<span class="loading"><span class="spinner"></span>${billingState.statusMessage || '生成中…'}</span>`;
    return;
  }
  if (billingState.statusMessage) {
    el.textContent = billingState.statusMessage;
    return;
  }
  if (result) {
    el.textContent = '生成が完了しました';
    return;
  }
  el.textContent = '';
}

function renderDownloads(result) {
  const box = qs('downloads');
  if (!box) return;
  box.innerHTML = '';
  if (billingState.loading) {
    box.innerHTML = `<div class="loading"><span class="spinner"></span>ファイル生成中…</div>`;
    return;
  }
  const files = (result && Array.isArray(result.files)) ? result.files.filter(file => file && file.url) : [];
  if (!files.length) {
    box.innerHTML = '<div class="muted">出力ファイルはまだありません。</div>';
    return;
  }
  box.innerHTML = files.map(link => `
    <a class="download-link" href="${link.url}" target="_blank" rel="noopener">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <path d="M12 3v14" /><path d="M5 10l7 7 7-7" /><path d="M5 21h14" />
      </svg>
      <div>
        <div>${link.name || '請求書PDF'}</div>
        <small class="muted" style="display:block;">${link.nameKanji || link.patientId || ''}</small>
      </div>
    </a>`).join('');
}

function renderMonthBadge(result) {
  const label = qs('billingMonthLabel');
  if (!label) return;
  if (result && result.billingMonth) {
    label.style.display = 'inline-flex';
    label.textContent = '請求月: ' + result.billingMonth;
  } else {
    label.style.display = 'none';
    label.textContent = '';
  }
}

function renderBillingResult() {
  const box = qs('billingResult');
  if (!box) return;
  const result = billingState.result;
  renderBillingStatus(result);
  renderDownloads(result);
  renderMonthBadge(result);

  if (billingState.loading) {
    box.innerHTML = '<div class="loading"><span class="spinner"></span>請求データを生成中です…</div>';
    return;
  }
  if (!result || !result.billingJson || !result.billingJson.length) {
    box.innerHTML = '<div class="muted">まだ請求を生成していません。</div>';
    return;
  }

  const rows = result.billingJson;
  const header = ['患者ID','氏名','住所','保険種別','負担','回数','単価','施術料','交通費','繰越','合計'];
  const tableHtml = [
    '<table><thead><tr>',
    header.map(h => `<th>${h}</th>`).join(''),
    '</tr></thead><tbody>',
    ...rows.map(item => `
      <tr>
        <td>${item.patientId || ''}</td>
        <td>${item.nameKanji || ''}</td>
        <td>${item.address || ''}</td>
        <td>${item.insuranceType || ''}</td>
        <td>${item.burdenRate ? item.burdenRate + '割' : ''}</td>
        <td>${item.visitCount || 0}</td>
        <td class="right">${formatCurrency(item.unitPrice)}</td>
        <td class="right">${formatCurrency(item.treatmentAmount)}</td>
        <td class="right">${formatCurrency(item.transportAmount)}</td>
        <td class="right">${formatCurrency(item.carryOverAmount)}</td>
        <td class="right">${formatCurrency(item.grandTotal)}</td>
      </tr>`),
    '</tbody></table>'
  ].join('');

  box.innerHTML = tableHtml;
}

function initBillingPage() {
  ensureBillingRoute();
  const input = qs('billingMonth');
  if (input && !input.value) {
    input.value = getDefaultMonth();
  }
  renderBillingResult();
}

(function bootstrap() {
  const body = document.body;
  if (body && body.dataset) {
    window.APP_CONFIG = Object.assign({}, window.APP_CONFIG, {
      view: body.dataset.view || (window.APP_CONFIG && window.APP_CONFIG.view) || '',
      baseUrl: body.dataset.baseUrl || (window.APP_CONFIG && window.APP_CONFIG.baseUrl) || ''
    });
  }

  const view = (window.APP_CONFIG && window.APP_CONFIG.view) || '';
  if (view === 'billing') {
    initBillingPage();
  }
})();
