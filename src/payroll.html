<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>給与マスタ</title>
<style>
  :root{
    --bg:#f8fafc;
    --fg:#1f2937;
    --card:#fff;
    --border:#e5e7eb;
    --muted:#6b7280;
    --brand:#2563eb;
    --danger:#dc2626;
  }
  *{ box-sizing:border-box; }
  body{ margin:0; font-family:system-ui,-apple-system,"Segoe UI","Noto Sans JP",sans-serif; background:var(--bg); color:var(--fg); }
  .wrap{ max-width:1080px; margin:0 auto; padding:32px 16px 80px; display:flex; flex-direction:column; gap:20px; }
  .card{ background:var(--card); border-radius:18px; padding:24px; box-shadow:0 12px 34px rgba(15,23,42,0.08); display:flex; flex-direction:column; gap:16px; }
  .header h1{ margin:0; font-size:1.6rem; }
  .header p{ margin:4px 0 0; color:var(--muted); }
  table{ width:100%; border-collapse:collapse; font-size:0.9rem; }
  th,td{ border:1px solid var(--border); padding:10px 12px; text-align:left; vertical-align:top; }
  th{ background:#f3f4f6; font-weight:600; }
  .table-scroll{ overflow-x:auto; }
  .btn{ appearance:none; border:0; border-radius:999px; padding:8px 16px; font-size:0.9rem; font-weight:600; cursor:pointer; background:var(--brand); color:#fff; transition:transform .15s ease, box-shadow .15s ease; }
  .btn:hover{ transform:translateY(-1px); box-shadow:0 10px 24px rgba(37,99,235,0.18); }
  .btn:disabled{ opacity:.5; cursor:not-allowed; box-shadow:none; transform:none; }
  .btn.ghost{ background:#e5e7eb; color:var(--fg); box-shadow:none; }
  .btn.danger{ background:var(--danger); color:#fff; }
  .btn.small{ padding:6px 12px; font-size:0.8rem; }
  .section-header{ display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; }
  .form-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:14px; }
  .form-grid label{ display:flex; flex-direction:column; gap:6px; font-size:0.9rem; }
  .form-grid label small{ font-size:0.75rem; display:block; }
  input,select,textarea{ padding:10px 12px; border:1px solid var(--border); border-radius:10px; font-size:0.95rem; background:#fff; color:inherit; }
  textarea{ min-height:80px; resize:vertical; }
  .form-actions{ display:flex; flex-wrap:wrap; gap:12px; justify-content:flex-end; }
  .muted{ color:var(--muted); }
  .table-empty{ text-align:center; color:var(--muted); padding:24px 0; }
  .attendance-controls{ display:flex; gap:12px; align-items:flex-end; flex-wrap:wrap; }
  .attendance-controls label{ display:flex; flex-direction:column; gap:4px; font-size:0.85rem; color:var(--muted); }
  .metric-main{ font-weight:600; }
  .metric-subtext{ font-size:0.8rem; color:var(--muted); }
  .badge{ display:inline-flex; align-items:center; gap:4px; padding:2px 10px; border-radius:999px; font-size:0.75rem; font-weight:600; }
  .badge.info{ background:#e0f2fe; color:#0f172a; }
  .badge.danger{ background:#fee2e2; color:#7f1d1d; }
  .rate-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:12px; }
  .rate-grid label{ font-size:0.85rem; color:var(--muted); }
  .rate-grid input{ width:100%; }
  .rate-grid small{ display:block; font-size:0.75rem; color:var(--muted); margin-top:4px; }
  .table-note{ font-size:0.85rem; color:var(--muted); margin-top:8px; }
  .text-right{ text-align:right; }
  .insurance-summary-name{ display:flex; flex-direction:column; gap:4px; }
  .insurance-summary-name small{ color:var(--muted); font-size:0.8rem; }
  .insurance-summary-amount{ display:flex; flex-direction:column; gap:2px; }
  .insurance-summary-amount strong{ font-size:1rem; }
  .insurance-summary-note{ font-size:0.85rem; color:var(--muted); }
  .inline-controls{ display:flex; gap:8px; flex-wrap:wrap; align-items:flex-end; }
  .toast{ position:fixed; left:50%; bottom:28px; transform:translateX(-50%); background:#111827; color:#fff; padding:10px 18px; border-radius:999px; opacity:0; transition:opacity .3s ease; pointer-events:none; }
  .toast.show{ opacity:1; }
  .meta-line{ font-size:0.85rem; color:var(--muted); }
  @media (max-width:640px){
    th,td{ font-size:0.85rem; padding:8px; }
    .btn{ width:100%; text-align:center; }
    .form-actions{ flex-direction:column; align-items:stretch; }
  }
</style>
</head>
<body>
<div class="wrap">
  <header class="header">
    <h1>給与マスタ</h1>
    <p>従業員ごとの基本情報・手当・控除設定を管理します。</p>
  </header>

  <section class="card">
    <div class="section-header">
      <div>
        <h2>給与明細の一括生成</h2>
        <p class="meta-line">対象月を選び「全員まとめて生成」を押すと、各従業員のPDFを再計算して上書き保存します（前月以前の修正は不可）。</p>
      </div>
      <div class="inline-controls">
        <label>対象月
          <input type="month" id="bulkPayslipMonth" />
        </label>
        <button id="bulkPayslipButton" type="button" class="btn">全員まとめて生成</button>
      </div>
    </div>
    <div id="bulkPayslipStatus" class="meta-line"></div>
  </section>

  <section class="card">
    <div class="section-header">
      <h2>従業員一覧</h2>
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <button id="reloadButton" type="button" class="btn ghost">再読み込み</button>
        <button id="newButton" type="button" class="btn">新規登録</button>
      </div>
    </div>
    <div class="table-scroll">
      <table>
        <thead>
          <tr>
            <th>氏名</th>
            <th>拠点</th>
            <th>区分</th>
            <th>基本給</th>
            <th>時給</th>
            <th>個別加算</th>
            <th>役職/等級</th>
            <th>住民税</th>
            <th>源泉・扶養</th>
            <th>交通費</th>
            <th>歩合</th>
            <th>更新日時</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="employeeTableBody"><tr><td colspan="12" class="table-empty">読み込み中…</td></tr></tbody>
      </table>
    </div>
  </section>

  <section class="card">
    <div class="section-header">
      <div>
        <h2 id="formTitle">従業員を登録</h2>
        <div id="formMeta" class="meta-line"></div>
      </div>
    </div>
    <form id="employeeForm" autocomplete="off">
      <input type="hidden" id="employeeId" />
      <div class="form-grid">
        <label>氏名
          <input id="employeeName" type="text" required />
        </label>
        <label>メール
          <input id="employeeEmail" type="email" placeholder="name@example.com" />
        </label>
        <label>拠点
          <input id="employeeBase" type="text" placeholder="例：八王子" />
        </label>
        <label>雇用区分
          <select id="employmentType" required></select>
        </label>
        <label>役職/等級
          <input id="employeeGrade" type="text" list="gradeOptions" placeholder="例：院長 / S2" />
          <small class="muted" id="gradeAmountHint"></small>
        </label>
        <label>基本給（月額）
          <input id="baseSalary" type="number" min="0" step="1000" placeholder="円" />
        </label>
        <label>時給
          <input id="hourlyWage" type="number" min="0" step="50" placeholder="円" />
        </label>
        <label>個別加算
          <input id="personalAllowance" type="number" step="500" placeholder="円" />
        </label>
        <label>資格手当
          <input id="qualificationAllowance" type="number" step="500" placeholder="円" />
        </label>
        <label>車両手当
          <input id="vehicleAllowance" type="number" step="500" placeholder="円" />
        </label>
        <label>社宅控除
          <input id="housingDeduction" type="number" step="500" placeholder="円" />
        </label>
        <label>住民税
          <input id="municipalTax" type="number" min="0" step="1" placeholder="円" />
        </label>
        <label>交通費区分
          <select id="transportationType"></select>
        </label>
        <label>交通費金額
          <input id="transportationAmount" type="number" step="500" placeholder="固定の場合のみ" />
        </label>
        <label>歩合ロジック
          <select id="commissionLogic"></select>
        </label>
        <label>源泉徴収
          <select id="withholding"></select>
        </label>
        <label>扶養人数
          <input id="dependentCount" type="number" min="0" max="7" step="1" value="0" />
          <small class="muted">0〜10の範囲で入力</small>
        </label>
        <label>源泉区分
          <select id="withholdingCategory"></select>
          <small class="muted">甲欄/乙欄を選択</small>
        </label>
        <label>雇用期間区分（乙欄）
          <select id="employmentPeriodType"></select>
          <small class="muted">乙欄の場合の日額扱い判定</small>
        </label>
      </div>
      <datalist id="gradeOptions"></datalist>
      <label style="margin-top:12px; display:flex; flex-direction:column; gap:6px;">メモ
        <textarea id="employeeNote" placeholder="任意で備考を記入"></textarea>
      </label>
      <div class="form-actions">
        <button type="submit" class="btn">保存</button>
        <button type="button" id="formResetButton" class="btn ghost">新規入力</button>
        <button type="button" id="deleteButton" class="btn danger" hidden>削除</button>
      </div>
    </form>
  </section>

  <section class="card">
    <div class="section-header">
      <div>
        <h2>所得税（源泉徴収）設定</h2>
        <p class="meta-line" id="incomeTaxMeta">スプレッドシートの「所得税税額表」タブを参照して税額を決定します。</p>
      </div>
        <div class="inline-controls">
          <button id="incomeTaxReloadButton" type="button" class="btn">税額表を再読み込み</button>
        </div>
    </div>
    <div class="form-grid">
      <label>税額表（CSVアップロード）
        <input id="incomeTaxFile" type="file" accept=".csv,text/csv" />
        <small class="muted">税額表はスプレッドシート上の「所得税税額表」タブに直接貼り付けてください。CSVアップロードは無効です。</small>
      </label>
    </div>
    <div class="form-actions">
      <button id="incomeTaxSaveButton" type="button" class="btn">CSVをアップロード</button>
      <button id="incomeTaxResetButton" type="button" class="btn ghost">選択をリセット</button>
    </div>
  </section>

  <section class="card">
    <div class="section-header">
      <div>
        <h2>控除リスト</h2>
        <p class="meta-line" id="deductionMeta">控除額を集計しています…</p>
      </div>
      <button id="deductionReloadButton" type="button" class="btn">控除を再計算</button>
    </div>
    <div class="table-scroll">
      <table>
        <thead>
          <tr>
            <th>従業員</th>
            <th>課税対象額</th>
            <th>所得税</th>
            <th>社宅控除</th>
            <th>住民税</th>
            <th>控除計</th>
            <th>内訳</th>
          </tr>
        </thead>
        <tbody id="deductionTableBody"><tr><td colspan="7" class="table-empty">読み込み中…</td></tr></tbody>
      </table>
    </div>
  </section>

  <section class="card">
    <div class="section-header">
      <div>
        <h2>勤怠データ連携</h2>
        <p class="meta-line">出勤日数・総勤務時間・自動有給化をまとめて確認できます。</p>
      </div>
      <div class="attendance-controls">
        <label>対象月
          <input type="month" id="attendanceMonth" />
        </label>
        <button id="attendanceReloadButton" type="button" class="btn">勤怠を再取得</button>
      </div>
    </div>
    <div id="attendanceSummaryMeta" class="meta-line"></div>
    <div class="table-scroll">
      <table>
        <thead>
          <tr>
            <th>従業員</th>
            <th>出勤日数</th>
            <th>総勤務</th>
            <th>休憩</th>
            <th>残業</th>
            <th>自動有給</th>
            <th>備考</th>
          </tr>
        </thead>
        <tbody id="attendanceTableBody"><tr><td colspan="7" class="table-empty">読み込み中…</td></tr></tbody>
      </table>
    </div>
    <div id="attendanceUnassigned" class="meta-line"></div>
  </section>

  <section class="card">
    <div class="section-header">
      <h2>役職・等級マスタ</h2>
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <button id="gradeReloadButton" type="button" class="btn ghost">再読み込み</button>
        <button id="gradeNewButton" type="button" class="btn">新規登録</button>
      </div>
    </div>
    <div class="table-scroll">
      <table>
        <thead>
          <tr>
            <th>役職/等級</th>
            <th>手当額</th>
            <th>メモ</th>
            <th>更新日時</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="gradeTableBody"><tr><td colspan="5" class="table-empty">読み込み中…</td></tr></tbody>
      </table>
    </div>
  </section>

  <section class="card">
    <div class="section-header">
      <div>
        <h2 id="gradeFormTitle">役職/等級を登録</h2>
        <div id="gradeFormMeta" class="meta-line"></div>
      </div>
    </div>
    <form id="gradeForm" autocomplete="off">
      <input type="hidden" id="gradeId" />
      <div class="form-grid">
        <label>役職/等級名
          <input id="gradeName" type="text" required />
        </label>
        <label>手当額
          <input id="gradeAmount" type="number" min="0" step="500" placeholder="円" />
        </label>
        <label>メモ
          <textarea id="gradeNote" placeholder="補足情報や支給ルール"></textarea>
        </label>
      </div>
      <div class="form-actions">
        <button type="submit" class="btn">保存</button>
        <button type="button" id="gradeFormResetButton" class="btn ghost">クリア</button>
        <button type="button" id="gradeDeleteButton" class="btn danger" hidden>削除</button>
      </div>
    </form>
  </section>

  <section class="card">
    <div class="section-header">
      <h2>社会保険料レート</h2>
      <div class="inline-controls">
        <button type="button" id="insuranceRateReset" class="btn ghost">初期値に戻す</button>
      </div>
    </div>
    <form id="insuranceRateForm" autocomplete="off">
      <div class="rate-grid">
        <label>健康保険（本人）
          <input id="insuranceHealthEmployee" type="number" step="0.0001" min="0" required />
        </label>
        <label>健康保険（事業主）
          <input id="insuranceHealthEmployer" type="number" step="0.0001" min="0" required />
        </label>
        <label>厚生年金（本人）
          <input id="insurancePensionEmployee" type="number" step="0.0001" min="0" required />
        </label>
        <label>厚生年金（事業主）
          <input id="insurancePensionEmployer" type="number" step="0.0001" min="0" required />
        </label>
        <label>介護保険（本人）
          <input id="insuranceNursingEmployee" type="number" step="0.0001" min="0" />
        </label>
        <label>介護保険（事業主）
          <input id="insuranceNursingEmployer" type="number" step="0.0001" min="0" />
        </label>
        <label>子ども・子育て拠出金（本人）
          <input id="insuranceChildEmployee" type="number" step="0.0001" min="0" />
        </label>
        <label>子ども・子育て拠出金（事業主）
          <input id="insuranceChildEmployer" type="number" step="0.0001" min="0" />
        </label>
        <label>雇用保険（本人）
          <input id="insuranceEmploymentEmployee" type="number" step="0.0001" min="0" />
          <small class="muted">賃金総額 × 料率</small>
        </label>
        <label>雇用保険（事業主）
          <input id="insuranceEmploymentEmployer" type="number" step="0.0001" min="0" />
          <small class="muted">賃金総額 × 料率</small>
        </label>
      </div>
      <p class="table-note">料率は小数（例: 4.95% = 0.0495）で入力してください。雇用保険は賃金総額に対して自動計算されます。</p>
      <div class="form-actions">
        <button type="submit" class="btn">レートを保存</button>
      </div>
    </form>
  </section>

  <section class="card">
    <div class="section-header">
      <h2>標準報酬等級マスタ</h2>
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <button id="insuranceStandardReload" type="button" class="btn ghost">再読み込み</button>
        <button id="insuranceStandardNew" type="button" class="btn">新規登録</button>
      </div>
    </div>
    <div class="table-scroll">
      <table>
        <thead>
          <tr>
            <th>等級</th>
            <th>標準報酬月額</th>
            <th>報酬範囲</th>
            <th>備考</th>
            <th>更新日時</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="insuranceStandardTableBody"><tr><td colspan="6" class="table-empty">読み込み中…</td></tr></tbody>
      </table>
    </div>
  </section>

  <section class="card">
    <div class="section-header">
      <h2 id="insuranceStandardFormTitle">標準報酬等級を登録</h2>
      <div id="insuranceStandardFormMeta" class="meta-line"></div>
    </div>
    <form id="insuranceStandardForm" autocomplete="off">
      <input type="hidden" id="insuranceStandardId" />
      <div class="form-grid">
        <label>等級名
          <input id="insuranceStandardGrade" type="text" required />
        </label>
        <label>標準報酬月額
          <input id="insuranceStandardAmount" type="number" min="0" step="1000" required />
        </label>
        <label>報酬下限
          <input id="insuranceStandardLower" type="number" min="0" step="1000" placeholder="任意" />
        </label>
        <label>報酬上限
          <input id="insuranceStandardUpper" type="number" min="0" step="1000" placeholder="任意" />
        </label>
        <label>メモ
          <textarea id="insuranceStandardNote" placeholder="適用条件など"></textarea>
        </label>
      </div>
      <div class="form-actions">
        <button type="submit" class="btn">保存</button>
        <button type="button" id="insuranceStandardReset" class="btn ghost">クリア</button>
        <button type="button" id="insuranceStandardDelete" class="btn danger" hidden>削除</button>
      </div>
    </form>
  </section>

  <section class="card">
    <div class="section-header">
      <div>
        <h2>社会保険料プレビュー</h2>
        <p id="insuranceSummaryMeta" class="meta-line"></p>
      </div>
      <div class="attendance-controls">
        <label>対象月
          <input type="month" id="insuranceMonthInput" />
        </label>
        <button id="insuranceReloadButton" type="button" class="btn">再取得</button>
      </div>
    </div>
    <div class="table-scroll">
      <table>
        <thead>
          <tr>
            <th>従業員</th>
            <th>給与基礎</th>
            <th>適用等級</th>
            <th>標準報酬月額</th>
            <th>本人負担</th>
            <th>事業主負担</th>
            <th>備考</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="insuranceSummaryTableBody"><tr><td colspan="8" class="table-empty">読み込み中…</td></tr></tbody>
      </table>
    </div>
  </section>

  <section class="card">
    <div class="section-header">
      <h2>標準報酬の手動上書き</h2>
      <div id="insuranceOverrideMeta" class="meta-line"></div>
    </div>
    <form id="insuranceOverrideForm" autocomplete="off">
      <input type="hidden" id="insuranceOverrideId" />
      <div class="form-grid">
        <label>対象従業員
          <select id="insuranceOverrideEmployee" required></select>
        </label>
        <label>対象月
          <input type="month" id="insuranceOverrideMonth" required />
        </label>
        <label>適用等級
          <input id="insuranceOverrideGrade" type="text" placeholder="任意" />
        </label>
        <label>標準報酬月額
          <input id="insuranceOverrideAmount" type="number" min="0" step="1000" required />
        </label>
        <label>メモ
          <textarea id="insuranceOverrideNote" placeholder="変更理由など"></textarea>
        </label>
      </div>
      <div class="form-actions">
        <button type="submit" class="btn">上書きを保存</button>
        <button type="button" id="insuranceOverrideReset" class="btn ghost">クリア</button>
        <button type="button" id="insuranceOverrideDelete" class="btn danger" hidden>削除</button>
      </div>
    </form>
  </section>
</div>
<div id="toast" class="toast" role="status" aria-live="polite"></div>
<script>
const EMPLOYMENT_OPTIONS = [
  { value:'employee', label:'正社員' },
  { value:'parttime', label:'アルバイト' },
  { value:'contractor', label:'業務委託' }
];
const TRANSPORT_OPTIONS = [
  { value:'none', label:'なし' },
  { value:'fixed', label:'固定' },
  { value:'actual', label:'実費' }
];
const COMMISSION_OPTIONS = [
  { value:'legacy', label:'既存' },
  { value:'horiguchi', label:'堀口以降' }
];
const WITHHOLDING_OPTIONS = [
  { value:'none', label:'なし（個人事業主扱い）' },
  { value:'required', label:'あり' }
];
const WITHHOLDING_CATEGORY_OPTIONS = [
  { value:'ko', label:'甲欄' },
  { value:'otsu', label:'乙欄' }
];
const WITHHOLDING_PERIOD_OPTIONS = [
  { value:'monthly', label:'通常（月額）' },
  { value:'daily', label:'日額扱い（乙欄）' }
];
const SOCIAL_INSURANCE_RATE_DEFAULTS = Object.freeze({
  healthEmployee: 0.0495,
  healthEmployer: 0.0495,
  pensionEmployee: 0.0915,
  pensionEmployer: 0.0915,
  nursingEmployee: 0.0045,
  nursingEmployer: 0.0045,
  childEmployee: 0.0018,
  childEmployer: 0.0018,
  employmentEmployee: 0,
  employmentEmployer: 0
});

let payrollState = {
  employees: [],
  grades: [],
  loading: false,
  saving: false,
  gradeSaving: false,
  selectedId: null,
  selectedGradeId: null,
  bulk: {
    month: getPreviousMonthKey(),
    loading: false,
    summary: null
  },
  attendance: {
    month: null,
    loading: false,
    summary: null
  },
  deductions: {
    loading: false,
    summary: null
  },
  incomeTax: {
    loading: false,
    saving: false,
    reloading: false,
    fetchedAt: null,
    stats: null,
    fileName: ''
  },
  socialInsurance: {
    rates: { ...SOCIAL_INSURANCE_RATE_DEFAULTS },
    standards: [],
    selectedStandardId: null,
    month: getCurrentMonthKey(),
    summary: null,
    summaryLoading: false,
    settingsLoading: false,
    rateSaving: false,
    standardSaving: false,
    overrideSaving: false
  }
};
payrollState.attendance.month = getCurrentMonthKey();
let toastTimer = null;

function showToast(message){
  if (!message) return;
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.classList.add('show');
  if (toastTimer) clearTimeout(toastTimer);
  toastTimer = setTimeout(() => toast.classList.remove('show'), 2400);
}

function formatCurrency(value){
  if (value == null || value === '') return '--';
  const num = Number(value);
  if (!Number.isFinite(num)) return '--';
  return '¥' + Math.round(num).toLocaleString('ja-JP');
}

function escapeHtml(value){
  if (value == null) return '';
  return String(value)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

function getCurrentMonthKey(){
  const now = new Date();
  const month = String(now.getMonth() + 1).padStart(2, '0');
  return `${now.getFullYear()}-${month}`;
}

function getPreviousMonthKey(){
  const now = new Date();
  const prev = new Date(now.getFullYear(), now.getMonth() - 1, 1);
  const month = String(prev.getMonth() + 1).padStart(2, '0');
  return `${prev.getFullYear()}-${month}`;
}

function formatMinutesClock(minutes){
  if (!Number.isFinite(minutes) || minutes <= 0) return '00:00';
  const hrs = Math.floor(minutes / 60);
  const mins = Math.round(minutes % 60);
  return `${String(hrs).padStart(2, '0')}:${String(mins).padStart(2, '0')}`;
}

function formatMinutesHuman(minutes){
  if (!Number.isFinite(minutes) || minutes <= 0) return '0分';
  const hrs = Math.floor(minutes / 60);
  const mins = Math.round(minutes % 60);
  if (hrs && mins) return `${hrs}時間${mins}分`;
  if (hrs && !mins) return `${hrs}時間`;
  return `${mins}分`;
}

function formatTransportation(row){
  if (!row) return '';
  const type = row.transportationLabel || '';
  if (type && row.transportationAmount == null) return escapeHtml(type);
  if (!type && row.transportationAmount != null) {
    return escapeHtml(formatCurrency(row.transportationAmount));
  }
  if (!type) return '';
  if (row.transportationAmount == null) return escapeHtml(type);
  return escapeHtml(`${type} (${formatCurrency(row.transportationAmount)})`);
}

function setIncomeTaxFormLoading(isSaving){
  payrollState.incomeTax.saving = isSaving;
  const saveButton = document.getElementById('incomeTaxSaveButton');
  if (saveButton) saveButton.disabled = isSaving || payrollState.incomeTax.reloading;
  const fileInput = document.getElementById('incomeTaxFile');
  if (fileInput) fileInput.disabled = isSaving || payrollState.incomeTax.reloading;
}

function setIncomeTaxReloading(isLoading){
  payrollState.incomeTax.reloading = isLoading;
  const reloadButton = document.getElementById('incomeTaxReloadButton');
  if (reloadButton) reloadButton.disabled = isLoading || payrollState.incomeTax.saving;
  const fileInput = document.getElementById('incomeTaxFile');
  if (fileInput) fileInput.disabled = isLoading || payrollState.incomeTax.saving;
}

function getIncomeTaxStatsSummary(stats){
  const ko = stats && Number.isFinite(stats.koDependents) ? stats.koDependents : 0;
  const otsu = stats && Number.isFinite(stats.otsuRows) ? stats.otsuRows : 0;
  return `甲欄 ${ko}件 / 乙欄 ${otsu}行`;
}

function setIncomeTaxStateFromResponse(res){
  const stats = res && res.stats ? res.stats : {};
  payrollState.incomeTax.fetchedAt = res && res.fetchedAt ? res.fetchedAt : null;
  payrollState.incomeTax.stats = {
    koDependents: Number.isFinite(stats.koDependents) ? stats.koDependents : 0,
    otsuRows: Number.isFinite(stats.otsuRows) ? stats.otsuRows : 0
  };
  payrollState.incomeTax.fileName = res && res.fileName ? res.fileName : '';
}

function formatIncomeTaxMetaSummary(){
  const fetchedAt = payrollState.incomeTax.fetchedAt
    ? new Date(payrollState.incomeTax.fetchedAt).toLocaleString('ja-JP')
    : '未取得';
  const summary = getIncomeTaxStatsSummary(payrollState.incomeTax.stats);
  const fileLabel = payrollState.incomeTax.fileName ? ` / ファイル: ${payrollState.incomeTax.fileName}` : '';
  return `最終取得: ${fetchedAt} / ${summary}${fileLabel}`;
}

function formatIncomeTaxResultMessage(action){
  const fetchedAt = payrollState.incomeTax.fetchedAt
    ? new Date(payrollState.incomeTax.fetchedAt).toLocaleString('ja-JP')
    : '取得日時不明';
  const fileLabel = payrollState.incomeTax.fileName || 'ファイル名不明';
  return `${action}（${getIncomeTaxStatsSummary(payrollState.incomeTax.stats)} / ファイル: ${fileLabel} / 取得日時: ${fetchedAt}）`;
}

function renderIncomeTaxMeta(message){
  const meta = document.getElementById('incomeTaxMeta');
  if (!meta) return;
  if (message) {
    meta.textContent = message;
    return;
  }
  meta.textContent = formatIncomeTaxMetaSummary();
}

function renderIncomeTaxSettings(){
  const fileInput = document.getElementById('incomeTaxFile');
  if (fileInput) {
    fileInput.value = '';
  }
  renderIncomeTaxMeta();
}

function resetIncomeTaxForm(){
  const fileInput = document.getElementById('incomeTaxFile');
  if (fileInput) {
    fileInput.value = '';
  }
}

function fetchIncomeTaxSettings(){
  payrollState.incomeTax.loading = true;
  renderIncomeTaxMeta('設定を取得しています…');
  google.script.run
    .withSuccessHandler(res => {
      payrollState.incomeTax.loading = false;
      if (!res || res.ok !== true) {
        renderIncomeTaxMeta(res && res.message ? res.message : '所得税設定の取得に失敗しました');
        return;
      }
      const settings = res.settings || {};
      setIncomeTaxStateFromResponse({
        fetchedAt: settings.fetchedAt || null,
        stats: { koDependents: settings.koDependents || 0, otsuRows: settings.otsuRows || 0 },
        fileName: settings.fileName || ''
      });
      renderIncomeTaxSettings();
    })
    .withFailureHandler(err => {
      payrollState.incomeTax.loading = false;
      renderIncomeTaxMeta(err && err.message ? err.message : '所得税設定の取得に失敗しました');
    })
    .payrollGetIncomeTaxSettings();
}

function handleIncomeTaxSave(){
  const message = '税額表はスプレッドシートの「所得税税額表」タブに直接入力してください。';
  renderIncomeTaxMeta(message);
  showToast(message);
}

function handleIncomeTaxReload(){
  if (payrollState.incomeTax.reloading) return;
  setIncomeTaxReloading(true);
  renderIncomeTaxMeta('税額表を再読み込みしています…');
  google.script.run
    .withSuccessHandler(res => {
      setIncomeTaxReloading(false);
      if (!res || res.ok !== true) {
        renderIncomeTaxMeta(res && res.message ? res.message : '税額表の再読み込みに失敗しました');
        showToast(res && res.message ? res.message : '税額表の再読み込みに失敗しました');
        return;
      }
      setIncomeTaxStateFromResponse(res);
      const successMessage = res && res.message
        ? res.message
        : formatIncomeTaxResultMessage('税額表を再読み込みしました');
      renderIncomeTaxSettings();
      renderIncomeTaxMeta(successMessage);
      showToast(successMessage);
      fetchDeductionSummary();
    })
    .withFailureHandler(err => {
      setIncomeTaxReloading(false);
      renderIncomeTaxMeta(err && err.message ? err.message : '税額表の再読み込みに失敗しました');
      showToast(err && err.message ? err.message : '税額表の再読み込みに失敗しました');
    })
    .payrollReloadIncomeTaxTables();
}


function getEmploymentLabel(value){
  const match = EMPLOYMENT_OPTIONS.find(opt => opt.value === value);
  return match ? match.label : (value || '');
}

function renderOptions(select, options){
  if (!select) return;
  select.innerHTML = options.map(opt => `<option value="${opt.value}">${opt.label}</option>`).join('');
}

function normalizeGradeName(value){
  return String(value || '').replace(/\u3000/g, ' ').trim().toLowerCase();
}

function findGradeByInput(input){
  if (!Array.isArray(payrollState.grades)) return null;
  const key = normalizeGradeName(input);
  if (!key) return null;
  return payrollState.grades.find(grade => grade.normalizedName === key) || null;
}

function renderGradeTable(){
  const tbody = document.getElementById('gradeTableBody');
  if (!tbody) return;
  if (!Array.isArray(payrollState.grades) || payrollState.grades.length === 0){
    tbody.innerHTML = '<tr><td colspan="5" class="table-empty">登録がありません</td></tr>';
    return;
  }
  tbody.innerHTML = payrollState.grades.map(grade => {
    const name = grade.name ? escapeHtml(grade.name) : '';
    const amount = grade.amount != null ? formatCurrency(grade.amount) : '--';
    const note = grade.note ? escapeHtml(grade.note) : '';
    const updated = grade.updatedAt ? escapeHtml(new Date(grade.updatedAt).toLocaleString('ja-JP')) : '';
    const idAttr = escapeHtml(grade.id || '');
    return `
    <tr>
      <td>${name}</td>
      <td>${amount}</td>
      <td>${note}</td>
      <td>${updated}</td>
      <td><button type="button" class="btn ghost small" data-grade-action="edit" data-id="${idAttr}">編集</button></td>
    </tr>`;
  }).join('');
}

function renderGradeOptions(){
  const datalist = document.getElementById('gradeOptions');
  if (!datalist) return;
  if (!Array.isArray(payrollState.grades) || payrollState.grades.length === 0){
    datalist.innerHTML = '';
    return;
  }
  datalist.innerHTML = payrollState.grades.map(grade => {
    const amount = grade.amount != null ? formatCurrency(grade.amount) : '';
    const suffix = amount ? ` (${amount})` : '';
    const value = escapeHtml(grade.name || '');
    const label = escapeHtml((grade.name || '') + suffix);
    return `<option value="${value}">${label}</option>`;
  }).join('');
}

function updateGradeHint(){
  const input = document.getElementById('employeeGrade');
  const hint = document.getElementById('gradeAmountHint');
  if (!input || !hint) return;
  const value = input.value;
  if (!value){
    hint.textContent = '';
    return;
  }
  const grade = findGradeByInput(value);
  if (!grade){
    hint.textContent = '';
    return;
  }
  hint.textContent = grade.amount != null ? `マスタ設定: ${formatCurrency(grade.amount)}` : 'マスタ設定: 金額未設定';
}

function gatherGradeFormData(){
  return {
    id: document.getElementById('gradeId').value,
    name: document.getElementById('gradeName').value,
    amount: document.getElementById('gradeAmount').value,
    note: document.getElementById('gradeNote').value
  };
}

function setGradeFormLoading(isSaving){
  payrollState.gradeSaving = isSaving;
  const form = document.getElementById('gradeForm');
  if (!form) return;
  Array.from(form.elements).forEach(el => { el.disabled = isSaving && el.id !== 'gradeDeleteButton'; });
  const deleteBtn = document.getElementById('gradeDeleteButton');
  if (deleteBtn) deleteBtn.disabled = isSaving;
}

function resetGradeForm(){
  const form = document.getElementById('gradeForm');
  if (form) form.reset();
  payrollState.selectedGradeId = null;
  document.getElementById('gradeId').value = '';
  document.getElementById('gradeFormTitle').textContent = '役職/等級を登録';
  document.getElementById('gradeFormMeta').textContent = '';
  document.getElementById('gradeDeleteButton').hidden = true;
}

function populateGradeForm(grade){
  if (!grade){
    resetGradeForm();
    return;
  }
  payrollState.selectedGradeId = grade.id || null;
  document.getElementById('gradeId').value = grade.id || '';
  document.getElementById('gradeName').value = grade.name || '';
  document.getElementById('gradeAmount').value = grade.amount != null ? grade.amount : '';
  document.getElementById('gradeNote').value = grade.note || '';
  document.getElementById('gradeFormTitle').textContent = grade.name ? `${grade.name} を編集` : '役職/等級を編集';
  document.getElementById('gradeFormMeta').textContent = grade.updatedAt ? `最終更新: ${new Date(grade.updatedAt).toLocaleString('ja-JP')}` : '';
  document.getElementById('gradeDeleteButton').hidden = !grade.id;
}

function handleGradeTableClick(event){
  const button = event.target.closest('button[data-grade-action="edit"]');
  if (!button) return;
  const id = button.getAttribute('data-id');
  if (!id) return;
  const grade = payrollState.grades.find(g => g.id === id);
  if (grade){
    populateGradeForm(grade);
    window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
  }
}

function handleGradeSave(event){
  event.preventDefault();
  if (payrollState.gradeSaving) return;
  setGradeFormLoading(true);
  const payload = gatherGradeFormData();
  google.script.run
    .withSuccessHandler(res => {
      setGradeFormLoading(false);
      if (!res || res.ok !== true) {
        showToast(res && res.message ? res.message : '保存に失敗しました');
        return;
      }
      showToast('役職/等級を保存しました');
      payrollState.selectedGradeId = res.grade && res.grade.id ? res.grade.id : null;
      fetchGrades();
      fetchEmployees();
    })
    .withFailureHandler(err => {
      setGradeFormLoading(false);
      showToast(err && err.message ? err.message : '保存に失敗しました');
    })
    .payrollSaveGrade(payload);
}

function handleGradeDelete(){
  const id = document.getElementById('gradeId').value;
  if (!id) return;
  if (!confirm('この役職/等級を削除しますか？')) return;
  setGradeFormLoading(true);
  google.script.run
    .withSuccessHandler(res => {
      setGradeFormLoading(false);
      if (!res || res.ok !== true) {
        showToast(res && res.message ? res.message : '削除に失敗しました');
        return;
      }
      showToast('削除しました');
      resetGradeForm();
      fetchGrades();
      fetchEmployees();
    })
    .withFailureHandler(err => {
      setGradeFormLoading(false);
      showToast(err && err.message ? err.message : '削除に失敗しました');
    })
    .payrollDeleteGrade({ id });
}

function fetchGrades(){
  const tbody = document.getElementById('gradeTableBody');
  if (tbody) {
    tbody.innerHTML = '<tr><td colspan="5" class="table-empty">読み込み中…</td></tr>';
  }
  google.script.run
    .withSuccessHandler(res => {
      if (!res || res.ok !== true) {
        showToast(res && res.message ? res.message : 'マスタの取得に失敗しました');
        if (tbody) tbody.innerHTML = '<tr><td colspan="5" class="table-empty">エラーが発生しました</td></tr>';
        return;
      }
      payrollState.grades = Array.isArray(res.grades) ? res.grades.map(grade => ({
        ...grade,
        normalizedName: normalizeGradeName(grade && grade.name)
      })) : [];
      renderGradeTable();
      renderGradeOptions();
      if (payrollState.selectedGradeId) {
        const current = payrollState.grades.find(g => g.id === payrollState.selectedGradeId);
        if (current) {
          populateGradeForm(current);
        }
      }
      updateGradeHint();
    })
    .withFailureHandler(err => {
      showToast(err && err.message ? err.message : 'マスタの取得に失敗しました');
      if (tbody) tbody.innerHTML = '<tr><td colspan="5" class="table-empty">エラーが発生しました</td></tr>';
    })
    .payrollListGrades();
}

function renderInsuranceRateForm(){
  const rates = payrollState.socialInsurance.rates || SOCIAL_INSURANCE_RATE_DEFAULTS;
  const mapping = {
    healthEmployee: 'insuranceHealthEmployee',
    healthEmployer: 'insuranceHealthEmployer',
    pensionEmployee: 'insurancePensionEmployee',
    pensionEmployer: 'insurancePensionEmployer',
    nursingEmployee: 'insuranceNursingEmployee',
    nursingEmployer: 'insuranceNursingEmployer',
    childEmployee: 'insuranceChildEmployee',
    childEmployer: 'insuranceChildEmployer',
    employmentEmployee: 'insuranceEmploymentEmployee',
    employmentEmployer: 'insuranceEmploymentEmployer'
  };
  Object.keys(mapping).forEach(key => {
    const el = document.getElementById(mapping[key]);
    if (el) {
      const value = rates && rates[key] != null ? rates[key] : '';
      el.value = value;
    }
  });
}

function setInsuranceRateFormLoading(isSaving){
  payrollState.socialInsurance.rateSaving = isSaving;
  const form = document.getElementById('insuranceRateForm');
  if (form) {
    Array.from(form.elements).forEach(el => { el.disabled = isSaving; });
  }
  const resetBtn = document.getElementById('insuranceRateReset');
  if (resetBtn) resetBtn.disabled = isSaving;
}

function gatherInsuranceRatePayload(){
  return {
    healthEmployee: document.getElementById('insuranceHealthEmployee').value,
    healthEmployer: document.getElementById('insuranceHealthEmployer').value,
    pensionEmployee: document.getElementById('insurancePensionEmployee').value,
    pensionEmployer: document.getElementById('insurancePensionEmployer').value,
    nursingEmployee: document.getElementById('insuranceNursingEmployee').value,
    nursingEmployer: document.getElementById('insuranceNursingEmployer').value,
    childEmployee: document.getElementById('insuranceChildEmployee').value,
    childEmployer: document.getElementById('insuranceChildEmployer').value,
    employmentEmployee: document.getElementById('insuranceEmploymentEmployee').value,
    employmentEmployer: document.getElementById('insuranceEmploymentEmployer').value
  };
}

function handleInsuranceRateSave(event){
  event.preventDefault();
  if (payrollState.socialInsurance.rateSaving) return;
  setInsuranceRateFormLoading(true);
  const payload = gatherInsuranceRatePayload();
  google.script.run
    .withSuccessHandler(res => {
      setInsuranceRateFormLoading(false);
      if (!res || res.ok !== true) {
        showToast(res && res.message ? res.message : 'レートの保存に失敗しました');
        return;
      }
      payrollState.socialInsurance.rates = res.rates || { ...SOCIAL_INSURANCE_RATE_DEFAULTS };
      renderInsuranceRateForm();
      showToast('社会保険料レートを更新しました');
      fetchInsuranceSummary();
    })
    .withFailureHandler(err => {
      setInsuranceRateFormLoading(false);
      showToast(err && err.message ? err.message : 'レートの保存に失敗しました');
    })
    .payrollSaveSocialInsuranceRates(payload);
}

function handleInsuranceRateReset(){
  payrollState.socialInsurance.rates = { ...SOCIAL_INSURANCE_RATE_DEFAULTS };
  renderInsuranceRateForm();
}

function formatInsuranceRange(lower, upper){
  const hasLower = lower != null && lower !== '';
  const hasUpper = upper != null && upper !== '';
  if (!hasLower && !hasUpper) return '指定なし';
  const lowerText = hasLower ? formatCurrency(lower) : '0';
  const upperText = hasUpper ? formatCurrency(upper) : '∞';
  return `${lowerText}〜${upperText}`;
}

function renderInsuranceStandardTable(){
  const tbody = document.getElementById('insuranceStandardTableBody');
  if (!tbody) return;
  const list = payrollState.socialInsurance.standards;
  if (!Array.isArray(list) || list.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" class="table-empty">登録がありません</td></tr>';
    return;
  }
  tbody.innerHTML = list.map(row => {
    const grade = escapeHtml(row.grade || '--');
    const amount = formatCurrency(row.monthlyAmount);
    const range = escapeHtml(formatInsuranceRange(row.lowerBound, row.upperBound));
    const note = row.note ? escapeHtml(row.note) : '';
    const updated = row.updatedAt ? escapeHtml(new Date(row.updatedAt).toLocaleString('ja-JP')) : '';
    const idAttr = escapeHtml(row.id || '');
    return `
      <tr>
        <td>${grade}</td>
        <td class="text-right">${amount}</td>
        <td>${range}</td>
        <td>${note}</td>
        <td>${updated}</td>
        <td><button type="button" class="btn ghost small" data-insurance-standard="edit" data-id="${idAttr}">編集</button></td>
      </tr>`;
  }).join('');
}

function setInsuranceStandardFormLoading(isSaving){
  payrollState.socialInsurance.standardSaving = isSaving;
  const form = document.getElementById('insuranceStandardForm');
  if (form) {
    Array.from(form.elements).forEach(el => { el.disabled = isSaving && el.id !== 'insuranceStandardDelete'; });
  }
  const deleteBtn = document.getElementById('insuranceStandardDelete');
  if (deleteBtn) deleteBtn.disabled = isSaving;
}

function resetInsuranceStandardForm(){
  const form = document.getElementById('insuranceStandardForm');
  if (form) form.reset();
  payrollState.socialInsurance.selectedStandardId = null;
  document.getElementById('insuranceStandardId').value = '';
  document.getElementById('insuranceStandardFormTitle').textContent = '標準報酬等級を登録';
  document.getElementById('insuranceStandardFormMeta').textContent = '';
  document.getElementById('insuranceStandardDelete').hidden = true;
}

function populateInsuranceStandardForm(standard){
  if (!standard){
    resetInsuranceStandardForm();
    return;
  }
  payrollState.socialInsurance.selectedStandardId = standard.id || null;
  document.getElementById('insuranceStandardId').value = standard.id || '';
  document.getElementById('insuranceStandardGrade').value = standard.grade || '';
  document.getElementById('insuranceStandardAmount').value = standard.monthlyAmount != null ? standard.monthlyAmount : '';
  document.getElementById('insuranceStandardLower').value = standard.lowerBound != null ? standard.lowerBound : '';
  document.getElementById('insuranceStandardUpper').value = standard.upperBound != null ? standard.upperBound : '';
  document.getElementById('insuranceStandardNote').value = standard.note || '';
  document.getElementById('insuranceStandardFormTitle').textContent = `${standard.grade || '標準報酬'} を編集`;
  document.getElementById('insuranceStandardFormMeta').textContent = standard.updatedAt ? `最終更新: ${new Date(standard.updatedAt).toLocaleString('ja-JP')}` : '';
  document.getElementById('insuranceStandardDelete').hidden = !standard.id;
}

function handleInsuranceStandardSave(event){
  event.preventDefault();
  if (payrollState.socialInsurance.standardSaving) return;
  setInsuranceStandardFormLoading(true);
  const payload = {
    id: document.getElementById('insuranceStandardId').value,
    grade: document.getElementById('insuranceStandardGrade').value,
    monthlyAmount: document.getElementById('insuranceStandardAmount').value,
    lowerBound: document.getElementById('insuranceStandardLower').value,
    upperBound: document.getElementById('insuranceStandardUpper').value,
    note: document.getElementById('insuranceStandardNote').value
  };
  google.script.run
    .withSuccessHandler(res => {
      setInsuranceStandardFormLoading(false);
      if (!res || res.ok !== true) {
        showToast(res && res.message ? res.message : '標準報酬の保存に失敗しました');
        return;
      }
      payrollState.socialInsurance.selectedStandardId = res.standard && res.standard.id ? res.standard.id : null;
      showToast('標準報酬等級を保存しました');
      fetchSocialInsuranceSettings();
    })
    .withFailureHandler(err => {
      setInsuranceStandardFormLoading(false);
      showToast(err && err.message ? err.message : '標準報酬の保存に失敗しました');
    })
    .payrollSaveSocialInsuranceStandard(payload);
}

function handleInsuranceStandardDelete(){
  const id = document.getElementById('insuranceStandardId').value;
  if (!id) return;
  if (!confirm('この等級を削除しますか？')) return;
  setInsuranceStandardFormLoading(true);
  google.script.run
    .withSuccessHandler(res => {
      setInsuranceStandardFormLoading(false);
      if (!res || res.ok !== true) {
        showToast(res && res.message ? res.message : '削除に失敗しました');
        return;
      }
      showToast('削除しました');
      resetInsuranceStandardForm();
      fetchSocialInsuranceSettings();
    })
    .withFailureHandler(err => {
      setInsuranceStandardFormLoading(false);
      showToast(err && err.message ? err.message : '削除に失敗しました');
    })
    .payrollDeleteSocialInsuranceStandard({ id });
}

function handleInsuranceStandardTableClick(event){
  const button = event.target.closest('button[data-insurance-standard="edit"]');
  if (!button) return;
  const id = button.getAttribute('data-id');
  if (!id) return;
  const standard = payrollState.socialInsurance.standards.find(item => item.id === id);
  if (standard) {
    populateInsuranceStandardForm(standard);
    window.scrollTo({ top: button.getBoundingClientRect().top + window.scrollY - 120, behavior: 'smooth' });
  }
}

function fetchSocialInsuranceSettings(){
  const tbody = document.getElementById('insuranceStandardTableBody');
  if (tbody) {
    tbody.innerHTML = '<tr><td colspan="6" class="table-empty">読み込み中…</td></tr>';
  }
  payrollState.socialInsurance.settingsLoading = true;
  google.script.run
    .withSuccessHandler(res => {
      payrollState.socialInsurance.settingsLoading = false;
      if (!res || res.ok !== true) {
        showToast(res && res.message ? res.message : '社会保険設定の取得に失敗しました');
        if (tbody) tbody.innerHTML = '<tr><td colspan="6" class="table-empty">エラーが発生しました</td></tr>';
        return;
      }
      payrollState.socialInsurance.standards = Array.isArray(res.standards) ? res.standards : [];
      payrollState.socialInsurance.rates = res.rates || { ...SOCIAL_INSURANCE_RATE_DEFAULTS };
      renderInsuranceStandardTable();
      renderInsuranceRateForm();
    })
    .withFailureHandler(err => {
      payrollState.socialInsurance.settingsLoading = false;
      showToast(err && err.message ? err.message : '社会保険設定の取得に失敗しました');
      if (tbody) tbody.innerHTML = '<tr><td colspan="6" class="table-empty">エラーが発生しました</td></tr>';
    })
    .payrollGetSocialInsuranceSettings();
}

function setInsuranceSummaryLoading(isLoading){
  payrollState.socialInsurance.summaryLoading = isLoading;
  const reloadButton = document.getElementById('insuranceReloadButton');
  if (reloadButton) reloadButton.disabled = isLoading;
  const monthInput = document.getElementById('insuranceMonthInput');
  if (monthInput) monthInput.disabled = isLoading;
}

function renderInsuranceSummaryMeta(){
  const meta = document.getElementById('insuranceSummaryMeta');
  if (!meta) return;
  const summary = payrollState.socialInsurance.summary;
  if (!summary || !summary.month) {
    meta.textContent = '対象月を選択してください。';
    return;
  }
  const label = summary.month.label || summary.month.key || '';
  const entries = Array.isArray(summary.entries) ? summary.entries : [];
  const overrideCount = entries.filter(entry => entry && entry.isOverride).length;
  meta.textContent = `${label} / 上書き ${overrideCount} 件`;
}

function renderInsuranceSummaryTable(){
  const tbody = document.getElementById('insuranceSummaryTableBody');
  if (!tbody) return;
  const summary = payrollState.socialInsurance.summary;
  if (!summary || !Array.isArray(summary.entries) || summary.entries.length === 0) {
    tbody.innerHTML = '<tr><td colspan="8" class="table-empty">表示できる従業員がいません</td></tr>';
    return;
  }
  tbody.innerHTML = summary.entries.map(entry => {
    const employmentLabel = escapeHtml(getEmploymentLabel(entry.employmentType));
    const employeeName = entry.employeeName ? escapeHtml(entry.employeeName) : '--';
    const nameBlock = `
      <div class="insurance-summary-name">
        <div class="metric-main">${employeeName}</div>
        <small>${employmentLabel}</small>
      </div>`;
    const appliedGrade = escapeHtml(entry.appliedGrade || entry.matchedGrade || '--');
    const overrideBadge = entry.isOverride ? '<span class="badge danger">手動</span>' : '';
    const matchedGrade = escapeHtml(entry.matchedGrade || '--');
    const baseComp = escapeHtml(formatCurrency(entry.compensationAmount));
    const standardAmount = escapeHtml(formatCurrency(entry.appliedAmount));
    const contrib = entry.contributions || {};
    const employeeTotal = escapeHtml(formatCurrency(contrib.employeeTotal));
    const employerTotal = escapeHtml(formatCurrency(contrib.employerTotal));
    const note = entry.overrideNote ? escapeHtml(entry.overrideNote) : '';
    const employeeIdAttr = escapeHtml(entry.employeeId || '');
    return `
      <tr>
        <td>${nameBlock}</td>
        <td class="text-right"><div class="insurance-summary-amount"><strong>${baseComp}</strong><small>推定月額</small></div></td>
        <td><div class="insurance-summary-name">${appliedGrade}${overrideBadge ? ` ${overrideBadge}` : ''} <small>基準: ${matchedGrade}</small></div></td>
        <td class="text-right">${standardAmount}</td>
        <td class="text-right"><div class="insurance-summary-amount"><strong>${employeeTotal}</strong><small>本人</small></div></td>
        <td class="text-right"><div class="insurance-summary-amount"><strong>${employerTotal}</strong><small>事業主</small></div></td>
        <td class="insurance-summary-note">${note}</td>
        <td><button type="button" class="btn ghost small" data-insurance-action="override" data-employee-id="${employeeIdAttr}">上書き</button></td>
      </tr>`;
  }).join('');
}

function renderInsuranceSummary(){
  renderInsuranceSummaryMeta();
  renderInsuranceSummaryTable();
}

function fetchInsuranceSummary(){
  const tbody = document.getElementById('insuranceSummaryTableBody');
  if (tbody) {
    tbody.innerHTML = '<tr><td colspan="8" class="table-empty">読み込み中…</td></tr>';
  }
  setInsuranceSummaryLoading(true);
  const payload = {};
  if (payrollState.socialInsurance.month) {
    payload.month = payrollState.socialInsurance.month;
  }
  google.script.run
    .withSuccessHandler(res => {
      setInsuranceSummaryLoading(false);
      if (!res || res.ok !== true) {
        showToast(res && res.message ? res.message : '社会保険料の取得に失敗しました');
        payrollState.socialInsurance.summary = null;
        renderInsuranceSummary();
        return;
      }
      payrollState.socialInsurance.summary = res;
      payrollState.socialInsurance.month = res.month && res.month.key ? res.month.key : payrollState.socialInsurance.month;
      if (res.rates) {
        payrollState.socialInsurance.rates = res.rates;
        renderInsuranceRateForm();
      }
      const monthInput = document.getElementById('insuranceMonthInput');
      if (monthInput && payrollState.socialInsurance.month) {
        monthInput.value = payrollState.socialInsurance.month;
      }
      renderInsuranceSummary();
    })
    .withFailureHandler(err => {
      setInsuranceSummaryLoading(false);
      showToast(err && err.message ? err.message : '社会保険料の取得に失敗しました');
      payrollState.socialInsurance.summary = null;
      renderInsuranceSummary();
    })
    .payrollListSocialInsuranceSummary(payload);
}

function renderInsuranceOverrideEmployeeOptions(){
  const select = document.getElementById('insuranceOverrideEmployee');
  if (!select) return;
  const options = payrollState.employees.slice().sort((a, b) => (a.name || '').localeCompare(b.name || '', 'ja'));
  select.innerHTML = '<option value="">選択してください</option>' + options.map(emp => {
    const value = escapeHtml(emp.id || '');
    const label = escapeHtml(emp.name || '氏名未登録');
    return `<option value="${value}">${label}</option>`;
  }).join('');
}

function resetInsuranceOverrideForm(){
  const form = document.getElementById('insuranceOverrideForm');
  if (form) form.reset();
  document.getElementById('insuranceOverrideId').value = '';
  const monthInput = document.getElementById('insuranceOverrideMonth');
  if (monthInput && payrollState.socialInsurance.month) {
    monthInput.value = payrollState.socialInsurance.month;
  }
  document.getElementById('insuranceOverrideDelete').hidden = true;
  document.getElementById('insuranceOverrideMeta').textContent = '上書きは対象月ごとに1件保持されます。';
}

function populateInsuranceOverrideForm(entry){
  if (!entry) {
    resetInsuranceOverrideForm();
    return;
  }
  document.getElementById('insuranceOverrideEmployee').value = entry.employeeId || '';
  if (entry.monthKey) {
    document.getElementById('insuranceOverrideMonth').value = entry.monthKey;
  }
  document.getElementById('insuranceOverrideGrade').value = entry.appliedGrade || entry.matchedGrade || '';
  document.getElementById('insuranceOverrideAmount').value = entry.appliedAmount != null ? entry.appliedAmount : '';
  document.getElementById('insuranceOverrideNote').value = entry.overrideNote || '';
  if (entry.overrideId) {
    document.getElementById('insuranceOverrideId').value = entry.overrideId;
    document.getElementById('insuranceOverrideDelete').hidden = false;
  } else {
    document.getElementById('insuranceOverrideId').value = '';
    document.getElementById('insuranceOverrideDelete').hidden = true;
  }
  const meta = document.getElementById('insuranceOverrideMeta');
  meta.textContent = `${entry.employeeName || ''} / ${entry.monthKey || ''}`;
}

function setInsuranceOverrideFormLoading(isSaving){
  payrollState.socialInsurance.overrideSaving = isSaving;
  const form = document.getElementById('insuranceOverrideForm');
  if (form) {
    Array.from(form.elements).forEach(el => { el.disabled = isSaving && el.id !== 'insuranceOverrideDelete'; });
  }
  const deleteBtn = document.getElementById('insuranceOverrideDelete');
  if (deleteBtn) deleteBtn.disabled = isSaving;
}

function gatherInsuranceOverridePayload(){
  return {
    id: document.getElementById('insuranceOverrideId').value,
    employeeId: document.getElementById('insuranceOverrideEmployee').value,
    month: document.getElementById('insuranceOverrideMonth').value,
    grade: document.getElementById('insuranceOverrideGrade').value,
    monthlyAmount: document.getElementById('insuranceOverrideAmount').value,
    note: document.getElementById('insuranceOverrideNote').value
  };
}

function handleInsuranceOverrideSave(event){
  event.preventDefault();
  if (payrollState.socialInsurance.overrideSaving) return;
  setInsuranceOverrideFormLoading(true);
  const payload = gatherInsuranceOverridePayload();
  google.script.run
    .withSuccessHandler(res => {
      setInsuranceOverrideFormLoading(false);
      if (!res || res.ok !== true) {
        showToast(res && res.message ? res.message : '上書きの保存に失敗しました');
        return;
      }
      showToast('上書きを保存しました');
      resetInsuranceOverrideForm();
      fetchInsuranceSummary();
    })
    .withFailureHandler(err => {
      setInsuranceOverrideFormLoading(false);
      showToast(err && err.message ? err.message : '上書きの保存に失敗しました');
    })
    .payrollSaveSocialInsuranceOverride(payload);
}

function handleInsuranceOverrideDelete(){
  const id = document.getElementById('insuranceOverrideId').value;
  if (!id) return;
  if (!confirm('この上書きを削除しますか？')) return;
  setInsuranceOverrideFormLoading(true);
  google.script.run
    .withSuccessHandler(res => {
      setInsuranceOverrideFormLoading(false);
      if (!res || res.ok !== true) {
        showToast(res && res.message ? res.message : '削除に失敗しました');
        return;
      }
      showToast('削除しました');
      resetInsuranceOverrideForm();
      fetchInsuranceSummary();
    })
    .withFailureHandler(err => {
      setInsuranceOverrideFormLoading(false);
      showToast(err && err.message ? err.message : '削除に失敗しました');
    })
    .payrollDeleteSocialInsuranceOverride({ id });
}

function handleInsuranceSummaryTableClick(event){
  const button = event.target.closest('button[data-insurance-action="override"]');
  if (!button) return;
  const employeeId = button.getAttribute('data-employee-id');
  const summary = payrollState.socialInsurance.summary;
  if (!employeeId || !summary || !Array.isArray(summary.entries)) return;
  const entry = summary.entries.find(item => item && item.employeeId === employeeId);
  if (entry) {
    populateInsuranceOverrideForm(entry);
    window.scrollTo({ top: document.getElementById('insuranceOverrideForm').offsetTop - 40, behavior: 'smooth' });
  }
}

function renderTable(){
  const tbody = document.getElementById('employeeTableBody');
  if (!Array.isArray(payrollState.employees) || !payrollState.employees.length){
    tbody.innerHTML = '<tr><td colspan="12" class="table-empty">登録がありません</td></tr>';
    return;
  }
  tbody.innerHTML = payrollState.employees.map(row => {
    const name = row.name ? escapeHtml(row.name) : '';
    const baseLocation = row.base ? escapeHtml(row.base) : '';
    const baseLocationCell = baseLocation || '<span class="muted">--</span>';
    const employment = row.employmentLabel ? escapeHtml(row.employmentLabel) : '';
    const base = formatCurrency(row.baseSalary);
    const hourly = formatCurrency(row.hourlyWage);
    const allowance = formatCurrency(row.personalAllowance);
    const gradeAmountLabel = row.gradeAmount != null ? formatCurrency(row.gradeAmount) : '';
    const gradeNameRaw = row.grade ? row.grade : (row.gradeMasterName || '');
    const gradeName = gradeNameRaw ? escapeHtml(gradeNameRaw) : '';
    const grade = gradeAmountLabel
      ? `${gradeName || ''} (${gradeAmountLabel})`
      : (gradeName || '');
    const municipalTax = formatCurrency(row.municipalTax);
    const withholdingLabel = row.withholding === 'required'
      ? `${escapeHtml(row.withholdingLabel || 'あり')} / ${escapeHtml(row.withholdingCategoryLabel || '')}`
      : '<span class="muted">--</span>';
    const dependentLabel = row.withholding === 'required' ? `<div class="metric-subtext">扶養${row.dependentCount != null ? escapeHtml(String(row.dependentCount)) : '0'}</div>` : '';
    const transportation = formatTransportation(row);
    const commission = row.commissionLabel ? escapeHtml(row.commissionLabel) : '';
    const updated = row.updatedAt ? escapeHtml(new Date(row.updatedAt).toLocaleString('ja-JP')) : '';
    const idAttr = escapeHtml(row.id || '');
    return `
    <tr>
      <td>${name}</td>
      <td>${baseLocationCell}</td>
      <td>${employment}</td>
      <td>${base}</td>
      <td>${hourly}</td>
      <td>${allowance}</td>
      <td>${grade}</td>
      <td>${municipalTax}</td>
      <td><div class="metric-main">${withholdingLabel}</div>${dependentLabel}</td>
      <td>${transportation}</td>
      <td>${commission}</td>
      <td>${updated}</td>
      <td><button type="button" class="btn ghost small" data-action="edit" data-id="${idAttr}">編集</button></td>
    </tr>`;
  }).join('');
}

function setFormLoading(isSaving){
  payrollState.saving = isSaving;
  const form = document.getElementById('employeeForm');
  if (form) {
    Array.from(form.elements).forEach(el => { el.disabled = isSaving && el.id !== 'deleteButton'; });
    document.getElementById('deleteButton').disabled = isSaving;
  }
}

function resetForm(){
  const form = document.getElementById('employeeForm');
  if (form) form.reset();
  document.getElementById('employeeId').value = '';
  payrollState.selectedId = null;
  document.getElementById('formTitle').textContent = '従業員を登録';
  document.getElementById('formMeta').textContent = '';
  document.getElementById('deleteButton').hidden = true;
  document.getElementById('employeeBase').value = '';
  document.getElementById('withholdingCategory').value = 'ko';
  document.getElementById('employmentPeriodType').value = 'monthly';
  updateTransportationAmountState();
  updateGradeHint();
}

function updateTransportationAmountState(){
  const type = document.getElementById('transportationType').value;
  const amountInput = document.getElementById('transportationAmount');
  if (type === 'fixed') {
    amountInput.disabled = false;
    amountInput.placeholder = '固定支給額';
  } else {
    amountInput.disabled = true;
    amountInput.value = '';
    amountInput.placeholder = '固定の場合のみ';
  }
}

function populateForm(employee){
  if (!employee){
    resetForm();
    return;
  }
  document.getElementById('employeeId').value = employee.id || '';
  document.getElementById('employeeName').value = employee.name || '';
  document.getElementById('employeeEmail').value = employee.email || '';
  document.getElementById('employeeBase').value = employee.base || '';
  document.getElementById('employmentType').value = employee.employmentType || 'employee';
  document.getElementById('employeeGrade').value = employee.grade || '';
  document.getElementById('baseSalary').value = employee.baseSalary != null ? employee.baseSalary : '';
  document.getElementById('hourlyWage').value = employee.hourlyWage != null ? employee.hourlyWage : '';
  document.getElementById('personalAllowance').value = employee.personalAllowance != null ? employee.personalAllowance : '';
  document.getElementById('qualificationAllowance').value = employee.qualificationAllowance != null ? employee.qualificationAllowance : '';
  document.getElementById('vehicleAllowance').value = employee.vehicleAllowance != null ? employee.vehicleAllowance : '';
  document.getElementById('housingDeduction').value = employee.housingDeduction != null ? employee.housingDeduction : '';
  document.getElementById('municipalTax').value = employee.municipalTax != null ? employee.municipalTax : '';
  document.getElementById('transportationType').value = employee.transportationType || 'none';
  document.getElementById('transportationAmount').value = employee.transportationAmount != null ? employee.transportationAmount : '';
  document.getElementById('commissionLogic').value = employee.commissionLogic || 'legacy';
  document.getElementById('withholding').value = employee.withholding || 'none';
  document.getElementById('withholdingCategory').value = employee.withholdingCategory || 'ko';
  document.getElementById('employmentPeriodType').value = employee.employmentPeriodType || employee.withholdingPeriodType || 'monthly';
  document.getElementById('dependentCount').value = employee.dependentCount != null ? employee.dependentCount : 0;
  document.getElementById('employeeNote').value = employee.note || '';
  updateTransportationAmountState();
  updateGradeHint();
  payrollState.selectedId = employee.id || null;
  document.getElementById('formTitle').textContent = employee.name ? `${employee.name} さん` : '従業員を編集';
  const updatedText = employee.updatedAt ? `最終更新: ${new Date(employee.updatedAt).toLocaleString('ja-JP')}` : '';
  document.getElementById('formMeta').textContent = updatedText;
  document.getElementById('deleteButton').hidden = !employee.id;
}

function gatherFormData(){
  return {
    id: document.getElementById('employeeId').value,
    name: document.getElementById('employeeName').value,
    email: document.getElementById('employeeEmail').value,
    base: document.getElementById('employeeBase').value,
    employmentType: document.getElementById('employmentType').value,
    grade: document.getElementById('employeeGrade').value,
    baseSalary: document.getElementById('baseSalary').value,
    hourlyWage: document.getElementById('hourlyWage').value,
    personalAllowance: document.getElementById('personalAllowance').value,
    qualificationAllowance: document.getElementById('qualificationAllowance').value,
    vehicleAllowance: document.getElementById('vehicleAllowance').value,
    housingDeduction: document.getElementById('housingDeduction').value,
    municipalTax: document.getElementById('municipalTax').value,
    transportationType: document.getElementById('transportationType').value,
    transportationAmount: document.getElementById('transportationAmount').value,
    commissionLogic: document.getElementById('commissionLogic').value,
    withholding: document.getElementById('withholding').value,
    withholdingCategory: document.getElementById('withholdingCategory').value,
    employmentPeriodType: document.getElementById('employmentPeriodType').value,
    dependentCount: document.getElementById('dependentCount').value,
    note: document.getElementById('employeeNote').value
  };
}

function fetchEmployees(){
  const tbody = document.getElementById('employeeTableBody');
  tbody.innerHTML = '<tr><td colspan="12" class="table-empty">読み込み中…</td></tr>';
  google.script.run
    .withSuccessHandler(res => {
      if (!res || res.ok !== true) {
        showToast(res && res.message ? res.message : '一覧の取得に失敗しました');
        tbody.innerHTML = '<tr><td colspan="12" class="table-empty">エラーが発生しました</td></tr>';
        return;
      }
      payrollState.employees = Array.isArray(res.employees) ? res.employees : [];
      renderTable();
      updateGradeHint();
      renderInsuranceOverrideEmployeeOptions();
      fetchDeductionSummary();
      if (payrollState.selectedId) {
        const current = payrollState.employees.find(emp => emp.id === payrollState.selectedId);
        if (current) populateForm(current); else resetForm();
      }
    })
    .withFailureHandler(err => {
      showToast(err && err.message ? err.message : '一覧の取得に失敗しました');
      tbody.innerHTML = '<tr><td colspan="12" class="table-empty">エラーが発生しました</td></tr>';
    })
    .payrollListEmployees();
}

function handleSave(event){
  event.preventDefault();
  if (payrollState.saving) return;
  setFormLoading(true);
  const payload = gatherFormData();
  google.script.run
    .withSuccessHandler(res => {
      setFormLoading(false);
      if (!res || res.ok !== true) {
        showToast(res && res.message ? res.message : '保存に失敗しました');
        return;
      }
      showToast('保存しました');
      payrollState.selectedId = res.employee && res.employee.id ? res.employee.id : null;
      fetchEmployees();
    })
    .withFailureHandler(err => {
      setFormLoading(false);
      showToast(err && err.message ? err.message : '保存に失敗しました');
    })
    .payrollSaveEmployee(payload);
}

function handleDelete(){
  const id = document.getElementById('employeeId').value;
  if (!id) return;
  if (!confirm('この従業員を削除しますか？')) return;
  setFormLoading(true);
  google.script.run
    .withSuccessHandler(res => {
      setFormLoading(false);
      if (!res || res.ok !== true) {
        showToast(res && res.message ? res.message : '削除に失敗しました');
        return;
      }
      showToast('削除しました');
      resetForm();
      fetchEmployees();
    })
    .withFailureHandler(err => {
      setFormLoading(false);
      showToast(err && err.message ? err.message : '削除に失敗しました');
    })
    .payrollDeleteEmployee({ id });
}

function handleTableClick(event){
  const button = event.target.closest('button[data-action="edit"]');
  if (!button) return;
  const id = button.getAttribute('data-id');
  if (!id) return;
  const employee = payrollState.employees.find(emp => emp.id === id);
  if (employee) {
    populateForm(employee);
    window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
  }
}

function setAttendanceLoading(isLoading){
  payrollState.attendance.loading = isLoading;
  const reloadButton = document.getElementById('attendanceReloadButton');
  const monthInput = document.getElementById('attendanceMonth');
  if (reloadButton) reloadButton.disabled = isLoading;
  if (monthInput) monthInput.disabled = isLoading;
}

function formatAttendanceMetricCell(minutes, durationText){
  const main = formatMinutesClock(minutes);
  const sub = durationText || formatMinutesHuman(minutes);
  return `<div class="metric-main">${main}</div><div class="metric-subtext">${sub}</div>`;
}

function buildAttendanceNotes(entry){
  const notes = [];
  if (!entry.hasAttendance) notes.push('記録なし');
  if (entry.autoPaidLeaveMinutes > 0) {
    const days = entry.autoPaidLeaveDays || 0;
    notes.push(`不足 ${formatMinutesHuman(entry.autoPaidLeaveMinutes)}（${days}日）を自動有給換算`);
  }
  if (entry.recordedPaidLeaveDays > 0) {
    notes.push(`申請有給 ${entry.recordedPaidLeaveDays}日`);
  }
  if (entry.scheduledPerDayMinutes) {
    notes.push(`所定 ${formatMinutesHuman(entry.scheduledPerDayMinutes)}/日`);
  }
  return notes.length ? notes.join('<br>') : '--';
}

function renderAttendanceMeta(){
  const meta = document.getElementById('attendanceSummaryMeta');
  if (!meta) return;
  const summary = payrollState.attendance.summary;
  if (!summary || !summary.month) {
    meta.textContent = '勤怠データを取得していません。';
    return;
  }
  const totals = summary.totals || {};
  const workText = totals.workText || formatMinutesClock(totals.workMinutes);
  const breakText = totals.breakText || formatMinutesClock(totals.breakMinutes);
  meta.textContent = `${summary.month.label || summary.month.key || ''} / 総勤務 ${workText || '--'} / 休憩 ${breakText || '--'}`;
}

function renderAttendanceTable(){
  const tbody = document.getElementById('attendanceTableBody');
  if (!tbody) return;
  const summary = payrollState.attendance.summary;
  if (!summary || !Array.isArray(summary.employees) || summary.employees.length === 0){
    tbody.innerHTML = '<tr><td colspan="7" class="table-empty">勤怠データがありません</td></tr>';
    return;
  }
  tbody.innerHTML = summary.employees.map(entry => {
    const name = entry.employeeName ? escapeHtml(entry.employeeName) : '--';
    const employment = entry.employmentLabel
      ? `<div class="metric-subtext">${escapeHtml(entry.employmentLabel)}</div>`
      : '';
    return `
      <tr>
        <td><div class="metric-main">${name}</div>${employment}</td>
        <td>${entry.workingDays || 0}日</td>
        <td>${formatAttendanceMetricCell(entry.workMinutes, entry.workDurationText)}</td>
        <td>${formatAttendanceMetricCell(entry.breakMinutes, formatMinutesHuman(entry.breakMinutes))}</td>
        <td>${formatAttendanceMetricCell(entry.overtimeMinutes, formatMinutesHuman(entry.overtimeMinutes))}</td>
        <td>${formatAttendanceMetricCell(entry.autoPaidLeaveMinutes, entry.autoPaidLeaveDurationText)}</td>
        <td>${buildAttendanceNotes(entry)}</td>
      </tr>`;
  }).join('');
}

function renderAttendanceUnassigned(){
  const box = document.getElementById('attendanceUnassigned');
  if (!box) return;
  const summary = payrollState.attendance.summary;
  if (!summary || !Array.isArray(summary.unmatchedStaff) || summary.unmatchedStaff.length === 0){
    box.textContent = '';
    return;
  }
  const list = summary.unmatchedStaff.map(item => {
    const label = item.staffName || item.email || 'スタッフ';
    const work = item.workText || formatMinutesClock(item.workMinutes);
    return `${label}（${work}）`;
  });
  box.textContent = `給与マスタ未登録の勤怠: ${list.join('、')}`;
}

function setDeductionLoading(isLoading){
  payrollState.deductions.loading = isLoading;
  const reloadButton = document.getElementById('deductionReloadButton');
  if (reloadButton) reloadButton.disabled = isLoading;
}

function renderDeductionMeta(){
  const meta = document.getElementById('deductionMeta');
  if (!meta) return;
  const summary = payrollState.deductions.summary;
  if (!summary) {
    meta.textContent = '控除データがまだありません。';
    return;
  }
  const count = Array.isArray(summary.employees) ? summary.employees.length : 0;
  const total = summary.totals && summary.totals.total != null ? formatCurrency(summary.totals.total) : '¥0';
  const updatedText = summary.generatedAt ? new Date(summary.generatedAt).toLocaleString('ja-JP') : '';
  meta.textContent = `${count}名 / 控除合計 ${total}${updatedText ? ` / 更新: ${updatedText}` : ''}`;
}

function formatDeductionBreakdown(entry){
  if (!entry || !Array.isArray(entry.components) || entry.components.length === 0) {
    return '--';
  }
  return entry.components.map(component => {
    const amount = formatCurrency(component.amount);
    const rateText = component.rate != null ? `（${(component.rate * 100).toFixed(2)}%）` : '';
    const label = escapeHtml(component.label || '控除');
    return `<div>${label}${rateText}: ${amount}</div>`;
  }).join('');
}

function renderDeductionTable(){
  const tbody = document.getElementById('deductionTableBody');
  if (!tbody) return;
  const summary = payrollState.deductions.summary;
  if (!summary || !Array.isArray(summary.employees) || summary.employees.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" class="table-empty">控除対象の従業員がいません</td></tr>';
    return;
  }
  tbody.innerHTML = summary.employees.map(entry => {
    const employment = entry.employmentLabel
      ? `<div class="metric-subtext">${escapeHtml(entry.employmentLabel)}</div>`
      : '';
    const employeeName = entry.employeeName ? escapeHtml(entry.employeeName) : '--';
    return `
      <tr>
        <td><div class="metric-main">${employeeName}</div>${employment}</td>
        <td class="text-right">${formatCurrency(entry.taxableCompensation)}</td>
        <td class="text-right">${formatCurrency(entry.withholdingAmount)}</td>
        <td class="text-right">${formatCurrency(entry.housingDeduction)}</td>
        <td class="text-right">${formatCurrency(entry.municipalTax)}</td>
        <td class="text-right">${formatCurrency(entry.totalAmount)}</td>
        <td>${formatDeductionBreakdown(entry)}</td>
      </tr>`;
  }).join('');
}

function renderDeductionSummary(){
  renderDeductionMeta();
  renderDeductionTable();
}

function fetchDeductionSummary(){
  const tbody = document.getElementById('deductionTableBody');
  if (tbody) {
    tbody.innerHTML = '<tr><td colspan="7" class="table-empty">読み込み中…</td></tr>';
  }
  setDeductionLoading(true);
  google.script.run
    .withSuccessHandler(res => {
      setDeductionLoading(false);
      if (!res || res.ok !== true) {
        showToast(res && res.message ? res.message : '控除データの取得に失敗しました');
        payrollState.deductions.summary = null;
        renderDeductionSummary();
        return;
      }
      payrollState.deductions.summary = res;
      renderDeductionSummary();
    })
    .withFailureHandler(err => {
      setDeductionLoading(false);
      showToast(err && err.message ? err.message : '控除データの取得に失敗しました');
      payrollState.deductions.summary = null;
      renderDeductionSummary();
    })
    .payrollListDeductionSummary();
}

function renderAttendanceSummary(){
  renderAttendanceMeta();
  renderAttendanceTable();
  renderAttendanceUnassigned();
}

function fetchAttendanceSummary(){
  const tbody = document.getElementById('attendanceTableBody');
  if (tbody) {
    tbody.innerHTML = '<tr><td colspan="7" class="table-empty">読み込み中…</td></tr>';
  }
  setAttendanceLoading(true);
  const payload = {};
  if (payrollState.attendance.month) {
    payload.month = payrollState.attendance.month;
  }
  google.script.run
    .withSuccessHandler(res => {
      setAttendanceLoading(false);
      if (!res || res.ok !== true) {
        showToast(res && res.message ? res.message : '勤怠データの取得に失敗しました');
        payrollState.attendance.summary = null;
        renderAttendanceSummary();
        return;
      }
      payrollState.attendance.summary = res;
      renderAttendanceSummary();
    })
    .withFailureHandler(err => {
      setAttendanceLoading(false);
      showToast(err && err.message ? err.message : '勤怠データの取得に失敗しました');
      payrollState.attendance.summary = null;
      renderAttendanceSummary();
    })
    .payrollListAttendanceSummary(payload);
}

function setBulkFormLoading(isLoading){
  payrollState.bulk.loading = isLoading;
  const button = document.getElementById('bulkPayslipButton');
  const monthInput = document.getElementById('bulkPayslipMonth');
  if (button) button.disabled = isLoading;
  if (monthInput) monthInput.disabled = isLoading;
}

function renderBulkStatus(message){
  const status = document.getElementById('bulkPayslipStatus');
  if (!status) return;
  status.textContent = message || '';
}

function handleBulkPayslipGenerate(){
  if (payrollState.bulk.loading) return;
  const monthInput = document.getElementById('bulkPayslipMonth');
  const monthValue = monthInput ? monthInput.value : '';
  if (!monthValue) {
    showToast('対象月を選択してください');
    return;
  }
  payrollState.bulk.month = monthValue;
  setBulkFormLoading(true);
  renderBulkStatus('生成中です…');
  google.script.run
    .withSuccessHandler(res => {
      setBulkFormLoading(false);
      if (!res || res.ok !== true) {
        const message = res && res.message ? res.message : '一括生成に失敗しました';
        showToast(message);
        renderBulkStatus(message);
        return;
      }
      const summary = res.summary || {};
      const label = res.month && (res.month.label || res.month.key) ? (res.month.label || res.month.key) : '';
      let message = `対象 ${summary.total || 0}名 / 成功 ${summary.success || 0} / 失敗 ${summary.failed || 0}`;
      if (label) {
        message = `${label}：` + message;
      }
      if (Array.isArray(res.errors) && res.errors.length) {
        const details = res.errors.slice(0, 3).map(err => {
          const name = err && (err.employeeName || err.employeeId || '');
          const reason = err && err.message ? err.message : '失敗';
          return `${name}: ${reason}`;
        }).join(' / ');
        if (details) {
          message += ` / 失敗詳細 ${details}${res.errors.length > 3 ? ' …' : ''}`;
        }
      }
      renderBulkStatus(message);
      showToast('給与明細を生成しました');
    })
    .withFailureHandler(err => {
      setBulkFormLoading(false);
      const message = err && err.message ? err.message : '一括生成に失敗しました';
      showToast(message);
      renderBulkStatus(message);
    })
    .payrollBulkGeneratePayslips({ month: monthValue });
}

function init(){
  renderOptions(document.getElementById('employmentType'), EMPLOYMENT_OPTIONS);
  renderOptions(document.getElementById('transportationType'), TRANSPORT_OPTIONS);
  renderOptions(document.getElementById('commissionLogic'), COMMISSION_OPTIONS);
  renderOptions(document.getElementById('withholding'), WITHHOLDING_OPTIONS);
  renderOptions(document.getElementById('withholdingCategory'), WITHHOLDING_CATEGORY_OPTIONS);
  renderOptions(document.getElementById('employmentPeriodType'), WITHHOLDING_PERIOD_OPTIONS);
  const bulkMonthInput = document.getElementById('bulkPayslipMonth');
  if (bulkMonthInput) {
    bulkMonthInput.value = payrollState.bulk.month;
  }
  const bulkButton = document.getElementById('bulkPayslipButton');
  if (bulkButton) {
    bulkButton.addEventListener('click', handleBulkPayslipGenerate);
  }
  document.getElementById('employeeForm').addEventListener('submit', handleSave);
  document.getElementById('employeeTableBody').addEventListener('click', handleTableClick);
  document.getElementById('newButton').addEventListener('click', resetForm);
  document.getElementById('formResetButton').addEventListener('click', resetForm);
  document.getElementById('deleteButton').addEventListener('click', handleDelete);
  document.getElementById('reloadButton').addEventListener('click', fetchEmployees);
  document.getElementById('transportationType').addEventListener('change', updateTransportationAmountState);
  document.getElementById('employeeGrade').addEventListener('input', updateGradeHint);
  document.getElementById('gradeForm').addEventListener('submit', handleGradeSave);
  document.getElementById('gradeFormResetButton').addEventListener('click', resetGradeForm);
  document.getElementById('gradeDeleteButton').addEventListener('click', handleGradeDelete);
  document.getElementById('gradeTableBody').addEventListener('click', handleGradeTableClick);
  document.getElementById('gradeReloadButton').addEventListener('click', fetchGrades);
  document.getElementById('gradeNewButton').addEventListener('click', () => {
    resetGradeForm();
    const nameInput = document.getElementById('gradeName');
    if (nameInput) nameInput.focus();
  });
  const insuranceRateForm = document.getElementById('insuranceRateForm');
  if (insuranceRateForm) {
    insuranceRateForm.addEventListener('submit', handleInsuranceRateSave);
  }
  const insuranceRateReset = document.getElementById('insuranceRateReset');
  if (insuranceRateReset) {
    insuranceRateReset.addEventListener('click', handleInsuranceRateReset);
  }
  const insuranceStandardForm = document.getElementById('insuranceStandardForm');
  if (insuranceStandardForm) {
    insuranceStandardForm.addEventListener('submit', handleInsuranceStandardSave);
  }
  document.getElementById('insuranceStandardReset').addEventListener('click', resetInsuranceStandardForm);
  document.getElementById('insuranceStandardDelete').addEventListener('click', handleInsuranceStandardDelete);
  document.getElementById('insuranceStandardTableBody').addEventListener('click', handleInsuranceStandardTableClick);
  document.getElementById('insuranceStandardReload').addEventListener('click', fetchSocialInsuranceSettings);
  document.getElementById('insuranceStandardNew').addEventListener('click', () => {
    resetInsuranceStandardForm();
    const input = document.getElementById('insuranceStandardGrade');
    if (input) input.focus();
  });
  const attendanceMonthInput = document.getElementById('attendanceMonth');
  if (attendanceMonthInput) {
    attendanceMonthInput.value = payrollState.attendance.month || getCurrentMonthKey();
    attendanceMonthInput.addEventListener('change', event => {
      payrollState.attendance.month = event.target.value;
      fetchAttendanceSummary();
    });
  }
  const attendanceReloadButton = document.getElementById('attendanceReloadButton');
  if (attendanceReloadButton) {
    attendanceReloadButton.addEventListener('click', fetchAttendanceSummary);
  }
  const deductionReloadButton = document.getElementById('deductionReloadButton');
  if (deductionReloadButton) {
    deductionReloadButton.addEventListener('click', fetchDeductionSummary);
  }
  const insuranceMonthInput = document.getElementById('insuranceMonthInput');
  if (insuranceMonthInput) {
    insuranceMonthInput.value = payrollState.socialInsurance.month || getCurrentMonthKey();
    insuranceMonthInput.addEventListener('change', event => {
      payrollState.socialInsurance.month = event.target.value;
      fetchInsuranceSummary();
    });
  }
  const insuranceReloadButton = document.getElementById('insuranceReloadButton');
  if (insuranceReloadButton) {
    insuranceReloadButton.addEventListener('click', fetchInsuranceSummary);
  }
  const insuranceSummaryTableBody = document.getElementById('insuranceSummaryTableBody');
  if (insuranceSummaryTableBody) {
    insuranceSummaryTableBody.addEventListener('click', handleInsuranceSummaryTableClick);
  }
  const insuranceOverrideForm = document.getElementById('insuranceOverrideForm');
  if (insuranceOverrideForm) {
    insuranceOverrideForm.addEventListener('submit', handleInsuranceOverrideSave);
  }
  document.getElementById('insuranceOverrideReset').addEventListener('click', resetInsuranceOverrideForm);
  document.getElementById('insuranceOverrideDelete').addEventListener('click', handleInsuranceOverrideDelete);
  const incomeTaxSaveButton = document.getElementById('incomeTaxSaveButton');
  if (incomeTaxSaveButton) {
    incomeTaxSaveButton.addEventListener('click', handleIncomeTaxSave);
  }
  const incomeTaxReloadButton = document.getElementById('incomeTaxReloadButton');
  if (incomeTaxReloadButton) {
    incomeTaxReloadButton.addEventListener('click', handleIncomeTaxReload);
  }
  const incomeTaxResetButton = document.getElementById('incomeTaxResetButton');
  if (incomeTaxResetButton) {
    incomeTaxResetButton.addEventListener('click', resetIncomeTaxForm);
  }
  updateTransportationAmountState();
  updateGradeHint();
  renderInsuranceRateForm();
  resetInsuranceStandardForm();
  resetInsuranceOverrideForm();
  renderIncomeTaxSettings();
  fetchGrades();
  fetchEmployees();
  fetchAttendanceSummary();
  fetchSocialInsuranceSettings();
  fetchIncomeTaxSettings();
  fetchInsuranceSummary();
}

init();
</script>
</body>
</html>
